# Nombre de archivo: 2025-10-03.md
# Ubicación de archivo: docs/PR/2025-10-03.md
# Descripción: PR diario con análisis de PRs previos y acciones de alineación (03-10-2025)

## 1. Resumen de cambios (hoy)

Hoy no se incorporó código nuevo funcional; se realizó un análisis de consistencia entre los PRs anteriores (17, 18, 26 y 29 de septiembre) y el estado real del repositorio. Se genera este PR para documentar:
- Divergencias detectadas en la documentación histórica.
- Riesgos y brechas (seguridad, mantenibilidad, calidad) en los módulos recientes (`office_service`, endpoint `/reports/repetitividad`, hashing centralizado).
- Acciones propuestas y backlog priorizado.

## 2. Contexto

Proyecto: LAS-FOCAS (microservicios Debian 12.4). Último PR con cambios de código: 2025-09-29 (introducción de `office_service`, endpoint `/reports/repetitividad`, worker de repetitividad, centralización de hashing y pruebas de integridad de plantillas). No existía PR diario desde entonces pese a incorporar piezas relevantes.

## 3. Observaciones y discrepancias detectadas

1. PR 2025-09-29 afirma en el punto 2: *"No se modificó código de ejecución ni servicios"* pero en el mismo PR y en el repositorio se agregaron múltiples servicios/archivos nuevos (microservicio `office_service`, endpoint `/reports/repetitividad`, `core/password.py`, worker `repetitividad_worker`, nuevos tests). Es una inconsistencia a corregir en auditorías futuras (no se edita el PR retroactivamente para preservar historial, se deja constancia aquí).
2. Versiones de FastAPI heterogéneas: raíz (`fastapi==0.112.2`) vs `office_service` (`fastapi==0.111.1`). Riesgo de divergencia de comportamiento / advertencias futuras. Recomendado unificar (acción planificada).
3. El endpoint `/reports/repetitividad` no impone límite de tamaño ni valida MIME más allá de extensión `.xlsx`. Riesgo de consumo de memoria / ataque por archivo malicioso. Falta validación de tamaño y sanitización de nombre (aunque se usa `NamedTemporaryFile`, se debería registrar tamaño y rechazar > umbral configurable).
4. Pruebas existentes cubren generación DOCX pero no la rama `incluir_pdf=True`. Actualmente PDF depende de `SOFFICE_BIN`; falta test condicionado o mock.
5. `office_service` expone `/convert` sin implementación real (placeholder) y sin límites de tamaño / formato aceptado. Debe estar protegido hasta tener conversión robusta (flag de FEATURE o return 503 mientras `enable_uno` false).
6. No hay documentación específica para el endpoint `/reports/repetitividad` en `docs/api.md` ni referencia en `docs/web.md` para su eventual consumo desde UI Web.
7. `requirements.txt` del root incluye librerías no usadas todavía por todos los servicios (ej. `pandas`, `python-docx`) que incrementan superficie de ataque si se instalan en imágenes que no las requieren (optimización futura: requirements por servicio o multi-stage). 
8. Falta decisión formal en `docs/decisiones.md` sobre: a) Estrategia de verificación de integridad de plantillas vía hash; b) Criterio de centralización de hashing y desuso definitivo de Passlib.
9. `core/password.py` implementa truncado lógico y `needs_rehash` pero no hay test directo de coste / rehash; se apoya en tests de login. Se recomienda tests unitarios específicos.
10. Worker `repetitividad_worker` en modo loop infinito sin mecanismo de shutdown elegante / healthcheck. Plan: añadir señal + latch o framework de tareas cuando se introduzca cola.
11. `pytest.ini` ya excluye `Legacy/`, correcto; se sugiere añadir exclusión explícita de cualquier carpeta temporal (`.tmp`, `Reports/` generados) si se crean fixtures nuevos.
12. Faltan métricas o, al menos, contador simple de informes generados (KPI básico) en `/reports`.
13. Seguridad: No hay autenticación/ autorización sobre `/reports/repetitividad` (abierto). Para entorno interno puede aceptarse temporalmente, pero debe agregarse token interno o behind gateway antes de exponerlo externamente.

## 4. Objetivo del día

Documentar el gap, crear backlog accionable y dejar las bases para el próximo ciclo de hardening / refactor sin introducir cambios funcionales hoy.

## 5. Tareas ejecutadas hoy

- [x] Revisión de PRs históricos y contraste con árbol actual del repo.
- [x] Detección de versiones divergentes y cobertura de pruebas insuficiente.
- [x] Elaboración de backlog priorizado (ver sección 7).
- [x] Actualización de `docs/Mate_y_Ruta.md` con fecha y tareas.

## 6. Criterios de aceptación (para considerar este PR completo)

- Archivo `docs/PR/2025-10-03.md` con encabezado válido y formato alineado a `AGENTS.md` (cumplido).
- Lista de riesgos priorizados con acciones propuestas (incluida en sección 7).
- Sin introducción de código nuevo que pueda romper la suite existente (no se modificó lógica). 

## 7. Backlog priorizado / Acciones propuestas

Prioridad Alta (Próxima iteración):
1. Unificar versiones de FastAPI y pydantic entre servicios (`office_service` y raíz) y regenerar lockfiles / recalcular imagen. (# TODO)
2. Añadir validaciones de tamaño (ej. 5–10MB configurable) y content-type en `/reports/repetitividad` + logging de métricas (contador). (# TODO)
3. Documento de decisiones: agregar entrada sobre integridad de plantillas (hashes) y política de actualización. (# TODO)
4. Test para `incluir_pdf=True` mockeando `report.maybe_export_pdf` (sin requerir LibreOffice real). (# TODO)
5. Endurecer `/convert` (devolver 503 si FEATURE flag no activa conversión real). (# TODO)

Prioridad Media:
6. Tests unitarios de `core/password.py` (hash/verify/needs_rehash edge cases). (# TODO)
7. Documentar `/reports/repetitividad` en `docs/api.md` y referenciarlo desde `docs/web.md`. (# TODO)
8. Añadir autenticación simple (API key interna) para `/reports/*`. (# TODO)
9. Señales y graceful shutdown para `repetitividad_worker` y health endpoint ligero. (# TODO)
10. Separar requirements por servicio (optimizar imágenes) o multi-stage build. (# TODO)

Prioridad Baja:
11. Métricas Prometheus (counter `reports_generated_total`, histogram de duración). (# TODO)
12. Pipeline de SCA (dependency audit) recurrente automatizado. (# TODO)
13. Revisión de política de logs (redactar PII si se captura texto libre). (# TODO)

## 8. Seguridad y datos

No se introducen cambios de código hoy. Riesgos identificados se concentran en: falta de límites de carga, endpoints sin auth, dependencias duplicadas. Se documentan para su mitigación. No se detectaron secretos en texto plano en los archivos revisados.

## 9. Compatibilidad y migraciones

Sin migraciones pendientes hoy. Próxima unificación de versiones no debería requerir migraciones de DB, pero debe validarse compatibilidad de los modelos pydantic (breaking menor improbable entre 0.111.x y 0.112.x de FastAPI + pydantic 2.8 vs 2.9).

## 10. Evidencia de validación manual

Revisión visual de:
- `deploy/compose.yml` (servicios: postgres, api, web, nlp_intent, office, repetitividad_worker, bot, pgadmin).
- `core/password.py` (hashing nativo ok, logging WARN en truncado >72 bytes).
- `api/api_app/routes/reports.py` (falta límites de tamaño -> backlog #2).
- Tests presentes para integridad de plantillas, office health, repetitividad DOCX.

## 11. Próximos pasos inmediatos

1. Implementar backlog Alta prioridad (ideal en PR 2025-10-04 o próximo ciclo).
2. Añadir nueva entrada en `docs/decisiones.md` (integridad plantillas + fastapi version unify) al aplicar cambios.
3. Preparar script utilitario para calcular nuevo hash de plantillas al actualizarlas (evitar ediciones manuales en tests).

## 12. Checklist de validación final

- [x] Encabezado 3 líneas.
- [x] Análisis de divergencias.
- [x] Backlog priorizado con # TODO.
- [x] Sin cambios de código funcional.
- [x] Documentos de planeación actualizados.

---

Notas: Este PR no corrige retroactivamente descripciones pasadas para mantener trazabilidad histórica; cualquier auditoría debe considerar esta rectificación documental.
