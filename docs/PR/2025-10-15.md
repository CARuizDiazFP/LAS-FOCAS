# Nombre de archivo: 2025-10-15.md
# Ubicación de archivo: docs/PR/2025-10-15.md
# Descripción: Nota de PR diario del 2025-10-15 (ingesta híbrida, reportes DB/Excel, Alembic en Start y fixes de docs)

# PR — 2025-10-15

## Resumen de cambios
- Ingesta híbrida Excel→DB con parser tolerante (Unidecode + fallback) y upsert en PostgreSQL usando COALESCE para no perder datos existentes.
- Endpoints API: alias `POST /import/reclamos`, `POST /ingest/reclamos`, `POST /reports/repetitividad` (Excel o DB) y `GET /reports/repetitividad` (métricas JSON). Nuevo `GET /health/version`.
- Reportes: generación de mapa con fallback HTML cuando `folium` no está instalado (se mantienen headers X-Map-* y ZIP de adjuntos).
- Start: ejecuta Alembic dentro de `api` usando `ALEMBIC_URL` derivado de `.env`; migraciones aplicadas hasta `20251014_01_reclamos`.
- Documentación: README (Prueba rápida, puertos), `docs/api.md` (salud/versión, ingest, modo DB y headers), y `docs/Mate_y_Ruta.md` actualizados.
- Web UI: formulario de Repetitividad permite alternar GEO/DB, muestra múltiples mapas y ajusta flujo a la nueva respuesta del backend.
- Pruebas: suite web actualizada (`test_web_repetitividad_flow.py`) cubre flags `with_geo`/`use_db` y render multi-mapa.

## Contexto y alcance
- Objetivo: permitir que los Excel subidos enriquezcan la DB sin duplicar reclamos, y que Repetitividad pueda generarse desde DB o Excel.
- Afecta servicios `api` (rutas health/ingest/reports), módulo `modules/informes_repetitividad` (mapa y servicio), parser de ingest (`core/parsers`) y Start/Alembic.

## Cambios realizados
- API
  - `api/api_app/routes/health.py`: agregado `GET /health/version`.
  - `api/api_app/routes/ingest.py`: endpoint `POST /ingest/reclamos` y alias `POST /import/reclamos`.
  - `api/api_app/routes/reports.py`: modo DB para `POST /reports/repetitividad`, zip con PDF/mapa, y `GET /reports/repetitividad` (métricas).
- Core/DB
  - `core/parsers/reclamos_excel.py`: normalización con Unidecode (fallback a unicodedata), limpieza de fechas, horas, y GEO con validaciones de rango.
  - `core/services/repetitividad.py`: upsert con `ON CONFLICT DO UPDATE` y `COALESCE(excluded.col, table.col)` para todas las columnas salvo PK; helper de métricas por período.
  - `db/models/reclamo.py` y migración `db/alembic/versions/20251014_01_reclamos.py` ya vigentes.
- Informes
  - `modules/informes_repetitividad/report.py`: fallback de mapa HTML si falta `folium`.
  - `modules/informes_repetitividad/service.py`: config dinámica por request (`ReportConfig.from_settings`).
- Web
  - `web/web_app/main.py`: endpoint `/api/flows/repetitividad` acepta `with_geo`/`use_db`, consume flujo DB, expone `maps` múltiple y métricas de origen.
  - `web/templates/panel.html`: agrega toggles “Incluir mapas GEO” y “Usar DB”, contenedor para pestañas de mapas.
  - `web/static/panel.js`: maneja nuevo formulario (FormData con flags), controla dropzone cuando se usa DB y renderiza lista de mapas.
  - `web/static/styles.css`: estilos para map-tabs y estado disabled del dropzone.
- Tests
  - `tests/test_web_repetitividad_flow.py`: escenarios para Excel/DB, GEO opcional y respuesta multi-mapa.
- Dependencias
  - `requirements.txt` y `api/requirements.txt`: agregado `Unidecode==1.3.8`.
- Docs
  - `README.md`: corrige puerto `/db-check` (8001) y agrega “Prueba rápida”.
  - `docs/api.md`: corrige code fences; amplía salud/versión, ingest y modo DB.
  - `docs/Mate_y_Ruta.md`: estado actualizado al 2025-10-15.

## Tareas realizadas y pendientes
- Realizado
  - Ingesta híbrida con upsert seguro (deduplicación por `numero_reclamo`).
  - Reporte Repetitividad desde DB o Excel, con ZIP opcional (PDF/mapa) y headers de control.
  - Alembic integrado en Start (migraciones automáticas).
  - Web panel actualizado: alterna fuentes Excel/DB, activa GEO opcional y muestra múltiples mapas embebidos.
  - Suite de pruebas en PASS (59); fallback de mapa para entornos sin `folium`.
  - Pruebas del panel web extendidas para flags `with_geo`/`use_db` y manejo de múltiples mapas.
  - API `/reports/repetitividad` validada con generación de ZIP+mapas (`test_reports_repetitividad_api.py`).
- Pendiente
  - Documentar en `docs/web.md` headers `X-PDF-*` y `X-Map-*`, y ejemplos de descarga ZIP.
  - E2E opcionales para flujo ingest→DB→reporte (gated por ENABLE_DB_TESTS).
  - Auth/API key para `/reports/*` y límites de tamaño de upload.

## Criterios de aceptación
- `POST /ingest/reclamos` (o `/import/reclamos`) devuelve JSON con `inserted`, `updated`, `rows_ok/bad` y `% GEO`.
- `POST /reports/repetitividad`:
  - Con archivo: DOCX o ZIP (si `incluir_pdf=true`); headers `X-PDF-Requested/Generated`, `X-Map-Generated/Filename`.
  - Sin archivo: requiere `periodo_mes/anio`, usa DB y devuelve DOCX/ZIP; mismo set de headers + `X-From: db`.
  - Respuestas incluyen `maps[]` (lista de rutas) y `map` principal para compatibilidad con UI.
  - Web panel refleja `with_geo`/`use_db` y muestra pestañas de mapas sin recargar la página.
- `GET /reports/repetitividad?periodo_mes=&periodo_anio=` devuelve métricas JSON del período.
- `GET /health` y `GET /health/version` responden OK; `/db-check` confirma DB y versión de servidor.

## Impacto en seguridad y datos
- DB: upsert evita duplicados y protege datos existentes con COALESCE.
- Sin exposición de nuevos puertos; alias `/import/reclamos` mantiene el mismo scope que `/ingest/reclamos`.
- Sin logs de datos sensibles adicionales; se mantiene logging estructurado.

## Compatibilidad y migraciones
- Requiere migraciones aplicadas (`Start` las ejecuta en arranque). Tabla `app.reclamos` con PK `numero_reclamo` e índices por fecha/cliente/línea.
- No hay cambios de contrato que rompan clientes: se agrega alias `/import/reclamos`.

## Evidencia de validación manual
- `curl` a `/health`, `/db-check`, `/health/version` → OK.
- `pytest` → PASS 59/59.
- Generación de informe con y sin PDF/mapa (tests `test_reports_repetitividad_api.py`).

## Próximos pasos
- Documentar headers y descargas ZIP en `docs/web.md`.
- Tests E2E ingest→DB→reporte (habilitables en CI con DB disponible).
- Agregar protección (API key) y límites de archivo a endpoints `/reports/*`.
