# Nombre de archivo: 2025-12-30.md
# Ubicación de archivo: docs/PR/2025-12-30.md
# Descripción: PR diario - Endurecimiento de exposición web y firewall

# PR Diario - 2025-12-30

## 1. Contexto
- Proyecto LAS-FOCAS en VM Debian 12.4 con stack dockerizado (`deploy/compose.yml`).
- Servicio `lasfocas-web` publicado en 8080; requerimiento de limitar a red LAN y aplicar filtros de ingreso.
- rp_filter estaba relajado (2) en `all` y `ens224`; DOCKER-USER sin reglas explícitas y sin persistencia.

## 2. Observaciones y errores
- El servicio web se exponía en `0.0.0.0:8080`, aceptando cualquier origen.
- No existían reglas en `DOCKER-USER` para acotar subredes ni `DROP` por defecto en 8080.
- Falta de automatización para mantener SNAT único `172.18.0.0/16 -> ens224` y para devolver `rp_filter` a modo estricto fuera de `ens224`.
- Ausencia de guía paso a paso para endurecer firewall y persistir reglas.
- Imágenes Docker con dependencias nativas geoespaciales innecesarias (API, Web, Bot) incrementando tamaño y tiempo de build.

## 3. Objetivo
Limitar la exposición del servicio web a la IP LAN requerida, agregar un procedimiento idempotente para filtrar subredes y `rp_filter`, y documentar el hardening junto con próximos pasos operativos. Reducir el peso de imágenes Docker eliminando dependencias nativas no requeridas y usando wheels binarias.

## 4. Tareas o configuraciones
1. Restringir la publicación de `lasfocas-web` a `192.168.241.28:8080` en `deploy/compose.yml`.
2. Crear script idempotente `scripts/firewall_hardening.sh` para configurar INPUT/DOCKER-USER, SNAT y `rp_filter`, con opción de persistencia (`PERSIST_RULES=true`).
3. Documentar el hardening en `docs/Seguridad.md` (instrucciones de ejecución, persistencia y verificaciones).
4. Actualizar `docs/Mate_y_Ruta.md` con estado, tarea prioritaria de firewall y notas de operación.
5. Registrar esta nota diaria.
6. Optimizar Dockerfiles (API, Web, Bot, NLP Intent, Repetitividad worker) removiendo paquetes nativos innecesarios y forzando instalaciones binarias sin caché.
7. Modelar infraestructura base (cámaras, cables, empalmes, servicios, ingresos) para soportar baneo/desbaneo e importes de tracking.
8. Generar migración Alembic para las tablas de infraestructura y parser inicial del tracking FO.
9. Implementar servicio de sincronización con Google Sheets y endpoint `/sync/camaras`.

## 5. Criterios de aceptación
- `lasfocas-web` sólo escucha en `192.168.241.28:8080` desde docker-compose.
- Script aplica allowlist de subredes al puerto 8080 en `INPUT/DOCKER-USER`, añade `DROP` posterior y mantiene SNAT único `172.18.0.0/16 -> ens224`.
- `rp_filter` queda en `1` para interfaces generales y `2` para `ens224` (configurable), con persistencia en `/etc/sysctl.d/99-lasfocas.conf`.
- Documentación refleja pasos de ejecución, persistencia y chequeos (`iptables-save`, `sysctl`, `ss -tulpen`).

## 6. Entregables
- `deploy/compose.yml`
- `scripts/firewall_hardening.sh`
- `docs/Seguridad.md`
- `docs/Mate_y_Ruta.md`
- `docs/PR/2025-12-30.md`
- `api/Dockerfile`
- `web/Dockerfile`
- `deploy/docker/bot.Dockerfile`
- `deploy/docker/nlp_intent.Dockerfile`
- `deploy/docker/repetitividad_worker.Dockerfile`
- `db/base.py`
- `db/models/infra.py`
- `db/alembic/versions/20251230_01_infra.py`
- `core/parsers/tracking_parser.py`
- `core/services/infra_sync.py`
- `core/config.py`
- `db/session.py`
- `api/api_app/routes/infra.py`
- `api/app/main.py`
- `deploy/env.sample`
- `docs/api.md`
- Plan de endpoints/repos para baneo/desbaneo e ingresos/egresos basado en nuevos modelos
- `docs/db.md`

## 7. Checklist de validación
- [ ] Ejecutar `WEB_ALLOWED_SUBNETS="190.12.96.0/24" PERSIST_RULES=true bash scripts/firewall_hardening.sh` en la VM y verificar `iptables -S INPUT` / `iptables -S DOCKER-USER`.
- [ ] Verificar `sysctl net.ipv4.conf.all.rp_filter net.ipv4.conf.ens224.rp_filter` tras el script.
- [ ] Confirmar que `ss -tulpen` sólo muestre los servicios necesarios y SSH restringido a la red de gestión.
- [ ] Validar que Postgres ya no expone `5432` al host (`ss -tulpen | grep 5432` debe mostrar sólo sockets internos/docker sin 0.0.0.0`).
- [ ] Construir imágenes Docker (`api`, `web`, `bot`, `nlp_intent`, `repetitividad_worker`) y confirmar que no se requieren toolchains ni librerías nativas adicionales.

## 8. Impacto en seguridad y datos
- Reducción de superficie de ataque del panel web (allowlist de subredes + DROP por defecto).
- rp_filter más estricto en interfaces no críticas; mantenimiento del modo 2 sólo en `ens224`.
- Sin cambios en datos ni esquemas; requiere aplicar reglas en la VM para que surtan efecto.

## 9. Compatibilidad y migraciones
- Sin cambios de esquema ni dependencias de aplicación.
- Requiere tener `iptables` y, para persistencia opcional, `netfilter-persistent`/`iptables-persistent` instalados en la VM.
