# Nombre de archivo: 2025-11-06.md
# Ubicación de archivo: docs/PR/2025-11-06.md
# Descripción: Registro diario de cambios y validaciones del proyecto LAS-FOCAS

## 1. Resumen de cambios
- Ajuste en el endpoint web de SLA para aceptar envíos con uno o dos archivos y normalizar el cierre de adjuntos, corrigiendo el error de validación cuando el navegador envía un único `UploadFile`.
- Unificación de la ruta de logs en `Logs/` usando la nueva configuración centralizada para que el servicio web siempre escriba en `/home/focal/proyectos/LAS-FOCAS/Logs` (o `LOGS_DIR`).

## 2. Contexto y alcance
- Módulo afectado: `web/web_app/main.py` (ruta `/api/reports/sla`).
- Error reportado: FastAPI devolvía `Input should be a valid list` al subir los dos Excel del flujo legacy desde la UI. Se detectó que algunos navegadores serializan el campo `files` como un único objeto.
- Alcance: Cambios limitados al endpoint web; no se modificaron servicios SLA ni el frontend.

- Se amplió el parámetro `files` para aceptar `Union[List[UploadFile], UploadFile, None]`.
- Se normalizó el helper interno `_close_uploads` para manejar listas y objetos individuales antes de cerrar los streams temporales.
- Se agregó la lógica para generar la lista de archivos a partir del nuevo tipo unificado.
- Se actualizó `core/logging.setup_logging` para respetar `LOGS_DIR` (default: carpeta `Logs` del repo) y se configuró `web/web_app/main.py` para forzar escritura en esa ruta con handler rotativo.
- Se enriqueció la respuesta de error 500 del endpoint SLA para incluir el detalle de la excepción y facilitar el diagnóstico desde la UI.

- [x] Ajustar endpoint `/api/reports/sla` para tolerar un único `UploadFile`.
- [x] Cerrar correctamente todos los adjuntos, evitando leaks de archivos temporales.
- [x] Centralizar los logs del servicio web en la carpeta `Logs/` del proyecto.
- [x] Añadir detalle del error backend al mensaje HTTP 500 para depurar desde la UI.
- [ ] Revisar si el backend debe registrar advertencias cuando el navegador no envía ambos archivos (TODO evaluar logging adicional si persisten reportes).

## 5. Criterios de aceptación y validación
- La UI debe poder subir dos Excel y recibir respuesta `200` con rutas de reporte.
- Ante un solo archivo, el backend responde `400` con mensaje claro sin lanzar excepción interna.
- Pruebas ejecutadas: `/home/focal/proyectos/LAS-FOCAS/.venv/bin/python -m pytest tests/test_sla_module.py` (OK).

## 6. Impacto en seguridad y datos
- Sin exposición de datos sensibles; se mantiene el control CSRF y validación de extensiones.
- No se alteran permisos ni rutas publicadas.

## 7. Compatibilidad y migraciones
- No se requieren migraciones de base de datos ni cambios en Docker/Compose.
- Compatible con los Excel legacy vigentes.

## 8. Evidencia de validación manual
- Pendiente repetir la carga en la UI con los Excel proporcionados por el usuario para confirmar la resolución end-to-end.

## 9. Próximos pasos
- Ejecutar la validación manual pendiente y, si es exitosa, cerrar el incidente de error de validación.
