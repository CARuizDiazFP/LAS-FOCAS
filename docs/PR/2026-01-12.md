# Nombre de archivo: 2026-01-12.md
# Ubicaci√≥n de archivo: docs/PR/2026-01-12.md
# Descripci√≥n: PR diario - Implementaci√≥n del Protocolo de Protecci√≥n (Baneo de C√°maras)

# PR 2026-01-12: Protocolo de Protecci√≥n (Baneo de C√°maras)

## Resumen de Cambios

Implementaci√≥n completa del sistema de baneo de c√°maras para proteger fibra √≥ptica de respaldo.

1. **Nuevo modelo `IncidenteBaneo`** para registrar incidentes de protecci√≥n.
2. **Servicio `ProtectionService`** con l√≥gica de baneo/desbaneo inteligente.
3. **4 endpoints de baneo** (create, lift, active, detail).
4. **Endpoint de exportaci√≥n** de c√°maras a CSV/XLSX con filtros.
5. **C√°maras nuevas nacen BANEADAS** si el servicio tiene baneo activo.
6. **Migraci√≥n Alembic** para la nueva tabla.
7. **Documentaci√≥n actualizada**.

## Contexto y Alcance

El **Protocolo de Protecci√≥n** permite bloquear el acceso f√≠sico a c√°maras que contienen fibra √≥ptica de respaldo cuando la fibra principal est√° cortada.

### Caracter√≠sticas clave:

- **Redundancia cruzada:** El servicio afectado (el que se cort√≥) puede ser diferente al servicio protegido (cuyas c√°maras se banean).
- **Baneo a nivel de entidad:** El estado de `Camara` cambia a `BANEADA`, no solo la asociaci√≥n.
- **Restauraci√≥n inteligente:** Al levantar un baneo, las c√°maras vuelven a `LIBRE` u `OCUPADA` seg√∫n ingresos activos.
- **C√°maras heredan baneo:** Al cargar tracking de un servicio baneado, las c√°maras nuevas nacen `BANEADAS`.

## M√≥dulos Afectados

- `db/models/infra.py` - Nuevo modelo `IncidenteBaneo`
- `core/services/protection_service.py` - **Nuevo archivo** con l√≥gica de baneo
- `core/services/infra_service.py` - Modificado para banear c√°maras nuevas
- `api/api_app/routes/infra.py` - 5 nuevos endpoints
- `db/alembic/versions/20260112_01_incidente_baneo.py` - Migraci√≥n

## Cambios Detallados

### 1. Modelo `IncidenteBaneo` (`db/models/infra.py`)

Nueva tabla para registrar incidentes de protecci√≥n:

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | PK | ID autoincremental |
| `ticket_asociado` | String(64) | ID del ticket de soporte |
| `servicio_afectado_id` | String(64) | Servicio que sufri√≥ el corte |
| `servicio_protegido_id` | String(64) | Servicio a proteger (banear) |
| `ruta_protegida_id` | FK | Ruta espec√≠fica (opcional) |
| `usuario_ejecutor` | String(128) | Usuario que ejecut√≥ |
| `motivo` | String(512) | Motivo del baneo |
| `fecha_inicio` | DateTime | Inicio del baneo |
| `fecha_fin` | DateTime | Fin del baneo |
| `activo` | Boolean | Si est√° vigente |

### 2. Servicio `ProtectionService`

Nuevo archivo `core/services/protection_service.py`:

```python
class ProtectionService:
    def create_ban(...) -> BanResult
    def lift_ban(...) -> LiftResult
    def get_camaras_for_servicio(...) -> List[Camara]
    def get_incidentes_activos() -> List[IncidenteBaneo]
    def is_servicio_baneado(servicio_id) -> bool
```

**L√≥gica de restauraci√≥n al desbanear:**
1. Si c√°mara tiene ingreso activo ‚Üí `OCUPADA`
2. Si c√°mara tiene otro baneo activo ‚Üí `BANEADA` (sin cambio)
3. En otro caso ‚Üí `LIBRE`

### 3. Nuevos Endpoints

| Endpoint | M√©todo | Descripci√≥n |
|----------|--------|-------------|
| `/api/infra/ban/create` | POST | Crear baneo |
| `/api/infra/ban/lift` | POST | Levantar baneo |
| `/api/infra/ban/active` | GET | Listar baneos activos |
| `/api/infra/ban/{id}` | GET | Detalle de un baneo |
| `/api/infra/export/cameras` | GET | Exportar c√°maras a CSV/XLSX |

### 4. Endpoint de Exportaci√≥n

```
GET /api/infra/export/cameras?filter_status=BANEADA&servicio_id=52547&format=xlsx
```

Columnas: ID, Nombre, Fontine_ID, Direcci√≥n, Estado, Servicios_Cat6, Ticket_Baneo, Lat, Lon, Origen_Datos

### 5. C√°maras Nuevas Heredan Baneo

Modificada la funci√≥n `_get_or_create_camara()` en `infra_service.py`:

```python
# Si el servicio tiene baneo activo, la c√°mara nace BANEADA
if servicio_id:
    baneo_activo = session.query(IncidenteBaneo).filter(
        IncidenteBaneo.servicio_protegido_id == servicio_id,
        IncidenteBaneo.activo == True,
    ).first()
    
    if baneo_activo:
        estado_inicial = CamaraEstado.BANEADA
```

## Migraci√≥n Alembic

```bash
# Ejecutar migraci√≥n
alembic -c db/alembic.ini upgrade head

# Verificar tabla creada
psql -c "SELECT * FROM app.incidentes_baneo LIMIT 1;"
```

## Ejemplos de Uso

### Crear baneo

```bash
curl -X POST "http://localhost:8001/api/infra/ban/create" \
  -H "Content-Type: application/json" \
  -d '{
    "ticket_asociado": "INC0012345",
    "servicio_afectado_id": "52547",
    "servicio_protegido_id": "52548",
    "motivo": "Corte de fibra principal, protegiendo backup"
  }'
```

### Levantar baneo

```bash
curl -X POST "http://localhost:8001/api/infra/ban/lift" \
  -H "Content-Type: application/json" \
  -d '{
    "incidente_id": 1,
    "motivo_cierre": "Corte reparado"
  }'
```

### Exportar c√°maras baneadas

```bash
curl -o camaras_baneadas.xlsx \
  "http://localhost:8001/api/infra/export/cameras?filter_status=BANEADA&format=xlsx"
```

## Criterios de Aceptaci√≥n

### Backend
- [x] Migraci√≥n Alembic generada y aplicada
- [x] Baneo afecta estado de entidad Camara (no solo asociaci√≥n)
- [x] Endpoint de exportaci√≥n funciona correctamente
- [x] C√°maras nuevas nacen BANEADAS si servicio tiene baneo activo
- [x] Redundancia cruzada (servicio afectado ‚â† servicio protegido)
- [x] Restauraci√≥n inteligente al levantar baneo
- [x] Documentaci√≥n actualizada (api.md, db.md)

### Frontend
- [x] Bot√≥n p√°nico "üö® Protocolo Protecci√≥n" en cabecera Infra
- [x] Badge con contador de baneos activos
- [x] Wizard de baneo en 3 pasos (modal)
- [x] Indicadores visuales en tarjetas baneadas (borde rojo, candado, ticket)
- [x] Dropdown de exportaci√≥n (todas, baneadas, con ingreso)
- [x] Bot√≥n de notificaciones (mock visual)
- [x] Documentaci√≥n frontend en docs/web.md

## Archivos Modificados

**Nuevos:**
- `core/services/protection_service.py`
- `db/alembic/versions/20260112_01_incidente_baneo.py`
- `docs/PR/2026-01-12.md`

**Modificados (Backend):**
- `db/models/infra.py` - Modelo IncidenteBaneo
- `core/services/infra_service.py` - C√°maras heredan baneo
- `api/api_app/routes/infra.py` - 5 nuevos endpoints
- `docs/api.md` - Documentaci√≥n endpoints
- `docs/db.md` - Documentaci√≥n tabla

**Modificados (Frontend):**
- `web/templates/panel.html` - Bot√≥n p√°nico, modales wizard/notify, export dropdown
- `web/static/panel.js` - L√≥gica wizard, export, notificaciones, renderCamaraCard
- `web/static/styles.css` - Estilos componentes de baneo (~500 l√≠neas)
- `docs/web.md` - Secci√≥n "Protocolo de Protecci√≥n"

## Implementaci√≥n Frontend

### Estructura HTML A√±adida

```html
<!-- Cabecera Infra con acciones -->
<div class="infra-hero-actions">
  <span class="infra-ban-badge" id="banBadge">0</span>
  <button class="infra-notify-btn" id="notifyBanBtn">üîî</button>
  <button class="infra-panic-btn" id="panicBtn">üö® Protocolo Protecci√≥n</button>
</div>

<!-- Dropdown de exportaci√≥n -->
<div class="infra-export-dropdown">
  <button class="infra-export-btn">Exportar ‚ñº</button>
  <div class="infra-export-menu">...</div>
</div>

<!-- Wizard modal (3 pasos) -->
<dialog id="banWizardModal" class="ban-wizard-modal">...</dialog>

<!-- Modal de notificaciones -->
<dialog id="notifyModal" class="notify-modal">...</dialog>
```

### JavaScript A√±adido (~400 l√≠neas)

- `banWizardState`: Objeto de estado para el wizard
- `resetBanWizard()`: Reinicia estado del wizard
- `updateWizardStep()`: Navegaci√≥n entre pasos
- `searchCamaraForBan()`: B√∫squeda de c√°mara en paso 1
- `loadRutasForService()`: Carga rutas en paso 2
- `showTrackingStatus()`: Actualiza sem√°foro de progreso
- `executeBan()`: Env√≠a POST a `/api/infra/ban/create`
- `loadActiveBans()`: Actualiza badge y listado
- `handleExportOption()`: Maneja opciones de exportaci√≥n

### CSS A√±adido (~500 l√≠neas)

Estilos para componentes del Protocolo de Protecci√≥n:

| Clase | Descripci√≥n |
|-------|-------------|
| `.infra-panic-btn` | Bot√≥n rojo con glow y animaci√≥n |
| `.infra-ban-badge` | Badge contador de baneos |
| `.infra-notify-btn` | Bot√≥n de campana |
| `.infra-export-dropdown` | Men√∫ desplegable de exportaci√≥n |
| `.ban-wizard-modal` | Modal del wizard |
| `.ban-wizard-step` | Cada paso del wizard |
| `.ban-tracking-semaforo` | Indicador de progreso |
| `.infra-camara-card[data-estado="BANEADA"]` | Tarjeta baneada |
| `.infra-ban-ticket` | Chip de ticket en tarjeta |
| `.email-editor-modal` | Modal de editor de correo |
| `.email-field` | Campos del formulario de email |
| `.email-attachments` | Secci√≥n de adjuntos |
| `.email-bans-summary` | Resumen de baneos en correo |

---

## Actualizaci√≥n: Sistema de Notificaci√≥n por Correo

### Cambios adicionales (Etapa 2)

Se implement√≥ el sistema completo de notificaci√≥n por correo electr√≥nico:

### Backend

1. **Nuevo servicio `EmailService`** (`core/services/email_service.py`):
   - Env√≠o de correos con SMTP configurado v√≠a variables de entorno
   - Soporte para adjuntos (XLS, TXT)
   - Manejo robusto de errores (autenticaci√≥n, timeouts, destinatarios rechazados)

2. **Configuraci√≥n SMTP** (`core/config.py`):
   - `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`
   - `SMTP_FROM_EMAIL`, `SMTP_FROM_NAME`, `SMTP_USE_TLS`

3. **Nuevos endpoints**:
   | Endpoint | M√©todo | Descripci√≥n |
   |----------|--------|-------------|
   | `/api/infra/notify/email` | POST | Enviar notificaci√≥n por correo |
   | `/api/infra/tracking/{ruta_id}/download` | GET | Descargar TXT original |
   | `/api/infra/notify/email/config` | GET | Estado de configuraci√≥n SMTP |

4. **Persistencia de archivo original**:
   - Nueva columna `raw_file_content` en `rutas_servicio`
   - El archivo TXT original se guarda √≠ntegro (no reconstruido)
   - Migraci√≥n: `20260112_02_raw_file_content.py`

### Frontend

5. **Modal de editor de correo** (`panel.html`):
   - Campos: Para, CC, Asunto, Cuerpo
   - Adjuntos seleccionables: XLS (baneos) y TXT original
   - Resumen de baneos incluidos

6. **Estilos CSS** (`styles.css`):
   - Secci√≥n completa de estilos para `.email-editor-*`

7. **L√≥gica JavaScript** (`panel.js`):
   - Auto-generaci√≥n de asunto y cuerpo con datos de baneos
   - Validaci√≥n de emails
   - Env√≠o as√≠ncrono con feedback visual

8. **Fix del bot√≥n de exportaci√≥n** (perezoso):
   - Mejorado manejo de eventos para evitar cierre prematuro del men√∫

### Tests

- `tests/test_email_service.py` - 8 tests para el servicio de email

## Pr√≥ximos Pasos

- [x] ~~UI en panel web para gestionar baneos~~
- [x] ~~Sistema de notificaci√≥n por correo~~
- [x] ~~Persistencia del TXT original~~
- [ ] Tests unitarios para ProtectionService
- [ ] Tests E2E para flujo de wizard
- [ ] Historial de baneos por c√°mara con timeline
- [ ] Integraci√≥n con Telegram bot para alertas
