# Nombre de archivo: 2026-01-08.md
# Ubicación de archivo: docs/PR/2026-01-08.md
# Descripción: Registro diario de cambios del 2026-01-08

## Resumen de cambios

### Mañana: Migraciones Alembic
- Ajuste de la migración `20251230_01_infra.py` para evitar recrear el enum `app.camara_estado` en reintentos (`create_type=False` + `checkfirst`).
- Documentación actualizada con pasos concretos para ejecutar Alembic (`docs/Guia_de_Uso.md`, `docs/db.md`).
- Ejecución manual de `alembic upgrade head` usando `ALEMBIC_URL` apuntando a `localhost`.

### Tarde: Gestión de infraestructura de fibra óptica
- **Modelos actualizados** (`db/models/infra.py`):
  - Nuevo estado de cámara: `DETECTADA` (para cámaras creadas automáticamente desde tracking).
  - Nuevo campo `origen_datos` con enum `MANUAL`, `TRACKING`, `SHEET`.
  - Campo `servicio_id` único en tabla `servicios` para identificar servicios por su número.
  - Campo `nombre_archivo_origen` en `servicios` para trazabilidad.
  - Docstrings y `__repr__` en todos los modelos.

- **Parser de tracking mejorado** (`core/parsers/tracking_parser.py`):
  - Nueva función `extract_servicio_id()` para extraer ID desde nombre de archivo (regex).
  - Nuevo dataclass `TrackingParseResult` que encapsula el resultado completo del parsing.
  - Método `get_topologia()` para obtener lista de empalmes con sus ubicaciones.
  - Compatibilidad hacia atrás con `parse_tracking_entries()`.

- **Nuevo endpoint** (`api/api_app/routes/infra.py`):
  - `POST /api/infra/upload_tracking`: procesa archivos TXT de tracking de fibra óptica.
  - Lógica de enriquecimiento progresivo: crea cámaras detectadas automáticamente.
  - Idempotente: subir el mismo archivo dos veces no duplica datos.
  - Respuesta con métricas: servicios procesados, cámaras nuevas/existentes, empalmes registrados.

- **Documentación actualizada**:
  - `docs/api.md`: documentación completa del endpoint `/api/infra/upload_tracking`.
  - `docs/db.md`: esquema detallado de todas las tablas de infraestructura con campos y relaciones.

### Noche: Dashboard de Infraestructura (Frontend)
- **Panel web actualizado** (`web/templates/panel.html`):
  - Nueva pestaña "Infra/Cámaras" en la barra de navegación.
  - Sección `#view-infra` completa con:
    - Barra de búsqueda con debounce (400ms).
    - Zona de upload drag&drop para archivos de tracking.
    - Filtros por estado (chips: LIBRE, OCUPADA, BANEADA, DETECTADA).
    - Grilla de tarjetas de cámaras con estado visual.
    - Contenedor de notificaciones toast.

- **Estilos dark/hacker** (`web/static/styles.css`):
  - ~400 líneas de estilos para el dashboard de infraestructura.
  - Tema oscuro con acentos neón (#00ff88).
  - Efectos de glow en focus para inputs.
  - Animaciones de drag&drop en upload zone.
  - Tarjetas de cámara con indicador de estado via CSS variable.
  - Sistema de toast notifications con animaciones slide-in/out.

- **Lógica JavaScript** (`web/static/panel.js`):
  - ~300 líneas de JS en IIFE para el módulo infra.
  - Función `debounce()` para evitar saturación de API.
  - `searchCamaras()` con soporte de filtro por estado.
  - `uploadTracking()` con drag&drop y feedback visual.
  - `renderCamaraCard()` genera tarjetas dinámicamente.
  - `showToast()` para notificaciones de éxito/error.
  - MutationObserver para detectar activación de vista y carga inicial.

- **Nuevos endpoints en web service** (`web/web_app/main.py`):
  - `GET /api/infra/camaras`: búsqueda de cámaras con filtros.
  - `POST /api/infra/upload_tracking`: carga de archivos tracking.
  - Ambos requieren sesión activa (`_require_auth()`).

- **Documentación actualizada**:
  - `docs/web.md`: nueva sección "Dashboard de Infraestructura (Cámaras)".
  - `docs/api.md`: documentación del endpoint `GET /api/infra/camaras`.

## Contexto y alcance
- **Módulo afectado:** Infraestructura de fibra óptica.
- **Objetivo de negocio:** Permitir cargar archivos de tracking de servicios FO para poblar la base de datos con servicios, cámaras y empalmes.
- **Restricciones:**
  - El ID del servicio se extrae del nombre del archivo (ej: `FO 111995 C2.txt` → `111995`).
  - Las cámaras detectadas se crean con estado `DETECTADA` para posterior validación.
  - El sistema es idempotente: las recargas actualizan en lugar de duplicar.

## Cambios realizados

### Archivos modificados
- `db/models/infra.py`: modelos actualizados con nuevos campos y enums.
- `core/parsers/tracking_parser.py`: parser mejorado con extracción de ID y resultado estructurado.
- `api/api_app/routes/infra.py`: endpoints de carga de tracking, búsqueda de cámaras y **búsqueda avanzada**.
- `web/templates/panel.html`: nueva pestaña y sección "Infra/Cámaras".
- `web/static/styles.css`: ~400 líneas de estilos dark/hacker para dashboard de infraestructura.
- `web/static/panel.js`: ~300 líneas de lógica para búsqueda, upload y notificaciones.
- `web/web_app/main.py`: endpoints de cámaras y upload_tracking para el web service.
- `docs/api.md`: documentación de endpoints `GET/POST /api/infra/*` **incluyendo búsqueda avanzada**.
- `docs/db.md`: esquema detallado de tablas de infraestructura.
- `docs/web.md`: nueva sección "Dashboard de Infraestructura (Cámaras)".
- **`tests/test_infra_search.py`: 32 tests para el endpoint de búsqueda avanzada (nuevo).**

### Endpoints nuevos
- `POST /api/infra/upload_tracking`: carga y procesa archivos de tracking FO.
- `GET /api/infra/camaras`: búsqueda de cámaras con filtros (q, estado, limit).
- **`POST /api/infra/search`: búsqueda avanzada con filtros combinables (AND).**

### Esquema de DB
- Enum `CamaraEstado`: agregado valor `DETECTADA`.
- Enum `CamaraOrigenDatos`: nuevo (`MANUAL`, `TRACKING`, `SHEET`).
- Tabla `camaras`: `fontine_id` ahora nullable; `nombre` ahora requerido e indexado; nuevo campo `origen_datos`.
- Tabla `servicios`: nuevo campo `servicio_id` (único), nuevo campo `nombre_archivo_origen`.

## Tareas realizadas y pendientes
- [x] Ejecutar `DROP TYPE app.camara_estado` y rerun Alembic.
- [x] Ajustar migración para reintentos idempotentes.
- [x] Documentar los comandos necesarios.
- [x] Actualizar modelos de infraestructura con nuevos campos.
- [x] Mejorar parser de tracking con extracción de ID de servicio.
- [x] Implementar endpoint `/api/infra/upload_tracking`.
- [x] Implementar endpoint `/api/infra/camaras` (GET).
- [x] Documentar endpoints en `docs/api.md`.
- [x] Documentar esquema en `docs/db.md`.
- [x] Crear dashboard de infraestructura en panel web (HTML/CSS/JS).
- [x] Implementar búsqueda con debounce y filtros por estado.
- [x] Implementar upload drag&drop de trackings.
- [x] Agregar notificaciones toast para feedback de usuario.
- [x] Documentar dashboard en `docs/web.md`.
- [x] Crear migración Alembic para los nuevos campos (enum `origen_datos`, campo `servicio_id`, etc.).
- [x] **Implementar endpoint `POST /api/infra/search` con búsqueda avanzada (filtros AND).**
- [x] **Agregar tests unitarios para el endpoint de búsqueda avanzada.**
- [ ] Agregar tests de integración con DB mock para los endpoints de infra.
- [ ] Replicar el procedimiento en staging/producción.

## Actualización PM - Búsqueda Avanzada de Infraestructura

### Nuevo endpoint: `POST /api/infra/search`
Implementado endpoint de búsqueda avanzada con filtros combinables usando lógica AND.

**Campos de filtro:**
- `service_id`: Busca cámaras por donde pasa un servicio
- `address`: Nombre o dirección de la cámara
- `status`: Estado (LIBRE, OCUPADA, BANEADA, DETECTADA)
- `cable`: Nombre del cable asociado
- `origen`: Origen de datos (MANUAL, TRACKING, SHEET)

**Operadores soportados:**
- `eq`: Coincidencia exacta (case-insensitive)
- `contains`: Contiene texto (default)
- `starts_with`: Empieza con
- `ends_with`: Termina con
- `in`: Valor en lista de opciones

**Validaciones:**
- Máximo 10 filtros por request
- Límite máximo 500 resultados
- Paginación con offset

**Tests implementados:** 32 tests unitarios que cubren:
- Funciones auxiliares (`_apply_text_filter`, `_camara_matches_filter`)
- Modelos Pydantic (SearchFilter, SearchRequest, enums)
- Validaciones de endpoint (422 para inputs inválidos)

## Criterios de aceptación y validación
- `alembic -c db/alembic.ini upgrade head` corre en local sin errores.
- El endpoint acepta archivos `.txt` y extrae correctamente el ID del servicio.
- Las cámaras nuevas se crean con estado `DETECTADA` y origen `TRACKING`.
- Subir el mismo archivo dos veces no duplica registros.
- La respuesta incluye conteos correctos de cámaras nuevas/existentes y empalmes.

## Impacto en seguridad y datos
- El endpoint no requiere autenticación (TODO: agregar API key / JWT).
- No se exponen credenciales en logs.
- Los datos crudos del tracking se persisten en `raw_tracking_data` para auditoría.

## Compatibilidad y migraciones
- **Requiere nueva migración Alembic** para:
  - Agregar valor `DETECTADA` al enum `camara_estado`.
  - Crear enum `camara_origen_datos`.
  - Modificar campo `fontine_id` a nullable.
  - Agregar campos `servicio_id` y `nombre_archivo_origen` a `servicios`.
- La migración debe ser idempotente (usar `checkfirst=True`).

## Evidencia de validación manual
- Comando: `ALEMBIC_URL=postgresql+psycopg://lasfocas:cambiar-este-password@localhost:5432/lasfocas alembic -c db/alembic.ini upgrade head` → `OK`.
- `\dt app.*` muestra tablas `camaras`, `empalmes`, `servicios`, `ingresos`, `servicio_empalme_association`.

## Próximos pasos
1. Crear migración Alembic para los cambios de esquema.
2. Implementar tests unitarios para `tracking_parser.py`.
3. Implementar tests de integración para `/api/infra/*`.
4. Agregar autenticación al endpoint de API (API key o JWT).
5. Documentar en `docs/Seguridad.md` las recomendaciones para manejar `ALEMBIC_URL`.
6. Automatizar la ejecución de migraciones desde los scripts de arranque (`Start`).
7. Probar el flujo completo: upload tracking → búsqueda de cámaras → visualización en dashboard.
