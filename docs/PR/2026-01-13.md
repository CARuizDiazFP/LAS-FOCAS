# Nombre de archivo: 2026-01-13.md
# Ubicación de archivo: docs/PR/2026-01-13.md
# Descripción: PR diario del 13 de enero de 2026 - Refactoring DB, Parser y Lógica de Conflictos

# PR Diario - 2026-01-13

## Resumen de Cambios

### Etapa 1: Modelos de Base de Datos y Parser
Refactoring del modelo de base de datos y el parser de tracking para soportar:
- Puntos terminales (Puntas A y B) de rutas de fibra óptica
- Detección de tránsitos (ODF/NODO/RACK)
- Alias de servicios (ej: O1C1, O1C2 para identificar pelos)
- Cantidad de pelos/hilos por ruta

### Etapa 2: Lógica de Detección de Conflictos
Implementación de detección inteligente de conflictos al subir trackings:
- **POTENTIAL_UPGRADE**: Detecta cuando un nuevo ID de servicio tiene las mismas puntas A/B que uno existente
- **NEW_STRAND**: Detecta cuando es el mismo servicio y camino pero diferente pelo
- **CONFIRM_UPGRADE**: Acción para confirmar upgrade y mover ID viejo a alias
- **ADD_STRAND**: Acción para agregar nuevo pelo a una ruta existente

## Archivos Modificados

### db/models/infra.py
- Nuevo enum `PuntoTerminalTipo` (A, B)
- Nueva tabla `PuntoTerminal` (ruta_id, tipo, sitio_descripcion, identificador_fisico, pelo_conector)
- `Servicio.alias_ids` (ARRAY de strings)
- `RutaServicio.cantidad_pelos` (Integer)
- `RutaServicio.puntos_terminales` (relación)
- `Empalme.es_transito` (Boolean)

### core/parsers/tracking_parser.py
- Nuevo dataclass `PuntaTerminal`
- Funciones: `extract_alias_id()`, `is_transito()`, `extract_pelo_conector()`, `extract_cantidad_pelos()`, `parse_punta()`
- `TrackingParseResult`: campos `alias_id`, `transitos_count`, `cantidad_pelos`, `punta_a`, `punta_b`
- `TrackingEntry.es_transito` (Boolean)

### core/services/infra_service.py
- Nuevos enums: `AnalysisStatus.POTENTIAL_UPGRADE`, `AnalysisStatus.NEW_STRAND`
- Nuevos enums: `ResolveAction.CONFIRM_UPGRADE`, `ResolveAction.ADD_STRAND`
- Nuevos dataclasses: `UpgradeInfo`, `StrandInfo`
- `AnalysisResult`: campos upgrade_info, strand_info, punta_a_sitio, punta_b_sitio, cantidad_pelos, alias_id
- Métodos nuevos: `_find_service_by_endpoints()`, `_routes_have_same_path()`, `_action_confirm_upgrade()`, `_action_add_strand()`, `_update_puntos_terminales()`
- `resolve_tracking()`: nuevo parámetro `old_service_id`

### api/api_app/routes/infra.py
- Nuevos modelos: `UpgradeInfoResponse`, `StrandInfoResponse`
- `TrackingAnalyzeResponse`: campos upgrade_info, strand_info, punta_a_sitio, punta_b_sitio, cantidad_pelos, alias_id
- `TrackingResolveRequest`: campo `old_service_id`
- Documentación actualizada de acciones disponibles

### db/alembic/versions/20260113_01_puntos_terminales.py
- Migración completa con upgrade/downgrade
- Creación idempotente del enum punto_terminal_tipo

## Criterios de Aceptación

- [x] Modelos sin errores de sintaxis
- [x] Parser sin errores de sintaxis
- [x] Servicio sin errores de sintaxis
- [x] Endpoints sin errores de sintaxis
- [x] Migración aplicada correctamente
- [x] Endpoint /api/infra/trackings/analyze devuelve nuevos campos
- [ ] Tests unitarios para nuevas funciones (TODO)

## Ejemplo de Response del Endpoint Analyze

```json
{
    "status": "CONFLICT",
    "servicio_id": "52547",
    "servicio_db_id": 29,
    "punta_a_sitio": "ODF MAIPU 316 1",
    "punta_b_sitio": "ODF WARNES 1030",
    "alias_id": "O1C1",
    "upgrade_info": null,
    "strand_info": null
}
```

## Próximos Pasos

1. Crear tests unitarios para las nuevas funciones
2. ~~Implementar UI web para mostrar y gestionar escenarios de upgrade/nuevo pelo~~ ✅
3. Migrar servicios existentes para que tengan puntos terminales (para que la detección funcione)
4. Documentar flujos de usuario para cada escenario

---

## Etapa 3: Actualización del Frontend

### web/templates/panel.html
- Modal de conflicto actualizado con 3 vistas:
  - **Conflicto estándar**: Vista original para REPLACE/BRANCH/MERGE
  - **POTENTIAL_UPGRADE**: Diagrama de migración con servicio viejo → nuevo
  - **NEW_STRAND**: Vista de incremento de pelos con contador visual
- Chips de puntas A/B con iconos SVG
- Botones de acción específicos para cada tipo de conflicto

### web/static/panel.js
- `showConflictModal()` actualizada para detectar tipo de conflicto (`POTENTIAL_UPGRADE`, `NEW_STRAND`, `CONFLICT`)
- `renderCamaraCard()` mejorada con:
  - Chips de alias (ex IDs) para servicios migrados
  - Badge de pelos (`x2 Hilos`) cuando `cantidad_pelos > 1`
  - Badge de tránsitos con icono de nodo
  - Chips de Punta A y Punta B con iconos ODF
- `resolveTracking()` actualizada para enviar:
  - `old_service_id` en caso de `CONFIRM_UPGRADE`
  - `target_ruta_id` en caso de `ADD_STRAND`

### web/static/styles.css
- Estilos para vista de upgrade (diagrama de migración)
- Estilos para vista de strand (contador de pelos)
- Estilos para chips de puntas en tarjetas
- Badges para alias, pelos y tránsitos
- Responsive design para móviles

## Criterios de Aceptación Frontend

- [x] Modal muestra título diferente según tipo de conflicto
- [x] Vista de upgrade muestra IDs viejo y nuevo con flecha
- [x] Vista de strand muestra contador de pelos actual → nuevo
- [x] Tarjetas de cámara muestran alias (ex IDs)
- [x] Tarjetas muestran badge de pelos cuando > 1
- [x] Tarjetas muestran badge de tránsitos
- [x] Tarjetas muestran chips de Punta A/B
- [x] Sin errores de sintaxis en JS/HTML/CSS
- [x] Servicio web reiniciado correctamente

---

## Etapa 4: Simplificación del Modal "Dar Aviso"

Refactoring del modal de composición de correo electrónico para mejorar usabilidad.

### Cambios Realizados

#### web/templates/panel.html
- **Eliminados** tabs "Editar HTML" y "Vista Previa"
- **Eliminada** edición HTML (era muy complicado para usuarios no técnicos)
- **Añadido** editor de texto plano simple
- **Añadidos** dos botones en el footer:
  - "Descargar EML" (outline, para generar archivo y abrir en cliente de correo)
  - "Enviar Correo" (primary, para envío directo via API)
- **Actualizado** hint para indicar guardado automático de destinatarios

#### web/static/panel.js
- Nueva constante `EMAIL_STORAGE_KEY = 'lasfocas_email_settings'`
- Nueva función `loadEmailSettings()`: carga destinatarios desde localStorage
- Nueva función `saveEmailSettings()`: guarda destinatarios en localStorage
- Nueva plantilla `EMAIL_TEXT_TEMPLATE`: versión texto plano del correo
- Nueva función `generateEmailText()`: genera texto del email usando la plantilla
- Nueva función `validateEmailForm()`: validación consolidada del formulario
- Nueva función `prepareEmailPayload()`: prepara payload convirtiendo texto a HTML
- Nueva función `sendEmailDirectly()`: envío directo via API `/api/infra/notify/send`
- Actualizada `downloadEmailAsEml()`: usa las nuevas funciones auxiliares
- Actualizada `loadBansIntoEmailEditor()`: carga destinatarios desde localStorage
- Actualizada `resetEmailEditor()`: no limpia destinatarios (se cargan de localStorage)
- Removido `setupEmailTabs()`: ya no hay tabs
- Removida `generateEmailHtml()`: reemplazada por `generateEmailText()`

#### web/static/styles.css
- Nueva clase `.email-text-editor`: estilos para textarea de texto plano
- Nueva clase `.btn.outline-primary`: estilos para botón de descarga EML
- **Removidos** estilos de tabs: `.email-tabs`, `.email-tab`, `.email-tab-content`
- **Removidos** estilos: `.email-html-editor`, `.email-preview-container`

### Características del Nuevo Modal

1. **Editor de texto simple**: Los usuarios editan el contenido como texto normal, sin necesidad de conocer HTML
2. **Persistencia de destinatarios**: Los destinatarios se guardan automáticamente en localStorage y se restauran al abrir el modal
3. **Dos opciones de envío**:
   - **Descargar EML**: Genera archivo .eml que se puede abrir en cualquier cliente de correo (Outlook, Thunderbird, etc.)
   - **Enviar Correo**: Envía directamente via SMTP desde el servidor (requiere endpoint `/api/infra/notify/send`)
4. **Conversión automática**: El texto plano se convierte a HTML al enviar, manteniendo formato y saltos de línea

### Criterios de Aceptación

- [x] Modal sin tabs, solo editor de texto
- [x] Ambos botones visibles: "Descargar EML" y "Enviar Correo"
- [x] Destinatarios persistentes en localStorage
- [x] Función de descarga EML operativa
- [x] Sin errores de sintaxis en JS/HTML/CSS
- [x] Servicio web reiniciado correctamente

### Pendientes

- [ ] Implementar endpoint `/api/infra/notify/send` en el backend
- [ ] Configurar SMTP en producción
- [ ] Tests del nuevo flujo de email

---

## Etapa 5: Corrección de Bugs

### Bug 1: Modal de conflicto incorrecto para múltiples pelos

**Problema:** Al subir el segundo tracking del mismo servicio con diferente pelo (ej: `91710 C2.txt` después de `91710 C1.txt`), se mostraba el modal de conflicto genérico en lugar del modal de "Agregar Pelo".

**Causa:** 
1. El regex `ALIAS_REGEX` solo soportaba formatos como `O1C1` pero no formatos simples como `C1`, `C2`
2. La detección de `NEW_STRAND` dependía de tener puntos terminales guardados en la ruta existente, lo cual fallaba para servicios creados antes de la migración

**Solución:**
- Actualizado `ALIAS_REGEX` en [tracking_parser.py](core/parsers/tracking_parser.py) para soportar:
  - `91710 C1.txt` → `C1`
  - `91710 C2.txt` → `C2`
  - `52547 O1C1.txt` → `O1C1`
- Modificada lógica de detección en `analyze_tracking()` en [infra_service.py](core/services/infra_service.py):
  - Ahora detecta `NEW_STRAND` si el archivo tiene un alias que no está en `servicio.alias_ids`
  - No depende de que la ruta tenga puntos terminales guardados
- Agregada llamada a `_update_puntos_terminales()` en `_action_create_new()` para guardar puntas al crear servicios nuevos

### Bug 2: Error al descargar correo de baneos

**Problema:** El botón "Descargar EML" fallaba silenciosamente.

**Causa:** La función `loadEmailSettings()` no retornaba el objeto de configuración, causando un error cuando se intentaba acceder a `savedSettings.recipients`.

**Solución:**
- Corregida `loadEmailSettings()` en [panel.js](web/static/panel.js) para retornar `{}` cuando no hay configuración guardada

### Archivos Modificados

| Archivo | Cambio |
|---------|--------|
| [core/parsers/tracking_parser.py](core/parsers/tracking_parser.py) | Regex de alias mejorado |
| [core/services/infra_service.py](core/services/infra_service.py) | Lógica NEW_STRAND + guardar puntas en CREATE_NEW |
| [web/static/panel.js](web/static/panel.js) | Fix loadEmailSettings() |

### Criterios de Aceptación

- [x] Archivos con formato `XXXXX C1.txt`, `XXXXX C2.txt` extraen alias correctamente
- [x] Segundo pelo del mismo servicio muestra modal "Agregar Pelo" (NEW_STRAND)
- [x] Función de descarga EML no arroja error
- [x] Servicios nuevos guardan puntos terminales
- [x] Servicios nuevos guardan alias en la lista de alias_ids
