# Nombre de archivo: 2025-09-18.md
# Ubicación de archivo: docs/PR/2025-09-18.md
# Descripción: Registro de cambios diario (UI Web: admin y seguridad)

## Resumen

- UI Web: endpoints para cambiar contraseña y crear usuarios (admin-only).
- Inyección de API_BASE y CSRF a la plantilla. Frontend TS ahora envía csrf_token.
- Rate limiting básico para chat. Documentación actualizada.

## Contexto y alcance

- Módulo afectado: `web/` (FastAPI + Vite TS)
- Riesgos: manejo de sesiones y CSRF; validar WEB_SECRET_KEY en producción.

## Cambios realizados

- web/app/main.py: nuevos endpoints `/api/users/change-password` y `/api/admin/users`, refuerzo de CSRF y rate limiting en chat, role en sesión.
- web/templates/index.html: expone `window.API_BASE` y `window.CSRF_TOKEN`.
- web/frontend/src/main.ts: adjunta `csrf_token` en POST al chat.
- docs/web.md: agrega documentación de endpoints y seguridad; documenta roles Admin/OwnerGroup/Invitado.
 - web/app/main.py: endpoints `/api/flows/sla`, `/api/flows/repetitividad` y placeholder `/api/flows/comparador-fo`. Monta `/reports` estático. Crea data/uploads y data/reports.
 - web/templates/index.html: botones SLA/Repetitividad/FO con estilo oscuro; formulario de upload y feedback con enlaces a reportes.

## Tareas realizadas y pendientes

- Hecho: endpoints admin/contraseña, CSRF en frontend/backend, RL chat.
- Pendientes: vistas/admin UI mínima, tests de login/admin, documentación README ampliada.

## Criterios de aceptación y validación

- /health responde 200 ok (tests existentes).
- POST /api/chat/message exige CSRF si hay sesión y limita 30/min.
- Endpoints devuelven {status:"ok"} o {error} con códigos apropiados.
 - 8 pruebas pytest PASSED (login/admin). Warnings: deprecations de starlette TestClient (allow_redirects) y passlib(crypt).

## Impacto en seguridad y datos

- Se almacenan roles y hashes bcrypt en app.web_users. No se registran contraseñas en logs.
- Se requiere `WEB_SECRET_KEY` no trivial.

## Compatibilidad y migraciones

- Sin cambios de esquema (ya existía columna role). No requiere Alembic adicional.

## Evidencia de validación manual

- Prueba local con TestClient en /api/chat/message (mock). Navegación /login → /.

## Próximos pasos

- Añadir página Admin y formularios.
- Tests pytest para login, cambio de contraseña y creación de usuarios.
- Proxy Vite para dev y documentación.
 - Unificar manejo de roles en constantes compartidas y UI.
 - Revisar/ocultar warnings de deprecación (usar follow_redirects en tests y actualizar TemplateResponse).
 - Implementar Comparador FO.
 - Agregar tests de integración para flujos (subida de archivo y respuesta con enlaces).
