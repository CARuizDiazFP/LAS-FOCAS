# Nombre de archivo: 2025-09-18.md
# Ubicación de archivo: docs/PR/2025-09-18.md
# Descripción: Registro de cambios diario (UI Web: admin y seguridad)

## Resumen

- UI Web: endpoints para cambiar contraseña y crear usuarios (admin-only).
- Inyección de API_BASE y CSRF a la plantilla. Frontend TS ahora envía csrf_token.
- Rate limiting básico para chat. Documentación actualizada.
- Política de URL base actualizada: uso de IP privada de la VM (http://192.168.241.28:8080) en lugar de localhost.

## Contexto y alcance

- Módulo afectado: `web/` (FastAPI + Vite TS)
- Riesgos: manejo de sesiones y CSRF; validar WEB_SECRET_KEY en producción.

## Cambios realizados

- web/app/main.py: nuevos endpoints `/api/users/change-password` y `/api/admin/users`, refuerzo de CSRF y rate limiting en chat, role en sesión.
- web/templates/index.html: expone `window.API_BASE` y `window.CSRF_TOKEN`.
- web/frontend/src/main.ts: adjunta `csrf_token` en POST al chat.
- docs/web.md: agrega documentación de endpoints y seguridad; documenta roles Admin/OwnerGroup/Invitado.
 - web/app/main.py: endpoints `/api/flows/sla`, `/api/flows/repetitividad` y placeholder `/api/flows/comparador-fo`. Monta `/reports` estático. Crea data/uploads y data/reports.
 - web/templates/index.html: botones SLA/Repetitividad/FO con estilo oscuro; formulario de upload y feedback con enlaces a reportes.
 - deploy/compose.yml: define API_BASE para el servicio web con la IP privada. Healthcheck interno via localhost.
 - Start: banner y verificación de /health ahora apuntan a http://192.168.241.28:8080.
 - web/web_app/main.py y web/app/main.py: valor por defecto de api_base actualizado a la IP privada.
 - web/frontend/src/main.ts: fallback de window.API_BASE actualizado a la IP privada.
 - README.md y docs/web.md: documentación actualizada con la nueva política.
 - deploy/env.sample: añade API_BASE con la IP privada.

## Tareas realizadas y pendientes

- Hecho: endpoints admin/contraseña, CSRF en frontend/backend, RL chat.
- Pendientes: vistas/admin UI mínima, tests de login/admin, documentación README ampliada.

## Criterios de aceptación y validación

- /health responde 200 ok (tests existentes).
- POST /api/chat/message exige CSRF si hay sesión y limita 30/min.
- Endpoints devuelven {status:"ok"} o {error} con códigos apropiados.
 - 8 pruebas pytest PASSED (login/admin). Warnings: deprecations de starlette TestClient (allow_redirects) y passlib(crypt).
 - Validación manual: rebuild del servicio web y verificación con curl a http://localhost:8080/health (OK). Acceso desde host mediante IP privada puede depender de routing; documentado en docs/web.md.

## Impacto en seguridad y datos

- Se almacenan roles y hashes bcrypt en app.web_users. No se registran contraseñas en logs.
- Se requiere `WEB_SECRET_KEY` no trivial.

## Compatibilidad y migraciones

- Sin cambios de esquema (ya existía columna role). No requiere Alembic adicional.

## Evidencia de validación manual

- Prueba local con TestClient en /api/chat/message (mock). Navegación /login → /.

## Próximos pasos

- Añadir página Admin y formularios.
- Tests pytest para login, cambio de contraseña y creación de usuarios.
- Proxy Vite para dev y documentación.
 - Unificar manejo de roles en constantes compartidas y UI.
 - Revisar/ocultar warnings de deprecación (usar follow_redirects en tests y actualizar TemplateResponse).
 - Implementar Comparador FO.
 - Agregar tests de integración para flujos (subida de archivo y respuesta con enlaces).
 - Evaluar accesibilidad externa por IP (firewall/iptables) y documentar troubleshooting para redes bridged/NAT.
