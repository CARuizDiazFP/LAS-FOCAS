# Nombre de archivo: 2025-11-19.md
# Ubicación de archivo: docs/PR/2025-11-19.md
# Descripción: PR diario - corrección de cálculo de horas SLA legacy

# PR Diario - 2025-11-19

## 1. Contexto
- Proyecto LAS-FOCAS, módulo `core/sla`, flujo legacy que genera el informe SLA a partir de dos Excel (servicios y reclamos).
- El informe debía igualar el comportamiento del generador Sandy; se detectó que las horas por servicio seguían en cero aun con datos válidos.
- Entorno Dockerizado (FastAPI + pandas + python-docx) ejecutado en Debian 12.4; reportes se emiten bajo `REPORTS_DIR`.

## 2. Observaciones y errores
- La suma de horas por servicio usaba la columna "Horas Totales Cierre Problema Reclamo" (columna L) como fuente opcional.
- Los Excel actuales ubican el valor correcto en la columna P "Horas Netas Cierre Problema Reclamo".
- Aunque se agregó logging en iteraciones previas, el cálculo seguía tomando la columna equivocada, resultando en totales nulos si la columna L estaba vacía.
- Se detectó además que el "Número Línea" mostrado y usado para agrupar reclamos provenía de la columna D ("Número Primer Servicio"), lo que impedía matchear reclamos reales (columna E) y dejaba las horas en 0.
- Incluso corrigiendo la columna elegida, los valores podían no emparejar debido a diferencias de tipo (números vs strings) o a que Excel exporta `83241.0`; eso provocaba subconjuntos vacíos y totales en cero.
- El requerimiento final exige que **solo** se sumen las horas provenientes de la columna P; otros campos de horas (netas/totales) no deben participar en los cálculos.
- Persistía un caso en producción donde el servicio venía con `Número Línea = 40601` pero los reclamos tenían `Número Línea = 83241` y `Número Primer Servicio = 40601`; al no cruzar ambos campos, el subconjunto quedaba vacío y el total resultaba 0.

## 3. Objetivo
Alinear el motor legacy para que utilice la columna P (Horas Netas Cierre Problema Reclamo) como origen primario de horas sumadas y solo caiga a columnas alternativas cuando realmente falten los datos.
Garantizar que tanto el Excel de servicios como el de reclamos usen la columna "Número Línea" (E) para agrupar, manteniendo "Número Primer Servicio" únicamente como dato opcional.
Normalizar los identificadores de línea para que coincidan aunque en el Excel aparezcan como enteros, floats con `.0` o strings con espacios.
Forzar explícitamente que la suma de horas utilice exclusivamente la columna P y que falte provoque un error amigable.
Emparejar reclamos con servicios usando tanto `Número Línea` como `Número Primer Servicio` (de ambos Excel) y, si se encuentra una coincidencia vía el segundo campo, mostrar igualmente el valor de la columna P (columna E) en el reporte.

## 4. Tareas / configuraciones
1. **Mapping**: añadir sinónimos de "Horas Netas Cierre Problema Reclamo" en `RECLAMOS_OPTIONAL` y convertir sus valores con `_horas_decimal` durante la carga del Excel.
2. **Selección centralizada**: crear helper `_columna_horas_reclamos` que priorice netas de cierre, luego totales y finalmente la columna requerida "horas".
3. **Tablas DOCX**: reutilizar el helper en `_rellenar_tabla_principal` y `_completar_tabla_detalle` para que ambos bloques del informe compartan la misma columna.
4. **Pruebas**: extender `tests/test_sla_legacy_report.py` con fixtures que incluyen la nueva columna y casos que validan tanto la preferencia por netas como el fallback a totales.
5. **Documentación**: registrar el ajuste en este PR diario y actualizar `docs/Mate_y_Ruta.md` con el nuevo estado.
6. **Mapeo de Número Línea**: convertir las tablas de sinónimos (`SERVICIOS_REQUIRED`, `RECLAMOS_REQUIRED`) a secuencias ordenadas para priorizar la columna "Número Línea" y dejar "Número Primer Servicio" como último fallback/valor opcional.
7. **Normalización**: aplicar `_normalize_line_value` tanto en servicios como en reclamos para convertir valores `83241`, `83241.0` o ` 83241 ` en una misma cadena.
8. **Regla columna P**: rechazar de inmediato los Excel de reclamos que no traigan "Horas Netas Cierre Problema Reclamo" y usar esa columna como única fuente de horas.
9. **Match dual**: implementar `_subset_reclamos_por_servicio` para cruzar `Número Línea` + `Número Primer Servicio` entre servicios y reclamos; cuando se usen reclamos como fuente, presentar la línea real (columna E) en el informe.
10. **Nuevos tests**: agregar casos que comprueben que se mapea y suma usando la columna correcta, incluyendo escenarios mixtos (int vs string), error cuando falta la columna P y coincidencias que dependen de `Número Primer Servicio`.

## 5. Criterios de aceptación
- El generador SLA suma horas desde "Horas Netas Cierre Problema Reclamo" cuando la columna existe.
- Si la columna P no está disponible, se usa "Horas Totales Cierre Problema Reclamo"; en ausencia de ambas se recurre a la columna requerida "Horas Netas Reclamo".
- Las tablas principal y de detalle muestran valores coherentes con los datos de entrada.
- Los servicios muestran el "Número Línea" esperado (columna E) y agrupan reclamos correctos aunque exista un "Número Primer Servicio" distinto.
- Las sumatorias consideran reclamos aunque los IDs provengan como ints/floats/strings; `_normalize_line_value` garantiza el match.
- Si la columna "Horas Netas Cierre Problema Reclamo" no está presente, el flujo debe fallar con un mensaje claro sin intentar sumar otro campo.
- Suite `tests/test_sla_legacy_report.py` pasa completa y cubre casos preferente/fallback.
- Se mantienen logs estructurados para trazar qué columna se usó.

## 6. Entregables
- `core/sla/legacy_report.py`: nuevo helper de selección y conversión de horas, logging, preferencia por columna P, normalización consistente de "Número Línea" y emparejamiento dual (`Número Línea`/`Número Primer Servicio`) que evita totales cero.
- `tests/test_sla_legacy_report.py`: fixtures actualizados + seis pruebas nuevas (`prefiere_horas_netas_cierre`, error cuando falta la columna P, preferencia por "Número Línea", suma correcta de horas, normalización int vs string y puente mediante `Número Primer Servicio`).
- `docs/PR/2025-11-19.md`: este registro.
- `docs/Mate_y_Ruta.md`: estado actualizado del roadmap/checklist.

## 7. Checklist de validación
- [x] `pytest tests/test_sla_legacy_report.py -v`
- [x] Verificación manual rápida del helper `_columna_horas_reclamos` con DataFrame de ejemplo (véase logs de consola).
- [x] Revisión de logs: `action=sla_legacy_report stage=tabla_principal columna_horas=... origen=...` confirmando uso de netas cuando están presentes.
- [x] Revisión manual del dataset cargado para confirmar que `numero_linea` apunta a la columna "Número Línea" y `numero_primer_servicio` queda como opcional.
- [x] Verificación manual de `_normalize_line_value` con datos `83241`, `83241.0` y ` 83241 ` para asegurar que todos terminan como la misma clave.
- [x] Chequeo del mensaje de error cuando no se encuentre la columna P en el Excel de reclamos.
- [x] Validación con dataset de ejemplo donde `Número Línea` y `Número Primer Servicio` difieren para comprobar que la suma deja de ser cero y la línea mostrada corresponde a la columna E.
- [x] Documentación (PR diario + Mate y Ruta) actualizada.
