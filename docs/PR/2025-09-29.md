# Nombre de archivo: 2025-09-29.md
# Ubicación de archivo: docs/PR/2025-09-29.md
# Descripción: Registro diario de cambios y pendientes del 29 de septiembre de 2025

## 1. Resumen de cambios
- Se creó la carpeta `Legacy/` y se clonó el repositorio Sandy (`LAS-FOCAS-`) como referencia offline, con `.gitignore` actualizado.
- Se definió el microservicio `office_service/` (FastAPI + LibreOffice UNO) con Dockerfile propio, pruebas básicas y servicio integrado al compose.
- Se actualizaron `docs/Mate_y_Ruta.md`, `docs/decisiones.md` y la documentación general (`README.md`, `docs/office_service.md`).
- Panel web y bot consumen ahora el endpoint `POST /reports/repetitividad`; `Templates/` se monta como volumen en `web` y se añadieron fixtures de integración.

## 2. Contexto y alcance
- Afecta la raíz del proyecto (nueva carpeta ignorada) y la documentación de planeación y decisiones.
- No se modificó código de ejecución ni servicios; alcance limitado a organización y documentación.

## 3. Cambios realizados
- Carpeta `Legacy/` creada y repositorio Sandy clonado.
- `.gitignore` excluye `Legacy/`.
- `office_service/` añadido con FastAPI, gestor UNO y runner que inicia LibreOffice headless.
- Dockerfile del servicio y healthcheck en `docker-compose` integrados.
- `tests/test_office_service_health.py` cubre el endpoint de salud.
- `docs/Mate_y_Ruta.md`, `docs/decisiones.md`, `docs/office_service.md` y `README.md` reflejan el nuevo servicio.
- `deploy/env.sample` y `deploy/.env` incluyen variables `OFFICE_*`.
- `Templates/` agregado como repositorio oficial de plantillas (SLA, Repetitividad), documentado en README y docs.
- Endpoint `POST /reports/repetitividad` disponible en la API; nuevas pruebas y verificación de integridad de plantillas.
- Dockerfile `deploy/docker/repetitividad_worker.Dockerfile` + servicio opcional `repetitividad_worker` (perfil `reports-worker`).
- Bot Telegram actualiza el flujo de repetitividad para reutilizar la API REST y manejar respuestas DOCX/PDF; se añadieron fixtures de integración (`tests/fixtures/repetitividad/*.xlsx`).
- `pytest.ini` configurado para ignorar `Legacy/` en la colección de pruebas.
- `tests/conftest.py` asegura la carga de módulos del repositorio configurando `PYTHONPATH` para la suite.
- `pydantic-settings` agregado (raíz y `office_service/requirements.txt`) para habilitar `BaseSettings` en Pydantic v2.
- Ajuste en `modules/informes_sla/processor.py` para evitar `fillna(..., inplace=True)` y eliminar la advertencia de pandas 3.0.
- Hashing y verificación centralizados en `core/password.py` eliminando Passlib; uso directo de `bcrypt` para web, scripts y pruebas.
- `office_service/app/main.py` migra a manejador `lifespan` para evitar deprecaciones de FastAPI.
- Esquemas Pydantic (`office_service` y `nlp_intent`) actualizados a `ConfigDict`.

## 4. Tareas realizadas y pendientes
- Realizado: creación de la carpeta, clon del repositorio y actualización de documentación relacionada; alta del microservicio LibreOffice con pruebas básicas.
- Pendiente: analizar los módulos del repositorio Sandy y definir plan de migración de flujos; implementar conversión real en `/convert` y definir volúmenes compartidos.

## 5. Criterios de aceptación y validación
- El repositorio debe permanecer limpio al ejecutar `git status` (sin archivos Legacy en staging).
- `pytest tests/test_office_service_health.py` debe pasar (modo UNO deshabilitado).
- `pytest` usa `pytest.ini` para evitar ejecutar suites del repositorio Sandy clonado en `Legacy/`.
- Instalación de `pydantic-settings` pendiente por red restringida; ejecutar `pip install -r requirements.txt` en entorno con acceso.

## 6. Impacto en seguridad y datos
- Sin exposición de servicios ni cambios en credenciales.
- Se mantiene la separación de código legacy para evitar confusiones y fugas accidentales.

## 7. Compatibilidad y migraciones
- No hay migraciones de base de datos ni cambios en esquemas; nueva imagen dockerizada requiere recursos adicionales (LibreOffice 7.4) y actualizar pipelines de CI en próximas iteraciones.

## 8. Evidencia de validación manual
- Validado que `Legacy/` contiene el repositorio Sandy y que `.gitignore` lo excluye del staging.
- Construcción local pendiente hasta contar con recursos (se documenta proceso en `docs/office_service.md`).
- `pytest` ejecutado (25 pruebas) con éxito tras instalar dependencias en el entorno local.
- `pytest tests/test_sla_processor.py -q` validó el cambio de `fillna` en el flujo SLA.
- `pytest tests/test_web_login.py -q` y la suite completa verifican la refactorización de hashing.
- `pytest tests/test_reports_repetitividad_api.py -q` y `tests/test_templates_integrity.py` cubren la nueva API y la integridad de plantillas.

## 9. Próximos pasos
- 1) Revisar estructura del repositorio Sandy (repetitividad, SLA, comparador FO) y mapear qué componentes migrar.
- 2) Definir tareas específicas para adaptar el informe de repetitividad a la arquitectura LAS-FOCAS.
- 3) Implementar la conversión real con UNO, manejo de archivos temporales y validaciones de entrada.
- 4) Instalar dependencias nuevas (`pydantic-settings`) en entornos con red o mirror local (ya añadido al requirements, falta replicarlo en ambientes con red).
- 5) Extender la API `/reports` para SLA y comparador FO y actualizar la UI.
- 6) Implementar cola real y jobs para `repetitividad_worker` utilizando los fixtures generados.
