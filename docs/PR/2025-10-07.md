# Nombre de archivo: 2025-10-07.md
# Ubicación de archivo: docs/PR/2025-10-07.md
# Descripción: Registro diario de cambios y pendientes del 07 de octubre de 2025

## 1. Resumen de cambios
- Añadido endpoint `POST /reports/repetitividad` (API) para generar informes a partir de Excel y devolver DOCX o ZIP (DOCX+PDF).
- Implementado helper asíncrono `modules.informes_repetitividad.service.generate_report` y tests unitarios.
- Incorporadas pruebas de integración para el flujo web de generación de informe de repetitividad (`/api/flows/repetitividad`) y métricas de chat/history.
- Agregado microservicio `office_service/` (FastAPI + LibreOffice UNO headless) con configuración, runner, health endpoint y tests.
- Centralizado hashing de contraseñas en `core/password.py` (uso directo de `bcrypt`).
- Añadidos clasificadores y generador de respuestas fase 2 en `nlp_intent` (action classifier, answer generator, tests nuevos).
- Agregados datos FAQ mínimos (`modules/common/faq_data.py`).
- Añadidos fixtures de Excel para repetitividad y pruebas de integridad de plantillas (`tests/test_templates_integrity.py`).
- Dockerfile worker de repetitividad (`deploy/docker/repetitividad_worker.Dockerfile`) y worker placeholder (`modules/informes_repetitividad/worker.py`).
- Actualizado `pytest.ini` (asegura exclusión de `Legacy/`).
- Documentación del microservicio LibreOffice en `docs/office_service.md`.
 - Documentado endpoint `/reports/repetitividad` en `docs/api.md`.

## 2. Contexto y alcance
Se amplía la plataforma para soportar: (a) generación programática de informes de repetitividad vía API y web, (b) arquitectura futura para conversión de documentos con LibreOffice, (c) enriquecimiento de NLP para clasificación de acciones y respuestas básicas. Cambios abarcan módulos `api`, `web`, `modules/informes_repetitividad`, `nlp_intent`, `office_service`, y test suite. No se alteró esquema de DB (solo lectura/escritura existente de conversaciones). Se añaden dependencias (pydantic-settings, bcrypt ya presente) y contenedores nuevos.

## 3. Cambios realizados (detalle)
- API: nuevo router `api/api_app/routes/reports.py` con validaciones, export DOCX/PDF y empaquetado ZIP.
- Servicio repetitividad: `service.py` para invocar API y persistir outputs.
- Worker: `modules/informes_repetitividad/worker.py` + Dockerfile dedicado (geopandas futuro).
- LibreOffice microservice: paquete completo (`office_service/`) con settings, runner, UNO client, health check.
- Seguridad contraseñas: implementación de `hash_password`, `verify_password`, `needs_rehash` reemplazando passlib (no se detectaron referencias rotas en tests existentes).
- NLP: `action_classifier.py`, `answer_generator.py`, tests complementarios (`test_action_and_answers.py`, `test_intention_pipeline.py`, `test_openai_mock.py`).
- FAQ: base mínima y función `match_faq`.
- Web: pruebas para endpoints de chat (`test_web_chat_history_metrics.py`) y flujo repetitividad (`test_web_repetitividad_flow.py`). Métricas persistidas en `web/data/intent_metrics.json`.
- Web Panel: formulario dedicado (upload xlsx, mes/año, checkbox PDF) y backend validando extensión y tamaño (10MB) con bandera `include_pdf`.
- Tests: cobertura para servicio generate_report, API reports, integridad de plantillas, office_service health.
- Docs: `docs/office_service.md`; PR diario actual.

## 4. Tareas realizadas vs pendientes
Realizado:
- Endpoint /reports con soporte PDF opcional (vía LibreOffice u opción placeholder).
- Microservicio LibreOffice con health y configuración inicial.
- Flujo web y helper asíncrono para repetitividad.
- Clasificador de acción y generador de respuestas básicas (FAQ + heurística + providers pluggables).
- Suite de tests ampliada (unit + integración), plantillas checksum.
Pendiente / TODO:
- Implementar conversión real en `/convert` (office_service) y refinar pipeline PDF (manejar errores de soffice con mayor granularidad).
- Añadir límite configurable (env) e internacionalización mensajes de validación de archivos.
- Integrar cola de trabajos (Redis/Celery/RQ) para worker de mapas.
- Añadir endpoints para SLA y comparador FO en `/reports`.
- Persistir informes generados (metadatos) en DB y exponer listados.
- Mejorar logging estructurado (añadir request_id en API reports).
- Añadir métricas Prometheus (office_service, API). 
- Reforzar rate-limiting y auth en endpoints `/reports` (token/service account).

## 5. Criterios de aceptación y validación
- `/reports/repetitividad` acepta sólo `.xlsx` y responde 400 con extensión inválida (test cubierto).
- Cuando `incluir_pdf=true` y conversión exitosa → ZIP con DOCX+PDF y headers `X-PDF-Requested=true`, `X-PDF-Generated=true`.
- Falla de procesamiento lanza 500 con mensaje (test).
- `generate_report` guarda archivos correctos (docx o zip parsing) y maneja ausencia de Content-Disposition.
- `office_service` health retorna `uno.available=false` si UNO deshabilitado, test validado.
- Hashing bcrypt produce y verifica contraseñas; tests de login previos continúan (ver suite completa).
- Clasificador de acción identifica "repetitividad" con confidence & mapping (tests). Respuestas FAQ devuelven texto esperado.
- Plantillas DOCX coinciden con hash esperado (integridad).
- Tests pasan (`pytest` local). Cobertura > baseline previa (estimado >60% para módulos nuevos; medición precisa pendiente de report).

## 6. Impacto en seguridad y datos
- No se migran esquemas ni se almacenan nuevos datos sensibles.
- Introduce potencial superficie: `/reports/repetitividad` (validar subida de archivos, riesgo de payloads maliciosos en XLSX — pendiente sanitización adicional, contenido no se ejecuta porque se procesa con pandas openpyxl).
- LibreOffice headless requiere endurecer entrada (TOCTOU, path traversal en futuras conversiones) — aún placeholder.
- Contraseñas: truncado seguro a 72 bytes para bcrypt; logs evitan exponer hashes (excepto previews ya existentes: revisar y acotar). Considerar eliminar hash_preview en producción (TODO).

## 7. Compatibilidad y migraciones
- Sin cambios de DB; no se requiere Alembic.
- Nuevas dependencias: `pydantic-settings` (office_service); geopandas/contextily/matplotlib en Dockerfile worker (no instaladas en entorno principal si no se builda esa imagen). Confirmar inclusión en `requirements.txt` raíz si se usan fuera del contenedor especializado (actualmente no).

## 8. Evidencia de validación manual
- Ejecución local de `pytest -q` sin fallos (logs no incluidos aquí; ver pipeline local). 
- Manual: POST a `/reports/repetitividad` con un XLSX sample (3 filas) → docx descargado.
- Con `incluir_pdf=true` (mock de convert_to_pdf) → ZIP correcto.
- Health de office_service: `GET /health` retorna available=false cuando OFFICE_ENABLE_UNO=false.

## 9. Próximos pasos
1. Implementar conversión real `/convert` y robustecer convert_to_pdf (capturar stderr, códigos de salida, reintentos).
2. Autenticación (API key / token interno) para `/reports` y limitar tamaño de archivos.
3. SLA & comparador FO endpoints + plantillas y tests.
4. Persistencia meta-informes (tabla reports) + list & download secure.
5. Métricas Prometheus (contador de informes, latencias, errores).
6. Integrar worker mapas (geopandas) con cola y feature flag.
7. Documentar política de truncado bcrypt en `docs/Seguridad.md` (agregar sección).
8. Evaluar caching/timeout de modelos LLM y fallback structured logging.

## 10. Checklist de validación
- [x] Encabezados 3 líneas en archivos nuevos.
- [x] Tests unitarios y de integración agregados.
- [x] Nuevos endpoints documentados parcialmente (añadir detalle en `docs/api.md` TODO).
- [x] Dependencias fijadas con versiones.
- [x] Sin secrets en repo.
- [ ] Métricas y rate limiting reforzados (TODO).
- [x] Documentación básica endpoint `/reports/repetitividad` (api.md).

---

---

## ACTUALIZACIÓN - Corrección del procesador y generador de informes

### Hora: 14:00-16:30 (sesión tarde)

### Resumen de esta actualización
Diagnóstico y corrección completa del error "Internal Server Error" en el flujo de repetitividad, más mejora del generador de documentos Word para alinearlo con el formato legacy.

### Problema identificado
El sistema fallaba al procesar archivos Excel reales con el error:
```
AttributeError: 'DataFrame' object has no attribute 'str'
```

**Causa raíz**: El mapeo de columnas en `config.py` generaba **columnas duplicadas** en el DataFrame normalizado:
- `'Número Línea'` → `'SERVICIO'`
- `'Tipo Servicio'` → `'SERVICIO'` (duplicado!)
- `'Fecha Inicio Reclamo'` → `'FECHA'`
- `'Fecha Cierre Reclamo'` → `'FECHA'` (duplicado!)

Cuando pandas tiene columnas con nombres duplicados, `df["COLUMNA"]` devuelve un DataFrame en lugar de una Series, causando el fallo en `.str.strip()`.

### Cambios realizados

#### 1. Corrección del procesador (`modules/informes_repetitividad/`)

**config.py**:
- Mapeo diferenciado para evitar duplicados:
  - `'Número Línea'` → `SERVICIO` (ID numérico)
  - `'Tipo Servicio'` → `TIPO_SERVICIO` (descripción)
  - `'Fecha Cierre Reclamo'` → `FECHA`
  - `'Fecha Inicio Reclamo'` → `FECHA_INICIO`
- Documentación de cada mapeo

**processor.py**:
- Función `clean_key()` mejorada:
  - Elimina saltos de línea (`\n`, `\r`) de nombres de columna
  - Normaliza acentos, espacios y guiones bajos
- Lógica de fallback para fechas alternativas
- Logging diagnóstico mejorado

#### 2. Generador de informes enriquecido (`report.py`)

**Cambios principales**:
- Función `_export_detailed_report()`: Genera informe completo al estilo legacy
- Función `_export_simple_table()`: Fallback compatible con API anterior
- Tablas individuales por servicio con 6 columnas:
  1. Número de Reclamo
  2. Tipo de Solución
  3. Fecha Inicio
  4. Fecha Cierre
  5. Horas Netas
  6. Descripción Solución
- Encabezados descriptivos: `Tipo Servicio: ID - Cliente`
- Formato optimizado: fuente 9pt, alineación mejorada

**runner.py**:
- Actualizado para pasar `df_filtered` al generador
- Mantiene referencia a datos originales para detalle enriquecido

#### 3. Infraestructura de desarrollo

**Nueva carpeta `devs/`**:
- Propósito: Recursos locales de desarrollo (Excel raw, informes de ejemplo)
- Estado en Git: Completamente ignorada
- Documentación: `devs/README.md`

**Actualizaciones**:
- `.gitignore`: agregado `devs/`
- `README.md`: documentada la carpeta en el árbol de estructura

### Validación técnica

**Prueba con archivo real** (`devs/Reclamos.xlsx`):
```
✓ Carga: 1,673 registros, 30 columnas
✓ Normalización: sin columnas duplicadas
✓ Filtrado: 224 registros (Nov 2022)
✓ Cálculo: 30 servicios repetitivos de 188 totales (16.0%)
✓ Generación: DOCX de 39.9 KB
✓ Estructura: 62 párrafos, 30 tablas
```

**Contenido del documento**:
```
Informe de Repetitividad — Noviembre 2022
Servicios analizados: 188 | Servicios con repetitividad: 30 (16.0%)

EWS: 105060 - TELEFONICA MOVILES ARGENTINA SA
[Tabla con 2 casos detallados]

EWS: 25814 - CAT TECHNOLOGIES ARGENTINA SA
[Tabla con 2 casos detallados]

[... 28 servicios más ...]
```

### Archivos modificados
- `modules/informes_repetitividad/config.py`
- `modules/informes_repetitividad/processor.py`
- `modules/informes_repetitividad/report.py`
- `modules/informes_repetitividad/runner.py`
- `.gitignore`
- `README.md`
- `devs/README.md` (nuevo)

### Commits
- `00c47a9`: [fix] Corregir procesador de repetitividad y crear carpeta devs/
- `f6986e7`: [feature] Mejorar generador de informes de repetitividad

### Servicios actualizados
```bash
docker compose -f deploy/compose.yml up -d --build api
# ✔ lasfocas-api Built & Started
```

### Próximos pasos de esta actualización
1. Probar desde interfaz web con archivo real
2. Verificar conversión a PDF con `office_service`
3. Implementar extracción de coordenadas y mapas (opcional, basado en legacy)
4. Tests automatizados para casos edge (columnas duplicadas, fechas faltantes)

### Referencias legacy
- Archivo comparado: `Legacy/Sandy/Sandy bot/sandybot/handlers/repetitividad.py`
- Carpeta Legacy marcada como DEPRECATED (solo referencia)
- Lógica migrada: carga de Excel, filtrado por período, generación de tablas

