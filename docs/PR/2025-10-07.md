# Nombre de archivo: 2025-10-07.md
# Ubicación de archivo: docs/PR/2025-10-07.md
# Descripción: Registro diario de cambios y pendientes del 07 de octubre de 2025

## 1. Resumen de cambios
- Añadido endpoint `POST /reports/repetitividad` (API) para generar informes a partir de Excel y devolver DOCX o ZIP (DOCX+PDF).
- Reestructurado informe de repetitividad: período decorativo (sin filtrado), soporte de columnas GEO configurables, generación de mapa Folium y enriquecimiento del DOCX con resumen geográfico.
- Implementado helper asíncrono `modules.informes_repetitividad.service.generate_report` y tests unitarios.
- Incorporadas pruebas de integración para el flujo web de generación de informe de repetitividad (`/api/flows/repetitividad`) y métricas de chat/history.
- Agregado microservicio `office_service/` (FastAPI + LibreOffice UNO headless) con configuración, runner, health endpoint y tests.
- Centralizado hashing de contraseñas en `core/password.py` (uso directo de `bcrypt`).
- Añadidos clasificadores y generador de respuestas fase 2 en `nlp_intent` (action classifier, answer generator, tests nuevos).
- Agregados datos FAQ mínimos (`modules/common/faq_data.py`).
- Añadidos fixtures de Excel para repetitividad y pruebas de integridad de plantillas (`tests/test_templates_integrity.py`).
- Dockerfile worker de repetitividad (`deploy/docker/repetitividad_worker.Dockerfile`) y worker placeholder (`modules/informes_repetitividad/worker.py`).
- Actualizado `pytest.ini` (asegura exclusión de `Legacy/`).
- Documentación del microservicio LibreOffice en `docs/office_service.md`.
 - Documentado endpoint `/reports/repetitividad` en `docs/api.md`.

## 2. Contexto y alcance
Se amplía la plataforma para soportar: (a) generación programática de informes de repetitividad vía API y web, (b) arquitectura futura para conversión de documentos con LibreOffice, (c) enriquecimiento de NLP para clasificación de acciones y respuestas básicas. Cambios abarcan módulos `api`, `web`, `modules/informes_repetitividad`, `nlp_intent`, `office_service`, y test suite. No se alteró esquema de DB (solo lectura/escritura existente de conversaciones). Se añaden dependencias (pydantic-settings, bcrypt ya presente) y contenedores nuevos.

## 3. Cambios realizados (detalle)
- API: nuevo router `api/api_app/routes/reports.py` con validaciones, export DOCX/PDF y empaquetado ZIP.
- Servicio repetitividad: `service.py` para invocar API y persistir outputs.
- Worker: `modules/informes_repetitividad/worker.py` + Dockerfile dedicado (geopandas futuro).
- LibreOffice microservice: paquete completo (`office_service/`) con settings, runner, UNO client, health check.
- Seguridad contraseñas: implementación de `hash_password`, `verify_password`, `needs_rehash` reemplazando passlib (no se detectaron referencias rotas en tests existentes).
- NLP: `action_classifier.py`, `answer_generator.py`, tests complementarios (`test_action_and_answers.py`, `test_intention_pipeline.py`, `test_openai_mock.py`).
- FAQ: base mínima y función `match_faq`.
- Web: pruebas para endpoints de chat (`test_web_chat_history_metrics.py`) y flujo repetitividad (`test_web_repetitividad_flow.py`). Métricas persistidas en `web/data/intent_metrics.json`.
- Web Panel: formulario dedicado (upload xlsx, mes/año, checkbox PDF) y backend validando extensión y tamaño (10MB) con bandera `include_pdf`.
- Tests: cobertura para servicio generate_report, API reports, integridad de plantillas, office_service health.
- Docs: `docs/office_service.md`; PR diario actual.

## 4. Tareas realizadas vs pendientes
Realizado:
- Endpoint /reports con soporte PDF opcional (vía LibreOffice u opción placeholder).
- Microservicio LibreOffice con health y configuración inicial.
- Flujo web y helper asíncrono para repetitividad.
- Clasificador de acción y generador de respuestas básicas (FAQ + heurística + providers pluggables).
- Suite de tests ampliada (unit + integración), plantillas checksum.
Pendiente / TODO:
- Implementar conversión real en `/convert` (office_service) y refinar pipeline PDF (manejar errores de soffice con mayor granularidad).
- Añadir límite configurable (env) e internacionalización mensajes de validación de archivos.
- Integrar cola de trabajos (Redis/Celery/RQ) para worker de mapas.
- Añadir endpoints para SLA y comparador FO en `/reports`.
- Persistir informes generados (metadatos) en DB y exponer listados.
- Mejorar logging estructurado (añadir request_id en API reports).
- Añadir métricas Prometheus (office_service, API). 
- Reforzar rate-limiting y auth en endpoints `/reports` (token/service account).

## 5. Criterios de aceptación y validación
- `/reports/repetitividad` acepta sólo `.xlsx` y responde 400 con extensión inválida (test cubierto).
- Cuando `incluir_pdf=true` y conversión exitosa → ZIP con DOCX+PDF y headers `X-PDF-Requested=true`, `X-PDF-Generated=true`.
- Falla de procesamiento lanza 500 con mensaje (test).
- `generate_report` guarda archivos correctos (docx o zip parsing) y maneja ausencia de Content-Disposition.
- `office_service` health retorna `uno.available=false` si UNO deshabilitado, test validado.
- Hashing bcrypt produce y verifica contraseñas; tests de login previos continúan (ver suite completa).
- Clasificador de acción identifica "repetitividad" con confidence & mapping (tests). Respuestas FAQ devuelven texto esperado.
- Plantillas DOCX coinciden con hash esperado (integridad).
- Tests pasan (`pytest` local). Cobertura > baseline previa (estimado >60% para módulos nuevos; medición precisa pendiente de report).

## 6. Impacto en seguridad y datos
- No se migran esquemas ni se almacenan nuevos datos sensibles.
- Introduce potencial superficie: `/reports/repetitividad` (validar subida de archivos, riesgo de payloads maliciosos en XLSX — pendiente sanitización adicional, contenido no se ejecuta porque se procesa con pandas openpyxl).
- LibreOffice headless requiere endurecer entrada (TOCTOU, path traversal en futuras conversiones) — aún placeholder.
- Contraseñas: truncado seguro a 72 bytes para bcrypt; logs evitan exponer hashes (excepto previews ya existentes: revisar y acotar). Considerar eliminar hash_preview en producción (TODO).

## 7. Compatibilidad y migraciones
- Sin cambios de DB; no se requiere Alembic.
- Nuevas dependencias: `pydantic-settings` (office_service); geopandas/contextily/matplotlib en Dockerfile worker (no instaladas en entorno principal si no se builda esa imagen). Confirmar inclusión en `requirements.txt` raíz si se usan fuera del contenedor especializado (actualmente no).

## 8. Evidencia de validación manual
- Ejecución local de `pytest -q` sin fallos (logs no incluidos aquí; ver pipeline local). 
- Manual: POST a `/reports/repetitividad` con un XLSX sample (3 filas) → docx descargado.
- Con `incluir_pdf=true` (mock de convert_to_pdf) → ZIP correcto.
- Health de office_service: `GET /health` retorna available=false cuando OFFICE_ENABLE_UNO=false.

## 9. Próximos pasos
1. Implementar conversión real `/convert` y robustecer convert_to_pdf (capturar stderr, códigos de salida, reintentos).
2. Autenticación (API key / token interno) para `/reports` y limitar tamaño de archivos.
3. SLA & comparador FO endpoints + plantillas y tests.
4. Persistencia meta-informes (tabla reports) + list & download secure.
5. Métricas Prometheus (contador de informes, latencias, errores).
6. Integrar worker mapas (geopandas) con cola y feature flag.
7. Documentar política de truncado bcrypt en `docs/Seguridad.md` (agregar sección).
8. Evaluar caching/timeout de modelos LLM y fallback structured logging.

## 10. Checklist de validación
- [x] Encabezados 3 líneas en archivos nuevos.
- [x] Tests unitarios y de integración agregados.
- [x] Nuevos endpoints documentados parcialmente (añadir detalle en `docs/api.md` TODO).
- [x] Dependencias fijadas con versiones.
- [x] Sin secrets en repo.
- [ ] Métricas y rate limiting reforzados (TODO).
- [x] Documentación básica endpoint `/reports/repetitividad` (api.md).

---

---

## ACTUALIZACIÓN - Corrección del procesador y generador de informes

### Hora: 14:00-16:30 (sesión tarde)

### Resumen de esta actualización
Diagnóstico y corrección completa del error "Internal Server Error" en el flujo de repetitividad, más mejora del generador de documentos Word para alinearlo con el formato legacy.

### Problema identificado
El sistema fallaba al procesar archivos Excel reales con el error:
```
AttributeError: 'DataFrame' object has no attribute 'str'
```

**Causa raíz**: El mapeo de columnas en `config.py` generaba **columnas duplicadas** en el DataFrame normalizado:
- `'Número Línea'` → `'SERVICIO'`
- `'Tipo Servicio'` → `'SERVICIO'` (duplicado!)
- `'Fecha Inicio Reclamo'` → `'FECHA'`
- `'Fecha Cierre Reclamo'` → `'FECHA'` (duplicado!)

Cuando pandas tiene columnas con nombres duplicados, `df["COLUMNA"]` devuelve un DataFrame en lugar de una Series, causando el fallo en `.str.strip()`.

### Cambios realizados

#### 1. Corrección del procesador (`modules/informes_repetitividad/`)

**config.py**:
- Mapeo diferenciado para evitar duplicados:
  - `'Número Línea'` → `SERVICIO` (ID numérico)
  - `'Tipo Servicio'` → `TIPO_SERVICIO` (descripción)
  - `'Fecha Cierre Reclamo'` → `FECHA`
  - `'Fecha Inicio Reclamo'` → `FECHA_INICIO`
- Documentación de cada mapeo

**processor.py**:
- Función `clean_key()` mejorada:
  - Elimina saltos de línea (`\n`, `\r`) de nombres de columna
  - Normaliza acentos, espacios y guiones bajos
- Lógica de fallback para fechas alternativas
- Logging diagnóstico mejorado

#### 2. Generador de informes enriquecido (`report.py`)

**Cambios principales**:
- Función `_export_detailed_report()`: Genera informe completo al estilo legacy
- Función `_export_simple_table()`: Fallback compatible con API anterior
- Tablas individuales por servicio con 6 columnas:
  1. Número de Reclamo
  2. Tipo de Solución
  3. Fecha Inicio
  4. Fecha Cierre
  5. Horas Netas
  6. Descripción Solución
- Encabezados descriptivos: `Tipo Servicio: ID - Cliente`
- Formato optimizado: fuente 9pt, alineación mejorada

**runner.py**:
- Actualizado para pasar `df_filtered` al generador
- Mantiene referencia a datos originales para detalle enriquecido

#### 3. Infraestructura de desarrollo

**Nueva carpeta `devs/`**:
- Propósito: Recursos locales de desarrollo (Excel raw, informes de ejemplo)
- Estado en Git: Completamente ignorada
- Documentación: `devs/README.md`

**Actualizaciones**:
- `.gitignore`: agregado `devs/`
- `README.md`: documentada la carpeta en el árbol de estructura

### Validación técnica

**Prueba con archivo real** (`devs/Reclamos.xlsx`):
```
✓ Carga: 1,673 registros, 30 columnas
✓ Normalización: sin columnas duplicadas
✓ Filtrado: 224 registros (Nov 2022)
✓ Cálculo: 30 servicios repetitivos de 188 totales (16.0%)
✓ Generación: DOCX de 39.9 KB
✓ Estructura: 62 párrafos, 30 tablas
```

**Contenido del documento**:
```
Informe de Repetitividad — Noviembre 2022
Servicios analizados: 188 | Servicios con repetitividad: 30 (16.0%)

EWS: 105060 - TELEFONICA MOVILES ARGENTINA SA
[Tabla con 2 casos detallados]

EWS: 25814 - CAT TECHNOLOGIES ARGENTINA SA
[Tabla con 2 casos detallados]

[... 28 servicios más ...]
```

### Archivos modificados
- `modules/informes_repetitividad/config.py`
- `modules/informes_repetitividad/processor.py`
- `modules/informes_repetitividad/report.py`
- `modules/informes_repetitividad/runner.py`
- `.gitignore`
- `README.md`
- `devs/README.md` (nuevo)

### Commits
- `00c47a9`: [fix] Corregir procesador de repetitividad y crear carpeta devs/
- `f6986e7`: [feature] Mejorar generador de informes de repetitividad

### Servicios actualizados
```bash
docker compose -f deploy/compose.yml up -d --build api
# ✔ lasfocas-api Built & Started
```

### Próximos pasos de esta actualización
1. Probar desde interfaz web con archivo real
2. Verificar conversión a PDF con `office_service`
3. Implementar extracción de coordenadas y mapas (opcional, basado en legacy)
4. Tests automatizados para casos edge (columnas duplicadas, fechas faltantes)

### Referencias legacy
- Archivo comparado: `Legacy/Sandy/Sandy bot/sandybot/handlers/repetitividad.py`
- Carpeta Legacy marcada como DEPRECATED (solo referencia)
- Lógica migrada: carga de Excel, filtrado por período, generación de tablas

## ACTUALIZACIÓN - Validación FECHA y rediseño del front (17:30-19:00)

### Contexto
- Errores repro en logs (`File is not a zip file` + respuesta 422 "Archivo inválido") al subir planillas generadas por operaciones.
- Front legacy mostraba resultados mínimos y no exponía el nuevo mapa GEO.

### Cambios aplicados
1. **Normalización robusta de fechas**
  - `modules/informes_repetitividad/processor.normalize` ahora acepta `FECHA`, `FECHA_CIERRE_PROBLEMA` o `FECHA_INICIO` sin exigir la columna principal antes del fallback.
  - Se crea `fecha_source_col` para registrar el origen y se consolida en `FECHA` antes de validar columnas obligatorias.
  - Logging indica la columna tomada como fuente.
  - Nuevo test unitario `test_normalize_acepta_fecha_cierre_problema` asegura compatibilidad con planillas reales.

2. **Validación manual con planilla real**
  - Ejecución ad-hoc usando `devs/Reclamos Nuevo.xlsx`: normaliza 152 filas, genera períodos `2025-09` y `2025-10`, 25 servicios repetitivos.

3. **Front web rearmado para Repetitividad**
  - `web/templates/index.html` reorganizado en tarjetas: resumen de informes, flujos adicionales y chat.
  - Panel de resultados persistentes (`#rep-summary`) con estados (info/success/error) y lectura rápida del período.
  - Embebido de mapa en `iframe` (`#rep-map-preview`) cuando el servicio devuelve HTML.
  - Formulario general SLA/FO actualizado con validaciones visuales y mensajes amigables.
  - Botón "Ver panel" en topbar que hace scroll a la tarjeta principal.

4. **Estilos actualizados**
  - `web/static/styles.css` incorpora grilla responsive, tarjetas, badges, estados de resultado y estilos para el iframe.

### Validación
- Suite específica: `PYTHONPATH=api python3 -m pytest tests/test_repetitividad_processor.py tests/test_reports_repetitividad_api.py tests/test_web_repetitividad_flow.py` → **14 tests OK (8.25s)**.
- Prueba manual de normalización con planilla en `devs/` → sin excepciones, resultados consistentes.

### Archivos tocados en esta iteración
- `modules/informes_repetitividad/processor.py`
- `tests/test_repetitividad_processor.py`
- `web/templates/index.html`
- `web/static/styles.css`

### Riesgos y pendientes inmediatos
- Confirmar que `map_html` embebido respeta CSP / headers cuando se despliegue detrás de proxy.
- Ajustar mensajes para caso sin mapa (actualmente se oculta contenedor, OK) y evaluar mini preview en Telegram.
- Revisar si conviene destacar botón "Modo oscuro" (placeholder) o reemplazar por métricas en topbar (TODO UX).

## ACTUALIZACIÓN - Validación de archivos y conteo de reclamos (19:30-20:30)

### Motivación
- Reproducción constante del warning `File is not a zip file` en `web.log` al subir planillas correctas.
- Informes DOCX vacíos cuando los servicios repetían un mismo `Número Reclamo` duplicado en origen.

### Cambios
1. **Sanidad temprana del archivo**
  - `modules/informes_repetitividad/processor.load_excel` verifica la firma ZIP antes de invocar `openpyxl` y devuelve `ValueError` claro cuando el contenido no es un `.xlsx`.
  - `/reports/repetitividad` transforma esos errores en 422 (`Archivo inválido...`) preservando el detalle.
  - Web `flow_repetitividad` corta la ejecución y responde 400 sin llamar a la API cuando el archivo no supera la validación (evita ruido en logs y requests inútiles).

2. **Conteo por reclamos únicos**
  - `compute_repetitividad` usa `nunique` sobre `ID_SERVICIO`; únicamente se considera repetitivo si existen al menos dos reclamos distintos por servicio.
  - Los detalles enviados al DOCX eliminan duplicados y se limpian con `strip()`.
  - Logging adicional reporta el top 5 de servicios con más reclamos para depuración en campo.

3. **Pruebas reforzadas**
  - Nuevos tests unitarios cubren: fechas con `FECHA_CIERRE_PROBLEMA`, descarte de duplicados (`R1` repetido) y rechazo de archivos no ZIP.
  - Casos web ajustados: subida con XLSX real generado en memoria y verificación explícita del error 400 para archivos corruptos.

### Validación
- `PYTHONPATH=api python3 -m pytest tests/test_repetitividad_processor.py tests/test_reports_repetitividad_api.py tests/test_web_repetitividad_flow.py` → **17 pruebas OK (8.96s)**.
- Ejecución manual con `devs/Reclamos Nuevo.xlsx`: 25 servicios repetitivos, IDs únicos en cada listado.

### Impacto y pendientes
- Usuarios reciben feedback inmediato si suben un DOCX/zip incorrecto; se evita inundar la API con requests inválidos.
- Conteos alineados con el criterio “2+ Reclamos distintos por Número Línea”.
- Pendiente: soporte opcional para planillas `.xls` (Excel 97-2003); evaluar `xlrd`/`pyxlsb` según demanda.
- Se añadió fallback automático a `Templates/Plantilla_Informe_Repetitividad.docx` del repo cuando no se define `TEMPLATES_DIR`, evitando errores locales.
- El Dockerfile de la API ahora empaqueta `Templates/` dentro de la imagen para que los contenedores usen siempre la plantilla oficial.


## ACTUALIZACIÓN - Chat del panel conectado a MCP (20:30-22:30)

### Resumen
- Implementado WebSocket `/ws/chat` con autenticación de sesión, streaming y reconexión automática en el panel.
- Orquestador `core/chatbot/orchestrator.py` con persistencia en PostgreSQL mediante tablas nuevas (`app.chat_sessions`, `app.chat_messages`).
- Registro MCP (`core/mcp/registry.py`) con herramientas iniciales (repetitividad, mapa geo, conversión Doc→PDF, comparador FO placeholder, Notion placeholder).
- Endpoint `POST /api/chat/uploads` para adjuntos y `POST /mcp/invoke` para pruebas manuales.
- Frontend actualizado (template + Vite) mostrando historial, estado de conexión y resultados de herramientas.
- Documentación en `docs/chatbot.md` y `docs/mcp.md`, más pruebas unitarias (`tests/test_chat_orchestrator.py`, `tests/test_mcp_registry.py`).

### Cambios principales
- Nuevo paquete `core/chatbot/` (orquestador + storage in-memory/DB) y paquete `core/mcp/` (registro y herramientas MCP).
- Configuración Alembic (`db/alembic`) y migración `20251007_01_chat_tables.py`; agregado DDL equivalente a `db/init.sql`.
- `web/chat_ws.py` monta el WS y reutiliza `DatabaseChatStorage`; `web/web_app/main.py` incluye endpoints HTTP adicionales y carga del WS.
- `web/templates/index.html`, `web/static/styles.css` y `web/frontend/src/main.ts` migrados a cliente WebSocket con streaming.
- `requirements.txt` incorpora `alembic==1.13.2`.

### Validación
- `pytest -k "chat_orchestrator or mcp_registry"` (local) ✅.
- Verificación manual del panel: al abrir la página el estado cambia a “Conectado” y los mensajes “hola” reciben respuesta base, eliminando el error “Ocurrió un error al enviar el mensaje”.
- Tool-call manual (`/repetitividad`) genera eventos de streaming y registra la solicitud en DB (sin ejecutar reporte hasta adjuntar archivo válido).

### Riesgos / pendientes
- Completar implementación real de `CompararTrazasFO`, `ConvertirDocAPdf` (dependencia de `office_service`) y `RegistrarEnNotion`.
- Añadir rate limiting específico para WebSocket y métricas Prometheus.
- Diseñar políticas de expiración/borrado para archivos subidos a `/api/chat/uploads`.
- Exponer healthcheck del WS en documentación (`/docs/web.md`).

### Evidencia complementaria
- Logs `web.log`: `action=chat_ws_connected` y `action=mcp_tool_call` registrados con duración promedio < 5 ms (dummy handler).
- Migración Alembic aplicada en entorno local (`alembic -c db/alembic.ini upgrade head`).


