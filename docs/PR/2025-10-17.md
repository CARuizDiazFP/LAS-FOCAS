# Nombre de archivo: 2025-10-17.md
# Ubicación de archivo: docs/PR/2025-10-17.md
# Descripción: Nota de PR diario del 2025-10-17 (documentación dependencias geoespaciales)

# PR — 2025-10-17

## Resumen de cambios
- Backend/UI Repetitividad: la portada del DOCX es dinámica, se elimina el flujo de mapa interactivo (iframe/link "Mapa principal") y se insertan mapas PNG por servicio sólo cuando existen coordenadas válidas, escalados a media hoja A4.
- Pipeline de datos: Horas Netas se normalizan como minutos (`HORAS_NETAS_MIN`) y se renderizan en formato `HH:MM` en tablas DOCX y en las salidas de API/web.
- Core: nuevo módulo `core/docx_utils/text_replace.py` para reemplazos profundos (cuerpo, encabezados, shapes, DrawingML), utilitario `core/utils/timefmt.py` y refactor de `core/maps/static_map.py` con estilo tipo Google sin ejes.
- Pruebas y documentación: suite ampliada con `test_docx_utils.py`, `test_static_map.py`, `test_repetitividad_docx_render.py`, `test_timefmt.py`, `test_ingest_parser.py`; documentación actualizada (`README.md`, `docs/api.md`, `docs/web.md`, `docs/informes/repetitividad.md`, `docs/Mate_y_Ruta.md`).

## Contexto y alcance
- Objetivo: entregar informe de Repetitividad sin placeholders ni vínculos HTML, reemplazando mapas interactivos por PNG estáticos y alineando la UI con el nuevo flujo de descarga.
- Objetivo extendido: normalizar la columna Horas Netas para mostrarla consistente en HH:MM tanto en el DOCX como en respuestas API/Web y evitar discrepancias con datos Excel/DB.
- Documentación: reflejar en los documentos vivos la incorporación de librerías geoespaciales y del nuevo utilitario de tiempos, incluyendo ejemplos en README, `docs/api.md`, `docs/web.md`, `docs/informes/repetitividad.md` y plan `Mate_y_Ruta`.
- Alcance: backend de informes, utilidades core (`docx_utils`, `timefmt`, parsers), UI Web (templates + JS + estilos) y documentación estratégica.

## Cambios realizados
- Backend y generación de informes
  - `modules/informes_repetitividad/report.py`: usa `replace_text_everywhere`, elimina columnas Lat/Lon, formatea Horas Netas como `HH:MM` y embebe PNG por servicio manteniendo compatibilidad con `generate_service_maps`.
  - `modules/informes_repetitividad/processor.py`: deriva `HORAS_NETAS_MIN` en minutos enteros, sanea datos GEO y expone helpers usados tanto por Excel como por DB.
  - `core/utils/timefmt.py`: nuevo utilitario centralizado para convertir duraciones (`HH:MM`, decimales, `timedelta`) a minutos y viceversa.
  - `core/parsers/reclamos_excel.py`: integra `value_to_minutes`, guarda minutos como `Int64` y filtra valores negativos fuera de rango.
  - `core/docx_utils/text_replace.py`: utilitario para reemplazar texto en cuerpo, encabezados y shapes (incluye DrawingML `a:t`).
  - `core/maps/static_map.py`: refactor a tiles callejeros (`CartoDB.Voyager` por defecto), sin ejes, padding configurable y fallback scatter.
- UI Web
  - `web/templates/panel.html`, `web/static/panel.js`, `web/static/styles.css`: se remueve el contenedor de iframe y referencias a "Mapa principal"; los resultados muestran sólo enlaces a DOCX/PDF/PNG.
  - `web/templates/index.html`: se alinea el template legacy con los mismos cambios (sin iframe ni links interactivos, conserva sumario y links a PNG).
- Pruebas y docs
  - Nuevas pruebas: `tests/test_docx_utils.py`, `tests/test_static_map.py`, `tests/test_repetitividad_docx_render.py`, `tests/test_timefmt.py`, `tests/test_ingest_parser.py`.
  - Documentación actualizada: `README.md`, `docs/api.md`, `docs/web.md`, `docs/informes/repetitividad.md`, `docs/Mate_y_Ruta.md`.

## Tareas realizadas y pendientes
- Realizado: portada dinámica, generación de PNG por servicio sin HTML, limpieza de UI (panel.js/index), normalización de Horas Netas (`HH:MM`), refuerzo del parser y actualización integral de documentación (README, API, Web, informes, plan).
- Pendiente: validar con un Excel real/DB productivo la nueva columna `HORAS_NETAS_MIN` y ajustar documentación Legacy si persisten referencias al iframe.

## Criterios de aceptación
- El DOCX final reemplaza cualquier aparición de "Informe Repetitividad Mes Año" (incluyendo shapes) por el título dinámico "Informe Repetitividad — <Mes> <Año>".
- El informe no genera enlaces "Mapa interactivo" ni `iframe`; sólo adjunta PNGs cuando `with_geo=true` y hay coordenadas válidas.
- La UI web (panel/index) muestra únicamente enlaces directos a DOCX/PDF/PNG sin contenedores interactivos.
- Las tablas del informe muestran Horas Netas en formato `HH:MM` derivadas de minutos enteros.
- Documentación actualizada (`README.md`, `docs/api.md`, `docs/web.md`, `docs/informes/repetitividad.md`, `docs/Mate_y_Ruta.md`).

## Impacto en seguridad y datos
- Sin impacto directo adicional: se eliminan superficies HTML/iframe, se mantienen descargas autenticadas y se documenta el monitoreo del toolchain geoespacial. No se exponen secretos ni se cambian permisos.
- La normalización de Horas Netas ocurre en memoria y preserva los mismos campos de salida; no se registran valores crudos en logs.

## Compatibilidad y migraciones
- Endpoints y contratos (`/reports/repetitividad`, `/api/flows/repetitividad`) mantienen parámetros y headers; sólo se ajustan activos retornados (PNG estáticos) y formato de Horas Netas (`HH:MM`) ya cubiertos por tests.
- Sin migraciones de base de datos ni cambios en Dockerfiles; la nueva columna `HORAS_NETAS_MIN` se deriva en memoria sin alterar esquemas existentes.

## Evidencia de validación manual
- Verificación manual del DOCX generado con plantilla real (sustitución en portada y ausencia de links interactivos).
- Navegación UI panel/index para confirmar ausencia de iframe y presencia de enlaces PNG.
- `.venv/bin/python -m pytest tests/test_timefmt.py tests/test_docx_utils.py tests/test_repetitividad_docx_render.py tests/test_ingest_parser.py`.

## Próximos pasos
- Validar el pipeline con datasets reales (Excel y DB) para confirmar la consistencia de `HORAS_NETAS_MIN` y detección de servicios sin horas netas.
- Auditar plantillas DOCX restantes por si contienen placeholders similares y aplicar `replace_title_everywhere` cuando corresponda.
- Extender cobertura a flujos Telegram (tests aiogram) y escenarios de límite de tamaño en `/reports/repetitividad`.
