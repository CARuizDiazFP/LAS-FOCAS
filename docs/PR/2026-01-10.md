# Nombre de archivo: 2026-01-10.md
# Ubicaci√≥n de archivo: docs/PR/2026-01-10.md
# Descripci√≥n: PR diario - Tags coloreados por ruta, modal de tracking, fix UniqueViolation

# PR 2026-01-10: Tags de Ruta Coloreados + Modal de Tracking

## Resumen de Cambios

1. Correcci√≥n del modelo `RutaServicio` para alinear con estructura de BD
2. Migraci√≥n exitosa de 28 servicios legacy al nuevo modelo de rutas
3. **Nuevo flujo de upload de tracking** con modal de conflicto (2 pasos: analyze ‚Üí resolve)
4. **Nuevo endpoint** para eliminar asociaciones servicio-empalmes
5. **üî¥ Fix UniqueViolation**: Prevenci√≥n de duplicados en `ruta_empalme_association`
6. **üè∑Ô∏è Tags coloreados por tipo de ruta**: Visualizaci√≥n clara de servicios en c√°maras
7. **üìã Modal de detalle de tracking**: Click en tag ‚Üí ver recorrido completo
8. **üîç Smart-search con rutas**: Incluye info de rutas en resultados

## Contexto y Alcance

- **M√≥dulos afectados**: 
  - `db/models/infra.py` - Correcci√≥n de tipos de columna
  - `core/services/infra_service.py` - Uso de contenido_original
  - `web/static/panel.js` - Nuevo flujo con modal
  - `web/templates/panel.html` - Modal de conflicto HTML
  - `web/static/styles.css` - Estilos del modal
  - `api/api_app/routes/infra.py` - Endpoint DELETE empalmes

## Cambios Realizados

### 1. Modelo `db/models/infra.py`

- `raw_tracking_data` (JSON) ‚Üí `contenido_original` (Text)
- `activa` (Integer) ‚Üí `activa` (Boolean)
- `nombre` (String 128) ‚Üí `nombre` (String 255)

### 2. Nuevo Flujo de Upload (Frontend)

El flujo ahora es de **2 pasos**:

1. **Analyze**: `POST /api/infra/trackings/analyze`
   - Parsea el archivo
   - Detecta si el servicio existe y si hay diferencias
   - Retorna `suggested_action`: CREATE_NEW, REPLACE, BRANCH, NO_CHANGES

2. **Si hay conflicto** ‚Üí Muestra modal con opciones:
   - üîÑ **Reemplazar**: Actualizar ruta principal con nuevo tracking
   - üåø **Crear Backup**: Guardar como ruta alternativa/backup
   - ‚è≠Ô∏è **Omitir**: No hacer cambios

3. **Resolve**: `POST /api/infra/trackings/resolve`
   - Ejecuta la acci√≥n elegida por el usuario
   - Para BRANCH permite especificar nombre y tipo de ruta

### 3. Nuevo Endpoint: Eliminar Asociaciones

```
DELETE /api/infra/servicios/{servicio_id}/empalmes
```

Elimina todas las asociaciones empalmes de un servicio:
- Limpia `servicio_empalme_association` (legacy)
- Elimina `rutas_servicio` + `ruta_empalme_association`

√ötil para:
- Reiniciar un servicio antes de volver a asociar
- Corregir datos err√≥neos
- Pruebas de desarrollo

### 4. Modal de Conflicto

Nuevo modal en el panel de infraestructura que muestra:
- Informaci√≥n del archivo subido (nombre, servicio, empalmes)
- Informaci√≥n de la ruta existente
- 3 opciones de acci√≥n
- Input para nombre de ruta (solo para BRANCH)

## Respuestas a Preguntas del Usuario

### ¬øD√≥nde se guardan los trackings?

| Modelo | Tabla | Columna | Tipo |
|--------|-------|---------|------|
| Nuevo | `app.rutas_servicio` | `contenido_original` | TEXT (JSON serializado) |
| Legacy | `app.servicios` | `raw_tracking_data` | JSONB |

El modelo nuevo guarda el tracking completo parseado en `contenido_original` de cada ruta.

### ¬øC√≥mo eliminar asociaciones?

```bash
# V√≠a API
curl -X DELETE "http://localhost:8001/api/infra/servicios/52547/empalmes"

# Respuesta
{
  "status": "ok",
  "servicio_id": "52547",
  "message": "Eliminadas 102 asociaciones legacy y 0 rutas",
  "empalmes_legacy_eliminados": 102,
  "rutas_eliminadas": 0
}
```

## Migraci√≥n de Datos Legacy

```
Servicios procesados:    28
Rutas creadas:           28
Empalmes migrados:       1702
Errores:                 0
```

---

## üÜï Nuevas Funcionalidades (Sesi√≥n 2)

### 5. Fix UniqueViolation en Upload de Tracking

**Problema:** Al subir un tracking, se produc√≠a error `duplicate key value violates unique constraint "ruta_empalme_association_pkey"`.

**Causa ra√≠z:** Los archivos de tracking pueden tener empalmes duplicados (mismo empalme en diferentes topolog√≠as/caminos). Al iterar las filas, se intentaba insertar el mismo `(ruta_id, empalme_id)` m√∫ltiples veces.

**Soluci√≥n:** Agregar tracking de empalmes ya insertados con `empalmes_asociados: set[int]` en los 3 m√©todos de acci√≥n:
- `_action_create_new()`
- `_action_replace()`
- `_action_branch()`

```python
# Antes de insertar, verificar si ya existe
if empalme.id not in empalmes_asociados:
    stmt = ruta_empalme_association.insert().values(...)
    session.execute(stmt)
    empalmes_asociados.add(empalme.id)
```

### 6. Tags de Servicio Coloreados por Tipo de Ruta

Nueva visualizaci√≥n en tarjetas de c√°maras: **tags coloreados** que indican los servicios y su tipo de ruta.

**Paleta de colores:**
| Tipo de Ruta | Color | Hex |
|--------------|-------|-----|
| Principal | Azul | `#3b82f6` |
| Backup/Camino 2 | Verde | `#37BC7D` |
| Alternativa/Camino 3 | Naranja | `#F54927` |
| Camino 4+ | Rosa | `#E61876` |

**Comportamiento:**
- Una c√°mara puede mostrar **m√∫ltiples tags** si pertenece a varias rutas
- Cada tag es **clickeable** ‚Üí abre modal de detalle

### 7. Modal de Detalle de Tracking

Al hacer click en un tag de servicio, se abre un modal que muestra:
- Nombre del servicio y tipo de ruta
- **Secuencia completa del tracking**: c√°maras y cables en orden
- Iconos visuales: üìç para c√°maras, üîó para cables

**Nuevo endpoint:**
```
GET /api/infra/rutas/{ruta_id}/tracking
```

Respuesta:
```json
{
  "ruta_id": 30,
  "nombre": "Ruta Principal - 52547",
  "tipo": "PRINCIPAL",
  "servicio_id": "52547",
  "tracking": [
    {"tipo": "CAMARA", "nombre": "CAM-001", "fontine_id": "TF-12345"},
    {"tipo": "CABLE", "nombre": "Cable 150m"},
    {"tipo": "CAMARA", "nombre": "CAM-002", "fontine_id": "TF-12346"},
    ...
  ]
}
```

### 8. Smart-Search con Info de Rutas

El endpoint `POST /api/infra/smart-search` ahora incluye `rutas` en cada c√°mara:

```json
{
  "id": 1234,
  "nombre": "CAM-001",
  "rutas": [
    {"ruta_id": 30, "servicio_id": "52547", "ruta_nombre": "Ruta Principal", "ruta_tipo": "PRINCIPAL"},
    {"ruta_id": 31, "servicio_id": "52547", "ruta_nombre": "Backup Oeste", "ruta_tipo": "BACKUP"}
  ]
}
```

---

## Archivos Modificados

**Backend:**
- `db/models/infra.py` - Alineaci√≥n de tipos
- `core/services/infra_service.py` - Fix duplicados + json.dumps
- `web/web_app/main.py` - Endpoints rutas, tracking detail, smart-search con rutas
- `api/api_app/routes/infra.py` - Endpoint DELETE empalmes

**Frontend:**
- `web/static/panel.js` - Tags coloreados, modal tracking, RUTA_COLORS
- `web/static/styles.css` - Estilos modal, tags con colores
- `web/templates/panel.html` - Modal de conflicto HTML

**Scripts y Migraci√≥n:**
- `scripts/migrate_legacy_rutas.py` - Migraci√≥n legacy ejecutada
- `db/alembic/versions/20260110_01_ruta_servicio.py` - Migraci√≥n DB

**Tests:**
- `tests/test_ruta_servicio.py` - Tests del modelo RutaServicio

## Validaci√≥n

- ‚úÖ Upload de tracking sin errores de duplicados
- ‚úÖ Tags muestran colores correctos por tipo
- ‚úÖ Click en tag abre modal con tracking
- ‚úÖ Smart-search retorna info de rutas
- ‚úÖ Servicio 52547 muestra 2 tags (Principal azul, Backup verde)

## Pr√≥ximos Pasos

- Implementar filtro por tipo de ruta en smart-search
- Agregar indicador visual de "c√°mara actual" en modal de tracking
- Considerar export de tracking a PDF/Excel
1. Probar flujo completo con archivos 52547.txt y 52547 Camino 2.txt
2. El servicio 52547 est√° limpio y listo para pruebas
3. Considerar agregar bot√≥n de "Limpiar servicio" en el panel
