# Nombre de archivo: 2025-11-11.md
# Ubicación de archivo: docs/PR/2025-11-11.md
# Descripción: Registro diario de cambios y validaciones del proyecto LAS-FOCAS - Corrección completa del flujo SLA

## 1. Resumen de cambios
Se corrigió completamente el flujo de generación de informes SLA desde la UI web, resolviendo tres problemas críticos:
1. **Logs vacíos**: Se centralizó el sistema de logging a `/home/focal/proyectos/LAS-FOCAS/Logs/` con configuración forzada.
2. **Error de manejo de archivos**: Se corrigió el parámetro FastAPI para recibir múltiples archivos correctamente.
3. **Template no encontrado**: Se agregó la variable de entorno `TEMPLATES_DIR` al servicio web en Docker Compose.

**Estado final**: ✅ El informe SLA se genera correctamente desde la UI, con ajustes menores de formato pendientes.

## 2. Contexto y alcance
- **Módulo afectado**: `web/web_app/main.py` (endpoint `/api/reports/sla`), `core/logging.py`, `deploy/compose.yml`
- **Error inicial**: "Internal Server Error" sin logs visibles al intentar generar el informe SLA desde la UI
- **Alcance**: Depuración y corrección completa del flujo SLA legacy en el endpoint web

## 3. Cambios realizados

### 3.1 Centralización de logs (`core/logging.py`)
```python
# Cambio: Uso de LOGS_DIR desde variable de entorno con fallback al directorio Logs/ del proyecto
_DEFAULT_LOGS_DIR = Path(os.getenv("LOGS_DIR", str(Path(__file__).resolve().parents[1] / "Logs")))
LOGS_ROOT = _DEFAULT_LOGS_DIR

# Cambio: Forzar enable_file=True para garantizar que los logs se escriban siempre
file_handler = RotatingFileHandler(...)
```

### 3.2 Corrección del manejo de múltiples archivos (`web/web_app/main.py`)
**Antes (incorrecto)**:
```python
files: Union[List[UploadFile], UploadFile, None] = File(None)
```

**Después (correcto)**:
```python
files: List[UploadFile] = File(default=[])
```

**Razón**: El tipo `Union[...]` causaba ambigüedad en el parser de multipart de FastAPI, resultando en que solo se recibiera el primer archivo a pesar de que el cliente enviaba dos.

**Simplificación de normalización**:
```python
# Antes: Lógica compleja con isinstance()
# Después:
archivos = [archivo for archivo in files if archivo and archivo.filename]
```

**Simplificación de _close_uploads**:
```python
# Antes: Manejo de Union con isinstance()
# Después:
async def _close_uploads(upload_list: List[UploadFile]) -> None:
    for upload in upload_list:
        try:
            await upload.close()
        except Exception:
            logger.debug("action=sla_web_report stage=close_upload warning", exc_info=True)
```

### 3.3 Configuración de variables de entorno (`deploy/compose.yml`)
```yaml
# Agregado al servicio web:
environment:
  TEMPLATES_DIR: /app/Templates
```

### 3.4 Logging detallado agregado
Se agregaron puntos de logging estratégicos en `web/web_app/main.py`:
- Inicio del procesamiento con conteo de archivos
- Validación de cantidad de archivos
- Identificación del tipo de Excel (servicios vs reclamos)
- Generación del informe legacy
- Resultado final (rutas docx/pdf)

## 4. Tareas realizadas
- [x] Ejecutar tests unitarios del módulo SLA legacy (3/3 pasan correctamente)
- [x] Verificar que el generador funciona dentro del contenedor Docker
- [x] Agregar logging detallado en el endpoint web
- [x] Centralizar logs a directorio `Logs/` del proyecto
- [x] Identificar error: `TypeError: 'UploadFile' object is not iterable`
- [x] Identificar error: Solo 1 de 2 archivos llegaba al backend
- [x] Identificar error: Template no encontrado (`/Templates/...` vs `/app/Templates/...`)
- [x] Corregir parámetro FastAPI de `Union[...]` a `List[UploadFile]`
- [x] Agregar variable `TEMPLATES_DIR=/app/Templates` en compose.yml
- [x] Rebuild y restart del contenedor web
- [x] Validación end-to-end: generación exitosa desde UI

## 5. Criterios de aceptación cumplidos
✅ El endpoint `/api/reports/sla` recibe correctamente 2 archivos Excel  
✅ Los logs se escriben en `Logs/web.log` con información detallada de cada etapa  
✅ El template SLA se encuentra correctamente en `/app/Templates/Template_Informe_SLA.docx`  
✅ El informe `.docx` se genera correctamente  
✅ La respuesta JSON incluye las rutas de descarga  
✅ El sistema replica el comportamiento legacy de Sandy (con ajustes menores de formato pendientes)  

## 6. Impacto en seguridad y datos
- **Logs**: Se mantiene el principio de no loguear contenido sensible por defecto
- **Archivos temporales**: Los `UploadFile` se cierran correctamente con `_close_uploads()`
- **Permisos**: El volumen de Templates se monta como `:ro` (read-only)
- **Variables de entorno**: Se usa `TEMPLATES_DIR` para evitar rutas hardcodeadas

## 7. Compatibilidad y migraciones
- No se requieren migraciones de DB
- Cambio en compose.yml requiere `docker compose up -d web` (no rebuild necesario para esta parte)
- Los logs antiguos en ubicaciones anteriores quedan obsoletos; ahora todo va a `Logs/`

## 8. Evidencia de validación manual

### Verificación de variables de entorno:
```bash
$ docker exec lasfocas-web env | grep TEMPLATES_DIR
TEMPLATES_DIR=/app/Templates
```

### Verificación de template:
```bash
$ docker exec lasfocas-web ls -lh /app/Templates/Template_Informe_SLA.docx
-rw-r--r-- 1 1001 1001 1.8M Sep 30 14:21 /app/Templates/Template_Informe_SLA.docx
```

### Verificación desde Python:
```bash
$ docker exec lasfocas-web python -c "from core.sla.config import SLA_TEMPLATE_PATH; print(f'SLA_TEMPLATE_PATH={SLA_TEMPLATE_PATH}'); print(f'Existe: {SLA_TEMPLATE_PATH.exists()}')"
SLA_TEMPLATE_PATH=/app/Templates/Template_Informe_SLA.docx
Existe: True
```

### Tests unitarios:
```bash
$ pytest tests/test_sla_module.py -v
tests/test_sla_module.py::test_sla_config PASSED
tests/test_sla_module.py::test_load_servicios_excel PASSED
tests/test_sla_module.py::test_generate_from_excel_pair PASSED
```

### Logs de generación exitosa:
```
2025-11-11 17:13:30,918 service=web level=INFO msg=action=sla_web_report stage=start user=admin archivos=2
2025-11-11 17:13:31,245 service=web level=INFO msg=action=sla_web_report stage=excel_identified type=servicios filename=Servicios Fuera de SLA.xlsx
2025-11-11 17:13:31,452 service=web level=INFO msg=action=sla_web_report stage=excel_identified type=reclamos filename=Reclamos Sla (1).xlsx
2025-11-11 17:13:42,108 service=web level=INFO msg=action=sla_web_report stage=success docx=/app/web_app/data/reports/sla/202510/InformeSLA_202510_*.docx
```

## 9. Próximos pasos
1. **Ajustes de formato**: Revisar y ajustar detalles menores del formato del informe generado para que coincida 100% con el formato legacy de Sandy
2. **Documentación**: Actualizar `docs/informes/sla.md` con las correcciones aplicadas
3. **Testing**: Agregar test de integración end-to-end para el endpoint `/api/reports/sla`
4. **Monitoreo**: Validar que los logs se rotan correctamente (RotatingFileHandler con maxBytes=10MB, backupCount=5)

## 10. Lecciones aprendidas
1. **FastAPI y múltiples archivos**: Usar `List[UploadFile]` sin `Union` para evitar ambigüedad en el parser
2. **Variables de entorno en Docker**: Verificar que todas las variables críticas estén definidas en compose.yml, no solo los volúmenes
3. **Logging en contenedores**: Centralizar logs temprano en el desarrollo facilita debugging
4. **Validación incremental**: Los logs detallados por etapa permitieron identificar rápidamente dónde fallaba el flujo
