# Nombre de archivo: 2026-01-09.md
# Ubicación de archivo: docs/PR/2026-01-09.md
# Descripción: Registro diario de cambios del 2026-01-09

# PR Diario — 2026-01-09

## Resumen de cambios

Sesión enfocada en la implementación del **Smart Search** para el dashboard de Infraestructura y corrección de problemas de healthcheck en el script de arranque.

### 1. Smart Search para Infraestructura

Conversión del sistema de búsqueda de "Search Builder con filtros tipados" a **Smart Search con texto libre**:

**Backend:**
- Nuevo endpoint `POST /api/infra/smart-search` en `web/web_app/main.py`
- Modelo `SmartSearchRequestModel` con `terms: list[str]`, `limit`, `offset`
- Lógica de búsqueda: cada término se busca en múltiples campos (nombre, dirección, fontine_id, servicios, cables, estado, origen)
- Términos se combinan con **AND** (intersección)

**Frontend:**
- Input único de texto libre reemplaza el combo select + input
- Sistema de **tags/términos** visuales con botón × para eliminar
- Quick chips actualizados con `data-term` para agregar términos predefinidos
- Búsqueda se dispara al presionar botón "Buscar" o agregar término desde chip

**Estilos:**
- Nuevas clases CSS: `.infra-search-input`, `.infra-search-terms`, `.infra-search-term`
- Animación `tagIn` para feedback visual al agregar términos

### 2. Fix de Camara.cables

- Agregada propiedad `@property def cables()` al modelo `Camara` en `db/models/infra.py`
- Retorna `cables_origen + cables_destino` (unifica ambas relaciones)
- Resuelve `AttributeError: 'Camara' object has no attribute 'cables'`

### 3. Fix de Health Check en Start Script

**Problema:** El health check de WEB fallaba por timeout aunque el servicio estaba funcionando.

**Diagnóstico:**
- Web service bound a IP `192.168.241.28:8080` (no `0.0.0.0`)
- Reglas de firewall (iptables) bloquean acceso a puerto 8080 excepto desde subredes específicas
- `curl http://localhost:8080/health` desde el host era bloqueado
- `curl` desde DENTRO del contenedor funcionaba correctamente

**Solución:**
- Cambio en `Start` script: usar `check_internal` en lugar de `check_http_dual` para WEB
- `check_internal` ejecuta `docker exec` para hacer curl desde dentro del contenedor

### 4. Actualización de Dependencias

- `python-docx`: 0.8.11 → **1.1.2** (fix de compatibilidad)
- `staticmap`: 0.5.5 → **0.5.7**
- Archivos actualizados: `requirements.txt`, `api/requirements.txt`, `web/requirements.txt`, `bot_telegram/requirements.txt`

## Contexto y alcance

- **Módulo afectado:** Infraestructura FO, Script de arranque
- **Objetivo:** Simplificar la UX de búsqueda de cámaras con texto libre intuitivo
- **Restricciones:** Mantener compatibilidad con endpoints existentes

## Archivos modificados

| Archivo | Cambio |
|---------|--------|
| `db/models/infra.py` | Agregada propiedad `cables` en modelo `Camara` |
| `web/web_app/main.py` | Nuevo endpoint `POST /api/infra/smart-search` |
| `web/templates/panel.html` | UI de Smart Search (input único + terms container) |
| `web/static/panel.js` | Lógica de `searchTerms[]`, `addTerm()`, `removeTerm()` |
| `web/static/styles.css` | Estilos para Smart Search |
| `Start` | Cambio de `check_http_dual` a `check_internal` para WEB |
| `requirements.txt` | python-docx, staticmap actualizados |
| `api/requirements.txt` | python-docx actualizado |
| `web/requirements.txt` | python-docx, staticmap actualizados |
| `bot_telegram/requirements.txt` | python-docx actualizado |

## Tareas realizadas

- [x] Agregar propiedad `Camara.cables` al modelo
- [x] Crear endpoint `POST /api/infra/smart-search` en web service
- [x] Actualizar UI de panel.html para Smart Search
- [x] Actualizar panel.js con lógica de términos
- [x] Actualizar styles.css con estilos de Smart Search
- [x] Diagnosticar falla de health check de WEB en Start
- [x] Aplicar fix usando `check_internal` para WEB
- [x] Verificar todos los health checks pasan
- [x] Actualizar dependencias python-docx y staticmap
- [x] Rebuild y deploy de servicios

## Tareas pendientes

- [ ] Tests unitarios para endpoint smart-search
- [ ] Documentar endpoint smart-search en docs/api.md
- [ ] Probar Smart Search con datos reales en producción
- [ ] Evaluar si agregar debounce al input de búsqueda

## Criterios de aceptación

- ✅ Smart Search permite agregar múltiples términos de texto libre
- ✅ Términos se muestran como tags con opción de eliminar
- ✅ Búsqueda devuelve cámaras que coinciden con TODOS los términos
- ✅ Quick chips agregan términos predefinidos
- ✅ Health checks de Start pasan para todos los servicios
- ✅ Docker images construyen sin errores de dependencias

## Validación manual

```bash
# Health checks
./Start --no-down
# Output: OK WEB (interno web -> http://localhost:8080/health)
#         OK API (...), OK NLP_INTENT (...), OK DB (...)

# Smart Search (desde browser)
# 1. Agregar término "LIBRE" → clic en Buscar
# 2. Agregar término "corrientes" → clic en Buscar
# 3. Resultado: cámaras que contienen "LIBRE" Y "corrientes"
```

## Impacto en seguridad

- Sin cambios en autenticación
- El endpoint smart-search requiere sesión activa (`_require_auth`)
- El fix de health check no expone nuevos puertos

## Compatibilidad

- Endpoint `/api/infra/search` (filtros AND) sigue funcionando
- Endpoint `/api/infra/camaras` (búsqueda simple) sigue funcionando
- Smart Search es una alternativa más simple, no un reemplazo

## Próximos pasos

1. Probar Smart Search con archivos de tracking reales
2. Agregar tests para el nuevo endpoint
3. Considerar autocompletado/sugerencias basado en datos existentes
4. Documentar el endpoint en docs/api.md
