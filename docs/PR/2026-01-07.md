# Nombre de archivo: 2026-01-07.md
# Ubicación de archivo: docs/PR/2026-01-07.md
# Descripción: Registro diario de cambios del 2026-01-07

## Resumen de cambios
- Modelo relacional de infraestructura homologado en SQLAlchemy (`camaras`, `cables`, `empalmes`, `servicios`, `ingresos`) con Base compartida.
- Migración Alembic `20251230_01_infra.py` lista para desplegar las nuevas tablas y enum `camara_estado`.
- Parser de tracking FO (`core/parsers/tracking_parser.py`) que normaliza archivos TXT legacy.
- Servicio `core/services/infra_sync.py` que sincroniza la hoja Google Camaras con PostgreSQL (upsert, métricas y logging estructurado).
- Endpoint `POST /sync/camaras` incorporado a la API para disparar la sincronización.
- Documentación actualizada (`docs/db.md`, `docs/api.md`, `docs/Mate_y_Ruta.md`) y alineación de credenciales (`Keys/credentials.json`, `GOOGLE_CREDENTIALS_JSON`).

## Contexto y alcance
- Portar la información de infraestructura heredada (Sheet + tracking TXT) a un esquema mantenible en Postgres.
- Habilitar un proceso repetible de sincronización desde Google Sheets y dejar sentadas las bases para ingestión de tracking.
- Documentar configuración, dependencias y pasos operativos para que Operaciones pueda ejecutar los flujos sin asistencia directa.

## Cambios realizados
- `db/base.py`: nuevo archivo con Base declarativa compartida.
- `db/models/infra.py`: definición completa de modelos y enums para infraestructura FO.
- `db/alembic/versions/20251230_01_infra.py`: creación de tablas, enum `camara_estado` e índices auxiliares.
- `core/parsers/tracking_parser.py`: parser robusto para archivos TXT de tracking (dataclasses, validaciones, normalización de fechas).
- `core/services/infra_sync.py`: servicio de sincronización con gspread, manejo de credenciales (`Keys/` o env), logging y métricas.
- `db/session.py`, `core/config.py`: wiring de session factory e incorporación de settings `INFRA_SHEET_ID/NAME`.
- `api/api_app/routes/infra.py`, `api/app/app.py`: endpoint FastAPI `POST /sync/camaras` registrado en la aplicación.
- `deploy/env.sample`: documentación de variables `INFRA_SHEET_ID`, `INFRA_SHEET_NAME`, `GOOGLE_CREDENTIALS_JSON`.
- `docs/db.md`, `docs/api.md`, `docs/Mate_y_Ruta.md`: documentación ampliada de las nuevas piezas.
- `docs/PR/2026-01-07.md`: actualización del registro diario (este archivo).

## Tareas realizadas y pendientes
- [x] Definir modelos y migración de infraestructura.
- [x] Implementar parser de tracking.
- [x] Crear servicio de sincronización Google Sheets → Postgres.
- [x] Exponer endpoint `/sync/camaras` en la API.
- [x] Documentar configuración y uso (API, DB, Mate y Ruta).
- [ ] Ejecutar la migración en el entorno de staging/producción.
- [ ] Conectar parser de tracking con persistencia real (`empalmes`, `servicio_empalme_association`).
- [ ] Implementar endpoints de baneo/desbaneo y métricas de ocupación usando `app.camaras`.

## Criterios de aceptación y validación
- Migración Alembic debe generar todas las tablas nuevas sin errores (`alembic upgrade head`).
- Servicio `core/services/infra_sync.sync_camaras_from_sheet` retorna métricas coherentes y hace commit/rollback apropiado.
- Endpoint `/sync/camaras` responde 200 con payload `{status, processed, updated, created}`.
- Documentación describe prerequisitos (Sheet ID, credenciales, env vars) y pasos operativos.

## Impacto en seguridad y datos
- Se introducen nuevas tablas en el esquema `app` para infraestructura física; requiere ejecutar la migración antes de usar el servicio.
- Manejo de credenciales gspread centralizado en `Keys/credentials.json` o variable `GOOGLE_CREDENTIALS_JSON` (no commitear). Recordar moverlas a Docker Secrets a futuro.
- Endpoint `/sync/camaras` aún sin autenticación: limitar su exposición a redes internas hasta implementar API Key/JWT.

## Compatibilidad y migraciones
- Migración `20251230_01_infra.py` requiere Postgres 13+ (uso de JSONB, enums). Alinear versiones del motor si se ejecuta fuera de Docker.
- Variables nuevas en `.env`: `INFRA_SHEET_ID`, `INFRA_SHEET_NAME`, `GOOGLE_CREDENTIALS_JSON` (opcional si se usa archivo en Keys/).
- `core/config.Settings` amplía el esquema con sección `infra` (revisar usos de `get_settings()` para no romper importaciones).

## Evidencia de validación manual
- Verificación manual en editor: `core/services/infra_sync.py` sin errores de sintaxis ni advertencias Pylance tras ajuste de indentación.
- Revisión de `db/alembic/versions/20251230_01_infra.py` en modo `--sql` (dry run) pendiente antes de ejecutar en entornos compartidos.
- TODO: ejecutar `alembic upgrade head` y `pytest tests/test_sla_module.py` en CI cuando se integre la migración.

## Próximos pasos
- Ejecutar migración en ambientes compartidos y realizar prueba end-to-end del endpoint `/sync/camaras`.
- Conectar parser de tracking al nuevo esquema y exponer endpoints de importación/consulta.
- Diseñar autenticación/API keys para los nuevos endpoints operativos.
- Documentar decisiones en `docs/decisiones.md` una vez validados los flujos de infraestructura.
