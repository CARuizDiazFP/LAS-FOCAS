<!--
# Nombre de archivo: panel.html
# Ubicaci√≥n de archivo: web/templates/panel.html
# Descripci√≥n: Panel principal con Chat como vista por defecto y secciones de flujos (Repetitividad, SLA, FO)
-->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LAS-FOCAS ‚Äî Panel</title>
  <link rel="stylesheet" href="/static/styles.css?v={{ build_version }}" />
  <script>
    window.API_BASE = "{{ api_base }}";
    window.CSRF_TOKEN = "{{ csrf }}";
    window.BUILD_VERSION = "{{ build_version }}";
  </script>
  <script defer src="/static/panel.js?v={{ build_version }}"></script>
</head>
<body class="dark">
  <header class="topbar">
    <div class="brand">LAS-FOCAS <span class="version-badge">v{{ build_version }}</span></div>
    <nav class="actions" aria-label="Flujos">
      <button class="chip active" data-view="chat">Chat</button>
      <button class="chip" data-view="repetitividad">Repetitividad</button>
        <button class="chip" data-view="vlan">Comparador VLAN</button>
        <a class="chip" href="/sla">SLA</a>
      <button class="chip" data-view="fo">Comparador FO</button>
      <button class="chip" data-view="ciena">Alarmas Ciena</button>
      <button class="chip" data-view="infra">Infra/C√°maras</button>
      <span class="spacer"></span>
      {% if username %}
      <span class="muted">{{ username }}</span>
      <a class="btn" href="/admin">Admin</a>
      <a class="btn" href="/logout">Salir</a>
      {% endif %}
    </nav>
  </header>

  <main class="container">
    <section class="views" id="panel-views">
      <!-- Chat (vista por defecto) -->
      <section id="view-chat" class="view active" aria-labelledby="Chat">
        <article class="card">
          <header class="card-header">
            <h1>Asistente conversacional</h1>
            <span class="badge">MCP</span>
          </header>
          <div class="chat">
            <div id="chat-status" class="chat-status muted"></div>
            <div id="chat-log" class="chat-log"></div>
            <div id="chat-attachments" class="chat-attachments"></div>
            <div id="chat-dropzone" class="chat-dropzone">
              Arrastr√° archivos o <button type="button" id="chat-attachment-browse" class="link-button">busc√° en tu equipo</button>
              <small class="muted">L√≠mite 15 MB por archivo</small>
            </div>
            <form id="chat-form" class="chat-form">
              <input id="chat-input" name="text" type="text" placeholder="Escrib√≠ un mensaje" required />
              <button type="submit" class="btn primary">Enviar</button>
            </form>
          </div>
          <input id="chat-attachment-input" type="file" multiple hidden />
        </article>
      </section>

      <!-- Repetitividad -->
      <section id="view-repetitividad" class="view" aria-labelledby="Repetitividad">
        <article class="card">
          <header class="card-header">
            <h1>Informe de Repetitividad</h1>
            <span class="badge">FO Legacy+</span>
          </header>
          <p class="muted">Pod√©s cargar un Excel o tomar los datos directo desde la base. El per√≠odo s√≥lo se usa como etiqueta en los archivos generados.</p>
          <form id="rep-form" class="stack" enctype="multipart/form-data" onsubmit="return false;">
            <div class="dropzone" id="rep-drop">
              <input type="file" id="rep-file" name="file" accept=".xlsx" />
              <span>Arrastr√° el .xlsx ac√° o hac√© click</span>
            </div>
            <div class="form-grid">
              <div class="field">
                <label>Mes</label>
                <input type="number" id="rep-mes" name="mes" min="1" max="12" required />
              </div>
              <div class="field">
                <label>A√±o</label>
                <input type="number" id="rep-anio" name="anio" min="2000" max="2100" required />
              </div>
            </div>
            <label class="checkbox"><input type="checkbox" id="rep-pdf" name="include_pdf" checked /> Generar PDF si est√° disponible</label>
            <label class="checkbox"><input type="checkbox" id="rep-with-geo" name="with_geo" /> Incluir mapas GEO por servicio</label>
            <label class="checkbox"><input type="checkbox" id="rep-use-db" name="use_db" /> Usar reclamos desde la base de datos (ignora archivo)</label>
            <div class="card-actions">
              <button type="button" id="rep-run" class="btn primary">Generar</button>
              <a class="btn subtle" href="/reports-history" target="_blank" rel="noopener">Carpeta de reportes</a>
            </div>
          </form>
          <div id="rep-result" class="result-box muted">A√∫n no se gener√≥ ning√∫n informe.</div>
        </article>
      </section>

      <!-- Comparador VLAN -->
      <section id="view-vlan" class="view" aria-labelledby="Comparador de VLANs">
        <article class="card">
          <header class="card-header">
            <h1>Comparador de VLANs</h1>
            <span class="badge">Nuevo</span>
          </header>
          <p class="muted">Peg√° las configuraciones completas de las interfaces (formato Cisco IOS). El sistema detecta autom√°ticamente las l√≠neas <code>switchport trunk allowed vlan</code>, expande los rangos y muestra las diferencias.</p>
          <div class="vlan-input-grid">
            <div class="vlan-input">
              <label for="vlan-text-a" class="form-label">Interfaz A</label>
              <textarea id="vlan-text-a" name="text_a" placeholder="interface GigabitEthernet0/1&#10; switchport trunk allowed vlan 1-30,101,306-308"></textarea>
              <small class="muted">Se muestran las VLANs que est√°n √∫nicamente en esta interfaz.</small>
            </div>
            <div class="vlan-input">
              <label for="vlan-text-b" class="form-label">Interfaz B</label>
              <textarea id="vlan-text-b" name="text_b" placeholder="interface TenGigabitEthernet0/48&#10; switchport trunk allowed vlan add 1-10,40,306-310"></textarea>
              <small class="muted">Inclu√≠ todos los comandos relevantes; el parser ignora l√≠neas ajenas.</small>
            </div>
          </div>
          <div class="card-actions">
            <button type="button" id="vlan-compare" class="btn primary">Comparar</button>
            <button type="button" id="vlan-clear" class="btn subtle">Limpiar</button>
          </div>
          <div id="vlan-status" class="result-box muted" role="status" aria-live="polite" aria-atomic="true">
            Ingres√° dos configuraciones de interfaz trunk para comenzar.
          </div>
          <div class="vlan-results" id="vlan-results">
            <div class="vlan-result-card">
              <div class="vlan-result-header">
                <h2>Solo A</h2>
                <span id="vlan-only-a-count" class="vlan-count">0</span>
              </div>
              <div id="vlan-only-a" class="vlan-list" data-empty="Sin diferencias detectadas"></div>
            </div>
            <div class="vlan-result-card">
              <div class="vlan-result-header">
                <h2>Comunes</h2>
                <span id="vlan-common-count" class="vlan-count">0</span>
              </div>
              <div id="vlan-common" class="vlan-list" data-empty="No hay coincidencias"></div>
            </div>
            <div class="vlan-result-card">
              <div class="vlan-result-header">
                <h2>Solo B</h2>
                <span id="vlan-only-b-count" class="vlan-count">0</span>
              </div>
              <div id="vlan-only-b" class="vlan-list" data-empty="Sin diferencias detectadas"></div>
            </div>
          </div>
        </article>
      </section>

      <!-- Comparador FO -->
      <section id="view-fo" class="view" aria-labelledby="Comparador FO">
        <article class="card">
          <header class="card-header">
            <h1>Comparador FO</h1>
            <span class="badge">WIP</span>
          </header>
          <form id="fo-form" class="stack" enctype="multipart/form-data" onsubmit="return false;">
            <div class="dropzone" id="fo-drop">
              <input type="file" id="fo-file" name="file" accept=".xlsx,.csv" />
              <span>Arrastr√° el archivo o hac√© click</span>
            </div>
            <div class="card-actions">
              <button type="button" id="fo-run" class="btn">Comparar</button>
            </div>
          </form>
          <div id="fo-result" class="result-box muted">No implementado a√∫n.</div>
        </article>
      </section>

      <!-- Alarmas Ciena -->
      <section id="view-ciena" class="view" aria-labelledby="Alarmas Ciena">
        <article class="card">
          <header class="card-header">
            <h1>Alarmas Ciena</h1>
            <span class="badge">Nuevo</span>
          </header>
          <p class="muted">Seleccion√° un CSV exportado desde SiteManager o MCP para convertirlo a Excel.</p>
          <form id="ciena-form" class="stack" enctype="multipart/form-data" onsubmit="return false;">
            <div class="dropzone" id="ciena-drop">
              <input type="file" id="ciena-file" name="file" accept=".csv" />
              <span>Arrastr√° el .csv ac√° o hac√© click</span>
            </div>
            <div class="card-actions">
              <button type="button" id="ciena-run" class="btn primary">Procesar</button>
            </div>
          </form>
          <div id="ciena-result" class="result-box muted">Esperando archivo.</div>
        </article>
      </section>

      <!-- Dashboard Infraestructura / C√°maras -->
      <section id="view-infra" class="view" aria-labelledby="Infraestructura">
        <article class="card infra-card">
          <!-- Hero Header con t√≠tulo y badge -->
          <header class="infra-hero">
            <div class="infra-hero-content">
              <h1 class="infra-title">Infraestructura FO</h1>
              <p class="infra-subtitle">Gesti√≥n de c√°maras y servicios de fibra √≥ptica</p>
            </div>
            <div class="infra-hero-actions">
              <!-- Badge de baneos activos (clickeable para ver/gestionar) -->
              <button type="button" id="infra-ban-badge" class="infra-ban-badge" hidden title="Ver y gestionar baneos activos">
                <span class="infra-ban-badge-icon">üîí</span>
                <span id="infra-ban-count" class="infra-ban-badge-count">0</span>
                <span class="infra-ban-badge-text">ACTIVOS</span>
              </button>
              <!-- Bot√≥n de notificaci√≥n (solo si hay baneos) -->
              <button type="button" id="infra-notify-btn" class="infra-notify-btn" hidden title="Dar aviso de baneo por correo">
                üìß Dar Aviso
              </button>
              <!-- BOT√ìN DE P√ÅNICO -->
              <button type="button" id="infra-panic-btn" class="infra-panic-btn" title="Activar Protocolo de Protecci√≥n">
                üö® Protocolo Protecci√≥n
              </button>
              <span class="badge infra-badge">üîå FO INFRA</span>
            </div>
          </header>

          <!-- Actions: Smart Search + Upload -->
          <div class="infra-actions">
            <!-- Smart Search (texto libre) -->
            <div class="infra-search-builder">
              <div class="infra-search-row">
                <input 
                  type="text" 
                  id="infra-search-input" 
                  class="infra-search-input" 
                  placeholder="Busc√° por servicio, direcci√≥n, c√°mara, cable..." 
                  autocomplete="off"
                />
                <button type="button" id="infra-add-term" class="infra-add-btn" title="Agregar t√©rmino">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                </button>
              </div>
              <!-- T√©rminos de b√∫squeda activos -->
              <div id="infra-search-terms" class="infra-search-terms"></div>
              <!-- Bot√≥n de b√∫squeda -->
              <button type="button" id="infra-search-btn" class="infra-search-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="m21 21-4.35-4.35"/>
                </svg>
                Buscar
              </button>
            </div>

            <!-- Upload Zone -->
            <div class="infra-upload-zone" id="infra-drop">
              <input type="file" id="infra-file" name="file" accept=".txt" hidden />
              <svg class="infra-upload-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17,8 12,3 7,8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <span class="infra-upload-text">Subir tracking</span>
              <span class="infra-upload-hint">.txt</span>
            </div>

            <!-- Bot√≥n limpiar servicio -->
            <button type="button" id="infra-clear-service-btn" class="infra-clear-btn" title="Limpiar asociaciones de un servicio">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/>
                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
              </svg>
              <span>Limpiar servicio</span>
            </button>

            <!-- Bot√≥n exportar c√°maras -->
            <div class="infra-export-dropdown">
              <button type="button" id="infra-export-btn" class="infra-export-btn" title="Descargar listado de c√°maras">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7,10 12,15 17,10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                <span>Descargar</span>
              </button>
              <div id="infra-export-menu" class="infra-export-menu" hidden>
                <button type="button" data-filter="ALL" data-format="xlsx">üìä Todas (XLSX)</button>
                <button type="button" data-filter="ALL" data-format="csv">üìÑ Todas (CSV)</button>
                <button type="button" data-filter="BANEADA" data-format="xlsx">üîí Solo Baneadas</button>
                <button type="button" data-filter="OCUPADA" data-format="xlsx">üîß Con Ingreso</button>
              </div>
            </div>
          </div>

          <!-- Quick filters (estado) - Atajos para agregar t√©rminos -->
          <div class="infra-quick-filters">
            <span class="infra-filters-label">Atajos:</span>
            <button class="infra-quick-chip" data-term="LIBRE">
              <span class="status-dot libre"></span> Libre
            </button>
            <button class="infra-quick-chip" data-term="OCUPADA">
              <span class="status-dot ocupada"></span> Ocupada
            </button>
            <button class="infra-quick-chip" data-term="BANEADA">
              <span class="status-dot baneada"></span> Baneada
            </button>
            <button class="infra-quick-chip" data-term="DETECTADA">
              <span class="status-dot detectada"></span> Detectada
            </button>
            <button class="infra-quick-chip" data-term="TRACKING">
              üìç Tracking
            </button>
          </div>

          <!-- Separador visual -->
          <hr class="infra-divider" />

          <!-- Status bar -->
          <div id="infra-status" class="infra-status">
            <!-- Se actualiza din√°micamente -->
          </div>

          <!-- Contenedor principal de resultados -->
          <div class="infra-results">
            <!-- Grid de resultados -->
            <div id="infra-grid" class="infra-grid"></div>

            <!-- Loading spinner -->
            <div id="infra-loading" class="infra-loading" hidden>
              <div class="infra-spinner-ring"></div>
              <span>Buscando c√°maras...</span>
            </div>

            <!-- Empty state inicial -->
            <div id="infra-empty" class="infra-empty">
              <div class="infra-empty-visual">
                <svg viewBox="0 0 120 100" class="infra-empty-illustration">
                  <rect x="10" y="60" width="100" height="35" rx="4" fill="#1a1f26" stroke="#30363d"/>
                  <circle cx="35" cy="77" r="8" fill="none" stroke="#00ff88" stroke-width="2" opacity="0.6"/>
                  <circle cx="60" cy="77" r="8" fill="none" stroke="#3b82f6" stroke-width="2" opacity="0.6"/>
                  <circle cx="85" cy="77" r="8" fill="none" stroke="#eab308" stroke-width="2" opacity="0.6"/>
                  <path d="M35 40 L60 20 L85 40" stroke="#30363d" stroke-width="2" fill="none"/>
                  <circle cx="60" cy="20" r="6" fill="#0d1117" stroke="#00ff88" stroke-width="2"/>
                  <line x1="60" y1="26" x2="60" y2="60" stroke="#30363d" stroke-width="2" stroke-dasharray="4 2"/>
                </svg>
              </div>
              <h3 class="infra-empty-title">Sin c√°maras para mostrar</h3>
              <p class="infra-empty-desc">Busc√° por ID de servicio, direcci√≥n o sub√≠ un archivo de tracking</p>
            </div>
          </div>
        </article>
      </section>
    </section>
  </main>

  <!-- Toast container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Modal de conflicto de tracking -->
  <dialog id="tracking-conflict-modal" class="tracking-modal">
    <article class="tracking-modal-content">
      <header class="tracking-modal-header">
        <h2 id="tracking-modal-title">‚ö†Ô∏è Conflicto de Tracking</h2>
        <button type="button" class="tracking-modal-close" aria-label="Cerrar">&times;</button>
      </header>
      <div class="tracking-modal-body">
        <p id="tracking-conflict-message" class="tracking-conflict-message"></p>
        
        <!-- Vista est√°ndar de conflicto -->
        <div id="tracking-standard-conflict" class="tracking-info-grid">
          <div class="tracking-info-card">
            <h4>üìÑ Archivo subido</h4>
            <dl>
              <dt>Nombre:</dt>
              <dd id="tracking-new-filename">-</dd>
              <dt>Servicio:</dt>
              <dd id="tracking-new-servicio">-</dd>
              <dt>Empalmes:</dt>
              <dd id="tracking-new-empalmes">-</dd>
            </dl>
          </div>
          <div class="tracking-info-card existing">
            <h4>üóÇÔ∏è Ruta existente</h4>
            <dl>
              <dt>Nombre:</dt>
              <dd id="tracking-existing-ruta">-</dd>
              <dt>Empalmes:</dt>
              <dd id="tracking-existing-empalmes">-</dd>
              <dt>Diferencias:</dt>
              <dd id="tracking-diff-count">-</dd>
            </dl>
          </div>
        </div>

        <!-- Vista de Upgrade Potencial -->
        <div id="tracking-upgrade-view" class="tracking-upgrade-view" hidden>
          <div class="tracking-upgrade-diagram">
            <div class="tracking-upgrade-service old">
              <div class="tracking-upgrade-service-header">
                <span class="tracking-upgrade-icon">üìÅ</span>
                <span>Servicio Existente</span>
              </div>
              <div class="tracking-upgrade-service-id" id="tracking-upgrade-old-id">10125</div>
            </div>
            <div class="tracking-upgrade-arrow">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"/>
                <polyline points="12 5 19 12 12 19"/>
              </svg>
              <span>Migrar a</span>
            </div>
            <div class="tracking-upgrade-service new">
              <div class="tracking-upgrade-service-header">
                <span class="tracking-upgrade-icon">üìÑ</span>
                <span>Nuevo ID</span>
              </div>
              <div class="tracking-upgrade-service-id" id="tracking-upgrade-new-id">30256</div>
            </div>
          </div>
          <div class="tracking-upgrade-puntas">
            <h4>Puntas coincidentes:</h4>
            <div class="tracking-puntas-chips">
              <span class="tracking-punta-chip punta-a">
                <svg class="punta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="3" width="20" height="14" rx="2"/>
                  <line x1="8" y1="21" x2="16" y2="21"/>
                  <line x1="12" y1="17" x2="12" y2="21"/>
                </svg>
                <span>Punta A:</span>
                <strong id="tracking-upgrade-punta-a">ODF Maipu</strong>
              </span>
              <span class="tracking-punta-chip punta-b">
                <svg class="punta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="3" width="20" height="14" rx="2"/>
                  <line x1="8" y1="21" x2="16" y2="21"/>
                  <line x1="12" y1="17" x2="12" y2="21"/>
                </svg>
                <span>Punta B:</span>
                <strong id="tracking-upgrade-punta-b">ODF Warnes</strong>
              </span>
            </div>
          </div>
        </div>

        <!-- Vista de Nuevo Pelo -->
        <div id="tracking-strand-view" class="tracking-strand-view" hidden>
          <div class="tracking-strand-diagram">
            <div class="tracking-strand-service">
              <div class="tracking-strand-header">
                <span class="tracking-strand-icon">üß∂</span>
                <span>Servicio</span>
              </div>
              <div class="tracking-strand-id" id="tracking-strand-service-id">52547</div>
            </div>
            <div class="tracking-strand-info">
              <div class="tracking-strand-current">
                <span class="tracking-strand-label">Pelos actuales:</span>
                <span class="tracking-strand-count" id="tracking-strand-current">1</span>
              </div>
              <div class="tracking-strand-arrow">
                <span>+1</span>
              </div>
              <div class="tracking-strand-new">
                <span class="tracking-strand-label">Resultado:</span>
                <span class="tracking-strand-count highlight" id="tracking-strand-new">2</span>
              </div>
            </div>
          </div>
          <div class="tracking-strand-details">
            <p>El recorrido del tracking es <strong>id√©ntico</strong> a la ruta existente.</p>
            <p class="tracking-strand-hint">Esto indica que se trata de un nuevo pelo/hilo sobre la misma fibra.</p>
          </div>
        </div>
        
        <!-- Acciones est√°ndar -->
        <div id="tracking-standard-actions" class="tracking-actions-section">
          <h4>¬øQu√© deseas hacer?</h4>
          <div class="tracking-action-options">
            <button type="button" class="tracking-action-btn" data-action="REPLACE">
              <span class="tracking-action-icon">üîÑ</span>
              <span class="tracking-action-label">Reemplazar</span>
              <span class="tracking-action-desc">Actualizar la ruta principal con el nuevo tracking</span>
            </button>
            <button type="button" class="tracking-action-btn" data-action="MERGE_APPEND">
              <span class="tracking-action-icon">‚ûï</span>
              <span class="tracking-action-label">Complementar</span>
              <span class="tracking-action-desc">Agregar c√°maras nuevas sin quitar las existentes</span>
            </button>
            <button type="button" class="tracking-action-btn" data-action="BRANCH">
              <span class="tracking-action-icon">üåø</span>
              <span class="tracking-action-label">Camino disjunto</span>
              <span class="tracking-action-desc">Guardar como ruta alternativa/backup</span>
            </button>
            <button type="button" class="tracking-action-btn" data-action="ADD_STRAND">
              <span class="tracking-action-icon">üß∂</span>
              <span class="tracking-action-label">Agregar pelo</span>
              <span class="tracking-action-desc">Mismo camino, diferente hilo (C1, C2...)</span>
            </button>
            <button type="button" class="tracking-action-btn danger" data-action="SKIP">
              <span class="tracking-action-icon">‚è≠Ô∏è</span>
              <span class="tracking-action-label">Omitir</span>
              <span class="tracking-action-desc">No hacer cambios, mantener como est√°</span>
            </button>
          </div>
        </div>

        <!-- Acciones para Upgrade -->
        <div id="tracking-upgrade-actions" class="tracking-actions-section" hidden>
          <h4>¬øQu√© deseas hacer?</h4>
          <div class="tracking-action-options tracking-action-options-upgrade">
            <button type="button" class="tracking-action-btn primary-action" data-action="CONFIRM_UPGRADE">
              <span class="tracking-action-icon">‚úÖ</span>
              <span class="tracking-action-label">S√≠, realizar Upgrade</span>
              <span class="tracking-action-desc" id="tracking-upgrade-desc">Migrar 10125 ‚Üí 30256</span>
            </button>
            <button type="button" class="tracking-action-btn" data-action="CREATE_NEW">
              <span class="tracking-action-icon">‚ûï</span>
              <span class="tracking-action-label">No, crear como nuevo</span>
              <span class="tracking-action-desc">Crear servicio independiente</span>
            </button>
          </div>
        </div>

        <!-- Acciones para Nuevo Pelo -->
        <div id="tracking-strand-actions" class="tracking-actions-section" hidden>
          <h4>¬øQu√© deseas hacer?</h4>
          <div class="tracking-action-options tracking-action-options-strand">
            <button type="button" class="tracking-action-btn primary-action" data-action="ADD_STRAND">
              <span class="tracking-action-icon">üß∂</span>
              <span class="tracking-action-label">Agregar como Pelo Adicional (+1)</span>
              <span class="tracking-action-desc">Incrementar capacidad de la ruta existente</span>
            </button>
            <button type="button" class="tracking-action-btn" data-action="SKIP">
              <span class="tracking-action-icon">‚è≠Ô∏è</span>
              <span class="tracking-action-label">Omitir</span>
              <span class="tracking-action-desc">No hacer cambios</span>
            </button>
          </div>
        </div>
        
        <!-- Input para nombre de ruta (solo para BRANCH) -->
        <div id="tracking-branch-options" class="tracking-branch-options" hidden>
          <label for="tracking-ruta-nombre">Nombre de la nueva ruta:</label>
          <input type="text" id="tracking-ruta-nombre" placeholder="ej: Backup Norte, Camino 2" />
          <label for="tracking-ruta-tipo">Tipo:</label>
          <select id="tracking-ruta-tipo">
            <option value="BACKUP">Backup</option>
            <option value="ALTERNATIVA">Alternativa</option>
          </select>
        </div>
      </div>
      <footer class="tracking-modal-footer">
        <button type="button" id="tracking-confirm-btn" class="btn primary" disabled>Confirmar</button>
        <button type="button" id="tracking-cancel-btn" class="btn secondary">Cancelar</button>
      </footer>
    </article>
  </dialog>

  <!-- Modal Wizard de Baneo (Protocolo de Protecci√≥n) -->
  <dialog id="ban-wizard-modal" class="ban-wizard-modal">
    <article class="ban-wizard-content">
      <header class="ban-wizard-header">
        <div class="ban-wizard-title-row">
          <span class="ban-wizard-icon">üö®</span>
          <h2>Protocolo de Protecci√≥n</h2>
        </div>
        <button type="button" class="ban-wizard-close" aria-label="Cerrar">&times;</button>
      </header>
      
      <!-- Progress Steps -->
      <div class="ban-wizard-progress">
        <div class="ban-step active" data-step="1">
          <span class="ban-step-number">1</span>
          <span class="ban-step-label">Identificaci√≥n</span>
        </div>
        <div class="ban-step-connector"></div>
        <div class="ban-step" data-step="2">
          <span class="ban-step-number">2</span>
          <span class="ban-step-label">Selecci√≥n</span>
        </div>
        <div class="ban-step-connector"></div>
        <div class="ban-step" data-step="3">
          <span class="ban-step-number">3</span>
          <span class="ban-step-label">Confirmaci√≥n</span>
        </div>
      </div>

      <div class="ban-wizard-body">
        <!-- Paso 1: Identificaci√≥n -->
        <div class="ban-wizard-step" data-step="1">
          <h3>üé´ Identificaci√≥n del Incidente</h3>
          <p class="ban-wizard-desc">Ingres√° los datos del corte que dispar√≥ este protocolo.</p>
          
          <div class="ban-form-group">
            <label for="ban-ticket">Ticket Incidente (opcional)</label>
            <input type="text" id="ban-ticket" placeholder="Ej: INC0012345" maxlength="64" />
          </div>
          
          <div class="ban-form-group">
            <label for="ban-servicio-afectado">Servicio Afectado (ID) <span class="required">*</span></label>
            <input type="text" id="ban-servicio-afectado" placeholder="Ej: 52547" required />
            <small class="ban-form-hint">El servicio que sufri√≥ el corte de fibra.</small>
          </div>

          <div class="ban-form-group">
            <label for="ban-motivo">Motivo (opcional)</label>
            <textarea id="ban-motivo" placeholder="Describe brevemente el motivo del baneo..." rows="2" maxlength="512"></textarea>
          </div>
        </div>

        <!-- Paso 2: Selecci√≥n del Objetivo -->
        <div class="ban-wizard-step" data-step="2" hidden>
          <h3>üéØ Selecci√≥n del Objetivo a Proteger</h3>
          
          <!-- Info del servicio afectado -->
          <div id="ban-afectado-info" class="ban-info-box">
            <span class="ban-info-icon">‚ÑπÔ∏è</span>
            <span id="ban-afectado-text">Buscando rutas del servicio afectado...</span>
          </div>

          <!-- Opci√≥n: mismo servicio u otro -->
          <div class="ban-target-toggle">
            <button type="button" class="ban-target-opt active" data-target="same">
              <span class="ban-target-opt-icon">üîÑ</span>
              <span class="ban-target-opt-text">Proteger el mismo servicio</span>
            </button>
            <button type="button" class="ban-target-opt" data-target="other">
              <span class="ban-target-opt-icon">üîÄ</span>
              <span class="ban-target-opt-text">Proteger otro servicio (redundancia cruzada)</span>
            </button>
          </div>

          <!-- Input para buscar otro servicio -->
          <div id="ban-other-service-input" class="ban-form-group" hidden>
            <label for="ban-servicio-protegido">ID del Servicio a Proteger</label>
            <div class="ban-search-row">
              <input type="text" id="ban-servicio-protegido" placeholder="Ej: 52548" />
              <button type="button" id="ban-search-service-btn" class="ban-search-btn">Buscar</button>
            </div>
          </div>

          <!-- Resultado: rutas disponibles -->
          <div id="ban-rutas-container" class="ban-rutas-container">
            <h4>Rutas disponibles para banear:</h4>
            <div id="ban-rutas-list" class="ban-rutas-list">
              <!-- Se llena din√°micamente -->
            </div>
          </div>

          <!-- Sem√°foro de Tracking -->
          <div id="ban-tracking-status" class="ban-tracking-status" hidden>
            <div class="ban-tracking-semaforo">
              <span id="ban-tracking-icon" class="ban-tracking-icon">üü¢</span>
              <span id="ban-tracking-text">Tracking actualizado hace X d√≠as</span>
            </div>
            <button type="button" id="ban-download-tracking-btn" class="ban-download-tracking-btn" title="Descargar tracking TXT">
              üì• Descargar TXT
            </button>
          </div>
        </div>

        <!-- Paso 3: Confirmaci√≥n -->
        <div class="ban-wizard-step" data-step="3" hidden>
          <h3>‚ö†Ô∏è Confirmaci√≥n Final</h3>
          <p class="ban-wizard-desc ban-warning">Revis√° los datos antes de ejecutar. Esta acci√≥n marcar√° las c√°maras como BANEADAS.</p>
          
          <div class="ban-summary">
            <div class="ban-summary-row">
              <span class="ban-summary-label">Ticket:</span>
              <span id="ban-summary-ticket" class="ban-summary-value">-</span>
            </div>
            <div class="ban-summary-row">
              <span class="ban-summary-label">Servicio Afectado:</span>
              <span id="ban-summary-afectado" class="ban-summary-value">-</span>
            </div>
            <div class="ban-summary-row">
              <span class="ban-summary-label">Servicio a Proteger:</span>
              <span id="ban-summary-protegido" class="ban-summary-value">-</span>
            </div>
            <div class="ban-summary-row">
              <span class="ban-summary-label">Ruta:</span>
              <span id="ban-summary-ruta" class="ban-summary-value">Todas las rutas</span>
            </div>
            <div class="ban-summary-row highlight">
              <span class="ban-summary-label">C√°maras afectadas:</span>
              <span id="ban-summary-camaras" class="ban-summary-value">-</span>
            </div>
          </div>

          <div class="ban-confirm-checkbox">
            <label>
              <input type="checkbox" id="ban-confirm-check" />
              <span>Confirmo que entiendo que las c√°maras ser√°n bloqueadas</span>
            </label>
          </div>
        </div>
      </div>

      <footer class="ban-wizard-footer">
        <button type="button" id="ban-prev-btn" class="btn secondary" hidden>‚Üê Anterior</button>
        <div class="ban-wizard-spacer"></div>
        <button type="button" id="ban-cancel-btn" class="btn secondary">Cancelar</button>
        <button type="button" id="ban-next-btn" class="btn primary">Siguiente ‚Üí</button>
        <button type="button" id="ban-execute-btn" class="btn danger" hidden>üö® EJECUTAR BANEO</button>
      </footer>
    </article>
  </dialog>

  <!-- Modal de Baneos Activos -->
  <dialog id="notify-modal" class="notify-modal active-bans-modal">
    <article class="notify-modal-content">
      <header class="notify-modal-header">
        <h2>üîí Baneos Activos</h2>
        <button type="button" class="notify-modal-close">&times;</button>
      </header>
      <div class="notify-modal-body">
        <p class="active-bans-subtitle">C√°maras protegidas por el Protocolo de Protecci√≥n</p>
        <div id="active-bans-list" class="active-bans-list">
          <p class="loading-text">Cargando baneos...</p>
        </div>
      </div>
      <footer class="notify-modal-footer">
        <div class="notify-email-option">
          <label class="notify-email-label">
            <input type="checkbox" id="notify-email-check" />
            <span>üìß Enviar aviso por correo al desbanear</span>
          </label>
        </div>
        <button type="button" id="notify-cancel-btn" class="btn secondary">Cerrar</button>
      </footer>
    </article>
  </dialog>

  <!-- Modal de Editor de Correo - Dar Aviso -->
  <dialog id="email-editor-modal" class="email-editor-modal">
    <article class="email-editor-content">
      <header class="email-editor-header">
        <h2>üìß Componer Aviso de Baneo</h2>
        <button type="button" class="email-editor-close">&times;</button>
      </header>
      <div class="email-editor-body">
        <!-- Destinatarios -->
        <div class="email-field">
          <label for="email-to">Para:</label>
          <input type="text" id="email-to" placeholder="correo1@ejemplo.com, correo2@ejemplo.com" />
          <small class="email-hint">Separar m√∫ltiples correos con coma o punto y coma ¬∑ Los destinatarios se guardan autom√°ticamente</small>
        </div>
        
        <!-- Asunto -->
        <div class="email-field">
          <label for="email-subject">Asunto:</label>
          <input type="text" id="email-subject" placeholder="Asunto del correo" />
        </div>
        
        <!-- Editor de Cuerpo (texto simple) -->
        <div class="email-field email-field-body">
          <div class="email-body-header">
            <label>Mensaje:</label>
            <button type="button" id="email-restore-template" class="btn-restore-template" title="Restaurar plantilla por defecto">
              üîÑ Restaurar Plantilla
            </button>
          </div>
          <textarea id="email-body" rows="10" placeholder="Escrib√≠ el mensaje aqu√≠..." class="email-text-editor"></textarea>
        </div>
        
        <!-- Adjuntos -->
        <div class="email-attachments">
          <h4>üìé Archivos adjuntos:</h4>
          <div class="email-attachments-list">
            <label class="email-attachment-item">
              <input type="checkbox" id="email-attach-xls" checked />
              <span class="attachment-icon">üìä</span>
              <span class="attachment-name">baneos_activos.xlsx</span>
              <span class="attachment-desc">Listado de c√°maras baneadas</span>
            </label>
            <label class="email-attachment-item">
              <input type="checkbox" id="email-attach-txt" checked />
              <span class="attachment-icon">üìÑ</span>
              <span class="attachment-name" id="email-txt-filename">tracking_original.txt</span>
              <span class="attachment-desc">Archivo de tracking original</span>
            </label>
          </div>
          <p class="email-attachment-warning" id="email-txt-warning" hidden>
            ‚ö†Ô∏è El archivo TXT original no est√° disponible para esta ruta.
          </p>
        </div>
        
        <!-- Resumen de baneos incluidos -->
        <div class="email-bans-summary">
          <h4>üîí Baneos incluidos:</h4>
          <div id="email-bans-list" class="email-bans-list">
            <p class="loading-text">Cargando baneos...</p>
          </div>
        </div>
      </div>
      <footer class="email-editor-footer">
        <div class="email-status" id="email-status"></div>
        <button type="button" id="email-cancel-btn" class="btn secondary">Cancelar</button>
        <button type="button" id="email-download-eml-btn" class="btn outline-primary" title="Genera un archivo .eml que pod√©s abrir con Outlook">
          <span class="btn-icon">üì•</span> Descargar EML
        </button>
        <button type="button" id="email-send-btn" class="btn primary" title="Enviar correo directamente">
          <span class="btn-icon">üì§</span> Enviar Correo
        </button>
      </footer>
    </article>
  </dialog>
</body>
</html>
