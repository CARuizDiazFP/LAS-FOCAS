<!--
# Nombre de archivo: index.html
# Ubicación de archivo: web/templates/index.html
# Descripción: Página principal de la UI (tema oscuro, barra de botones y chat REST)
-->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LAS-FOCAS — Panel</title>
  <link rel="stylesheet" href="/static/styles.css?v={{ build_version }}" />
  <!-- Los assets de Vite se copian a /static/assets en build -->
  <script defer src="/static/assets/main.js?v={{ build_version }}"></script>
  <script>
    window.API_BASE = "{{ api_base }}";
    window.CSRF_TOKEN = "{{ csrf }}";
    window.BUILD_VERSION = "{{ build_version }}";
  </script>
</head>
<body class="dark">
  <header class="topbar">
  <div class="brand">LAS-FOCAS <span class="version-badge">v{{ build_version }}</span></div>
    <nav class="actions">
      <button class="btn" id="open-rep-modal">Informe Repetitividad</button>
      <button class="btn" id="scroll-rep-card">Ver panel</button>
      <button class="btn">Modo oscuro</button>
      {% if username %}
      <span style="margin-left:12px;color:var(--muted)">Usuario: {{ username }}</span>
      <a class="btn" href="/admin">Admin</a>
      <a class="btn" href="/logout">Salir</a>
      {% endif %}
    </nav>
  </header>
  <main class="container">
    <section class="grid">
      <article class="card" id="card-rep">
        <header class="card-header">
          <h1>Informe de Repetitividad</h1>
          <span class="badge">FO Legacy+</span>
        </header>
        <p class="muted">Generá el reporte con columnas normalizadas, metadatos GEO y período decorativo sin filtros agresivos.</p>
        <ul class="pill-list">
          <li>CLIENTE</li>
          <li>SERVICIO / NÚMERO LÍNEA</li>
          <li>FECHA o FECHA CIERRE PROBLEMA</li>
        </ul>
        <p class="muted small">Las variantes más comunes (<strong>Nombre Cliente</strong>, <strong>Fecha Cierre Problema Reclamo</strong>, etc.) se mapean automáticamente.</p>
        <div class="card-actions">
          <button type="button" class="btn primary" id="launch-rep-modal">Generar informe</button>
          <a class="btn subtle" href="/reports" target="_blank" rel="noopener">Abrir carpeta</a>
        </div>
        <div id="rep-summary" class="result-box muted">Aún no se generó ningún informe.</div>
        <div id="rep-map-container" class="map-container" hidden>
          <iframe id="rep-map-preview" title="Mapa de repetitividad"></iframe>
        </div>
      </article>

      <article class="card" id="card-flows">
        <h2>Flujos adicionales</h2>
        <p class="muted">Ejecutá SLA o Comparador FO reutilizando el mismo archivo de casos.</p>
        <form id="flow-form" class="stack" enctype="multipart/form-data" onsubmit="return false;">
          <label class="form-label" for="file">Archivo fuente (.xlsx)</label>
          <input type="file" id="file" name="file" accept=".xlsx" required />
          <div class="form-grid">
            <div class="field">
              <label class="form-label" for="mes">Mes</label>
              <input type="number" id="mes" name="mes" min="1" max="12" required />
            </div>
            <div class="field">
              <label class="form-label" for="anio">Año</label>
              <input type="number" id="anio" name="anio" min="2000" max="2100" required />
            </div>
          </div>
          <label class="checkbox">
            <input type="checkbox" id="incluir_pdf" name="include_pdf" checked /> Generar PDF cuando aplique
          </label>
          <div class="card-actions">
            <button type="button" class="btn" id="run-sla-btn">Ejecutar SLA</button>
            <button type="button" class="btn" id="run-fo-btn">Comparador FO</button>
          </div>
        </form>
        <div id="flow-result" class="result-box muted">Subí un archivo y elegí el flujo para ejecutarlo.</div>
      </article>

      <article class="card" id="card-chat">
        <h2>Asistente conversacional</h2>
        <p class="muted">Consultá métricas, pedí reportes o dejá feedback para el equipo.</p>
        <div class="chat">
          <div id="chat-status" class="chat-status muted"></div>
          <div id="chat-log" class="chat-log"></div>
          <div id="chat-attachments" class="chat-attachments"></div>
          <div id="chat-dropzone" class="chat-dropzone">
            Arrastrá archivos o <button type="button" id="chat-attachment-browse" class="link-button">buscá en tu equipo</button>
            <small class="muted">Límite 15 MB por archivo</small>
          </div>
          <form id="chat-form" class="chat-form">
            <input id="chat-input" name="text" type="text" placeholder="Escribí un mensaje" required />
            <button type="submit" class="btn primary">Enviar</button>
          </form>
        </div>
        <input id="chat-attachment-input" type="file" multiple hidden />
      </article>
    </section>
  </main>

  <script>
    // --- POPUP MODAL REPE - UI -------------------------------------------------
    const modalHtml = `
      <div id="rep-modal" class="modal-overlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1200;">
        <div class="modal" style="background:#1e1f23;padding:20px;border-radius:8px;max-width:460px;width:100%;box-shadow:0 4px 18px rgba(0,0,0,.5);">
          <h2 style="margin-top:0">Informe de Repetitividad</h2>
          <form id="rep-form" enctype="multipart/form-data" onsubmit="return false;" style="display:flex;flex-direction:column;gap:8px;">
            <input type="file" name="file" id="rep-file" accept=".xlsx" required />
            <div style="display:flex;gap:8px;">
              <input type="number" name="mes" id="rep-mes" placeholder="Mes" min="1" max="12" required style="flex:1;" />
              <input type="number" name="anio" id="rep-anio" placeholder="Año" min="2000" max="2100" required style="flex:1;" />
            </div>
            <label style="display:flex;align-items:center;gap:6px;font-size:0.85rem;">
              <input type="checkbox" id="rep-pdf" name="include_pdf" checked /> Generar PDF (si disponible)
            </label>
            <div id="rep-hint" class="muted" style="font-size:0.7rem;line-height:1.2;">Columnas requeridas: CLIENTE, SERVICIO, FECHA. Se aceptan variaciones como FECHA_APERTURA o SERVICE (se normalizan).</div>
            <div id="rep-error" style="display:none;color:#ff6b6b;font-size:0.8rem;"></div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
              <button type="button" id="rep-cancel" class="btn" style="background:#444;">Cancelar</button>
              <button type="submit" id="rep-submit" class="btn primary">Generar</button>
            </div>
          </form>
          <div id="rep-links" style="margin-top:10px;font-size:0.85rem;"></div>
        </div>
      </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const repModal = document.getElementById('rep-modal');
    const repForm = document.getElementById('rep-form');
    const repCancel = document.getElementById('rep-cancel');
    const repLinks = document.getElementById('rep-links');
    const repError = document.getElementById('rep-error');
  const repSummary = document.getElementById('rep-summary');
  const repMapContainer = document.getElementById('rep-map-container');
  const repMapFrame = document.getElementById('rep-map-preview');
    function openRepModal(){
      repError.style.display='none';
      repLinks.textContent='';
      repForm.reset();
      document.getElementById('rep-pdf').checked = true;
      repModal.style.display='flex';
    }
    function closeRepModal(){ repModal.style.display='none'; }
    repCancel.addEventListener('click', closeRepModal);
    const repOpenButtons = [
      document.getElementById('open-rep-modal'),
      document.getElementById('launch-rep-modal')
    ].filter(Boolean);
    repOpenButtons.forEach(btn => btn.addEventListener('click', openRepModal));
    const scrollRep = document.getElementById('scroll-rep-card');
    if (scrollRep) {
      scrollRep.addEventListener('click', () => document.getElementById('card-rep')?.scrollIntoView({ behavior: 'smooth', block: 'start' }));
    }
    repForm.addEventListener('submit', async ()=>{
      repError.style.display='none';
      repLinks.textContent='Procesando...';
      if (repSummary) {
        repSummary.classList.remove('success', 'error');
        repSummary.classList.add('info');
        repSummary.classList.add('muted');
        repSummary.innerHTML = 'Procesando informe...';
      }
      if (repMapContainer) {
        repMapContainer.setAttribute('hidden', '');
      }
      const fileEl = document.getElementById('rep-file');
      if(!fileEl.files.length){ repLinks.textContent='Seleccioná un archivo'; return; }
      const mes = document.getElementById('rep-mes').value;
      const anio = document.getElementById('rep-anio').value;
      const pdf = document.getElementById('rep-pdf').checked;
      const data = new FormData();
      data.append('file', fileEl.files[0]);
      data.append('mes', mes);
      data.append('anio', anio);
      if(pdf) data.append('include_pdf','true');
      if(window.CSRF_TOKEN) data.append('csrf_token', window.CSRF_TOKEN);
      try {
        const res = await fetch('/api/flows/repetitividad', { method:'POST', body:data, credentials:'include'});
        const j = await res.json();
        if(!res.ok){
          repError.textContent = j.error || 'Error desconocido';
          repError.style.display='block';
          repLinks.textContent='';
          console.error('Repetitividad error', j);
          if (repSummary) {
            repSummary.classList.remove('info', 'success', 'muted');
            repSummary.classList.add('error');
            repSummary.textContent = j.error || 'Error desconocido';
          }
          return;
        }
        let links = [];
        if (j.docx) links.push(`<a href="${j.docx}" target="_blank">DOCX</a>`);
        if (j.pdf) links.push(`<a href="${j.pdf}" target="_blank">PDF</a>`);
        if (j.map) links.push(`<a href="${j.map}" target="_blank">Mapa</a>`);
        if (!j.pdf && j.pdf_requested) {
          links.push('<span class="warn">PDF no generado</span>');
        }
        const joined = links.join(' · ') || 'sin archivos';
        repLinks.innerHTML = 'Listo: ' + joined;
        if (repSummary) {
          const periodo = `${anio}-${String(mes).padStart(2, '0')}`;
          repSummary.classList.remove('muted', 'info', 'error');
          repSummary.classList.add('success');
          repSummary.innerHTML = `<strong>Período ${periodo}</strong><br>${joined}`;
        }
        if (repMapFrame && repMapContainer) {
          if (j.map) {
            repMapFrame.src = j.map;
            repMapContainer.removeAttribute('hidden');
          } else {
            repMapFrame.removeAttribute('src');
            repMapContainer.setAttribute('hidden', '');
          }
        }
      } catch(err){
        repError.textContent = 'Fallo de red o parseo';
        repError.style.display='block';
        repLinks.textContent='';
        console.error(err);
        if (repSummary) {
          repSummary.classList.remove('success', 'info', 'muted');
          repSummary.classList.add('error');
          repSummary.textContent = 'Fallo de red o parseo';
        }
      }
    });

    async function runFlow(path) {
      const f = document.getElementById('flow-form');
      const file = document.getElementById('file');
      const mes = document.getElementById('mes');
      const anio = document.getElementById('anio');
      const pdf = document.getElementById('incluir_pdf');
      const out = document.getElementById('flow-result');
      if (!file.files.length) {
        if (out) {
          out.classList.remove('success', 'info');
          out.classList.add('error');
          out.textContent = 'Seleccioná un archivo.';
        }
        return;
      }
      const data = new FormData();
      data.append('file', file.files[0]);
      data.append('mes', mes.value);
      data.append('anio', anio.value);
      if (pdf && pdf.checked) { data.append('include_pdf', 'true'); }
      if (window.CSRF_TOKEN) data.append('csrf_token', window.CSRF_TOKEN);
      if (out) {
        out.classList.remove('success', 'error');
        out.classList.add('info');
        out.textContent = 'Procesando...';
      }
      try {
        const res = await fetch(path, { method: 'POST', body: data, credentials: 'include' });
        const j = await res.json();
        if (!res.ok) throw new Error(j.error || 'Error');
        let links = [];
        if (j.docx) links.push(`<a href="${j.docx}" target="_blank">DOCX</a>`);
        if (j.pdf) links.push(`<a href="${j.pdf}" target="_blank">PDF</a>`);
        if (j.map) links.push(`<a href="${j.map}" target="_blank">Mapa</a>`);
        if (!j.pdf && j.pdf_requested) {
          links.push('<span class="warn">PDF no generado</span>');
        }
        if (out) {
          out.classList.remove('info', 'error');
          out.classList.add('success');
          out.innerHTML = 'Listo: ' + (links.join(' · ') || 'sin archivos');
        }
      } catch (err) {
        if (out) {
          out.classList.remove('info', 'success');
          out.classList.add('error');
          out.textContent = 'Error: ' + err.message;
        }
        console.error(err);
      }
    }

  const slaBtn = document.getElementById('run-sla-btn');
  if (slaBtn) {
    slaBtn.addEventListener('click', () => runFlow('/api/flows/sla'));
  }
  const foBtn = document.getElementById('run-fo-btn');
  if (foBtn) {
    foBtn.addEventListener('click', () => runFlow('/api/flows/comparador-fo'));
  }
  </script>
</body>
</html>
