<!--
# Nombre de archivo: index.html
# Ubicación de archivo: web/templates/index.html
# Descripción: Página principal de la UI (tema oscuro, barra de botones y chat REST)
-->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LAS-FOCAS — Panel</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <!-- Los assets de Vite se copian a /static/assets en build -->
  <script defer src="/static/assets/main.js"></script>
  <script>
    window.API_BASE = "{{ api_base }}";
    window.CSRF_TOKEN = "{{ csrf }}";
  </script>
</head>
<body class="dark">
  <header class="topbar">
    <div class="brand">LAS-FOCAS</div>
    <nav class="actions">
      <button class="btn" id="btn-sla">SLA</button>
  <button class="btn" id="btn-rep">Repetitividad</button>
      <button class="btn" id="btn-fo">Comparador FO</button>
      <button class="btn">Modo oscuro</button>
      {% if username %}
      <span style="margin-left:12px;color:var(--muted)">Usuario: {{ username }}</span>
      <a class="btn" href="/admin">Admin</a>
      <a class="btn" href="/logout">Salir</a>
      {% endif %}
    </nav>
  </header>
  <main class="container">
  <section class="panel">
      <h1>Panel</h1>
      <p>Subí un archivo y ejecutá los flujos con los botones superiores. Los resultados aparecerán abajo.</p>
      <div id="flow-result" class="muted" style="margin-top:8px"></div>
      <div class="chat">
        <div id="chat-log" class="chat-log"></div>
        <form id="chat-form" class="chat-form">
          <input id="chat-input" name="text" type="text" placeholder="Escribí un mensaje" required />
          <button type="submit" class="btn primary">Enviar</button>
        </form>
      </div>
    </section>
  </main>

  <script>
    // --- POPUP MODAL REPE - UI -------------------------------------------------
    const modalHtml = `
      <div id="rep-modal" class="modal-overlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1200;">
        <div class="modal" style="background:#1e1f23;padding:20px;border-radius:8px;max-width:460px;width:100%;box-shadow:0 4px 18px rgba(0,0,0,.5);">
          <h2 style="margin-top:0">Informe de Repetitividad</h2>
          <form id="rep-form" enctype="multipart/form-data" onsubmit="return false;" style="display:flex;flex-direction:column;gap:8px;">
            <input type="file" name="file" id="rep-file" accept=".xlsx" required />
            <div style="display:flex;gap:8px;">
              <input type="number" name="mes" id="rep-mes" placeholder="Mes" min="1" max="12" required style="flex:1;" />
              <input type="number" name="anio" id="rep-anio" placeholder="Año" min="2000" max="2100" required style="flex:1;" />
            </div>
            <label style="display:flex;align-items:center;gap:6px;font-size:0.85rem;">
              <input type="checkbox" id="rep-pdf" name="include_pdf" checked /> Generar PDF (si disponible)
            </label>
            <div id="rep-hint" class="muted" style="font-size:0.7rem;line-height:1.2;">Columnas requeridas: CLIENTE, SERVICIO, FECHA. Se aceptan variaciones como FECHA_APERTURA o SERVICE (se normalizan).</div>
            <div id="rep-error" style="display:none;color:#ff6b6b;font-size:0.8rem;"></div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
              <button type="button" id="rep-cancel" class="btn" style="background:#444;">Cancelar</button>
              <button type="submit" id="rep-submit" class="btn primary">Generar</button>
            </div>
          </form>
          <div id="rep-links" style="margin-top:10px;font-size:0.85rem;"></div>
        </div>
      </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const repModal = document.getElementById('rep-modal');
    const repForm = document.getElementById('rep-form');
    const repCancel = document.getElementById('rep-cancel');
    const repLinks = document.getElementById('rep-links');
    const repError = document.getElementById('rep-error');
    function openRepModal(){
      repError.style.display='none';
      repLinks.textContent='';
      repForm.reset();
      document.getElementById('rep-pdf').checked = true;
      repModal.style.display='flex';
    }
    function closeRepModal(){ repModal.style.display='none'; }
    repCancel.addEventListener('click', closeRepModal);
    document.getElementById('btn-rep').addEventListener('click', openRepModal);
    repForm.addEventListener('submit', async ()=>{
      repError.style.display='none';
      repLinks.textContent='Procesando...';
      const fileEl = document.getElementById('rep-file');
      if(!fileEl.files.length){ repLinks.textContent='Seleccioná un archivo'; return; }
      const mes = document.getElementById('rep-mes').value;
      const anio = document.getElementById('rep-anio').value;
      const pdf = document.getElementById('rep-pdf').checked;
      const data = new FormData();
      data.append('file', fileEl.files[0]);
      data.append('mes', mes);
      data.append('anio', anio);
      if(pdf) data.append('include_pdf','true');
      if(window.CSRF_TOKEN) data.append('csrf_token', window.CSRF_TOKEN);
      try {
        const res = await fetch('/api/flows/repetitividad', { method:'POST', body:data, credentials:'include'});
        const j = await res.json();
        if(!res.ok){
          repError.textContent = j.error || 'Error desconocido';
          repError.style.display='block';
          repLinks.textContent='';
          console.error('Repetitividad error', j);
          return;
        }
        let links = [];
        if (j.docx) links.push(`<a href="${j.docx}" target="_blank">DOCX</a>`);
        if (j.pdf) links.push(`<a href="${j.pdf}" target="_blank">PDF</a>`);
        if (!j.pdf && j.pdf_requested) {
          links.push('<span class="warn">PDF no generado</span>');
        }
        repLinks.innerHTML = 'Listo: ' + (links.join(' · ') || 'sin archivos');
      } catch(err){
        repError.textContent = 'Fallo de red o parseo';
        repError.style.display='block';
        repLinks.textContent='';
        console.error(err);
      }
    });

    // --- CHAT EXISTENTE --------------------------------------------------------
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');
    const log = document.getElementById('chat-log');

    function append(role, text) {
      const el = document.createElement('div');
      el.className = 'msg ' + role;
      el.textContent = text;
      log.appendChild(el);
      log.scrollTop = log.scrollHeight;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      append('user', text);
      input.value = '';
      const formData = new FormData();
      formData.append('text', text);
      try {
        const res = await fetch('/api/chat/message', { method: 'POST', body: formData });
        if (!res.ok) throw new Error('Error HTTP ' + res.status);
        const data = await res.json();
        append('assistant', `${data.reply} (Intent: ${data.intent} • ${Math.round((data.confidence||0)*100)}%)`);
      } catch (err) {
        append('assistant', 'Ocurrió un error al enviar el mensaje.');
        console.error(err);
      }
    });

    async function runFlow(path) {
      const f = document.getElementById('flow-form');
      const file = document.getElementById('file');
      const mes = document.getElementById('mes');
      const anio = document.getElementById('anio');
      const pdf = document.getElementById('incluir_pdf');
      const out = document.getElementById('flow-result');
      if (!file.files.length) { out.textContent = 'Seleccioná un archivo.'; return; }
      const data = new FormData();
      data.append('file', file.files[0]);
      data.append('mes', mes.value);
      data.append('anio', anio.value);
      if (pdf && pdf.checked) { data.append('include_pdf', 'true'); }
      if (window.CSRF_TOKEN) data.append('csrf_token', window.CSRF_TOKEN);
      out.textContent = 'Procesando...';
      try {
        const res = await fetch(path, { method: 'POST', body: data, credentials: 'include' });
        const j = await res.json();
        if (!res.ok) throw new Error(j.error || 'Error');
        let links = [];
        if (j.docx) links.push(`<a href="${j.docx}" target="_blank">DOCX</a>`);
        if (j.pdf) links.push(`<a href="${j.pdf}" target="_blank">PDF</a>`);
        if (!j.pdf && j.pdf_requested) {
          links.push('<span class="warn">PDF no generado</span>');
        }
        out.innerHTML = 'Listo: ' + (links.join(' · ') || 'sin archivos');
      } catch (err) {
        out.textContent = 'Error: ' + err.message;
        console.error(err);
      }
    }

  document.getElementById('btn-sla').addEventListener('click', () => runFlow('/api/flows/sla'));
  document.getElementById('btn-fo').addEventListener('click', () => runFlow('/api/flows/comparador-fo'));
  </script>
</body>
</html>
